<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opening Balance Ticking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS library for parsing and WRITING Excel/CSV files -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- V46: PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* D4: Superior Code Quality & Optimization - Using CSS variables for maintainability */
        :root {
            --primary-blue: #2563EB;
            --primary-blue-dark: #1D4ED8;
            --light-gray-bg: #F9FAFB;
            --medium-gray-bg: #F3F4F6;
            --border-color: #D1D5DB;
            --card-bg: #FFFFFF;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --text-on-primary: #FFFFFF;
            --processing-bg: #EFF6FF;
            --processing-text: #1E40AF;
            --success-green: #10B981;
            --success-green-bg: #F0FDF4;
            --warning-yellow: #F59E0B;
            --warning-yellow-bg: #FEFCE8;
            --info-blue-bg: #EFF6FF;
            --info-blue-text: #1E40AF;
            --danger-red: #EF4444;
            --danger-red-bg: #FEF2F2;
            --close-match-purple-bg: #F5F3FF;
            --table-divider-color: #B0B5BB;
            --table-header-bg: #F3F4F6;
            --table-header-text: #000000;
        }

        /* Dark Mode Palette */
        body.dark-mode {
            --light-gray-bg: #111827;
            --medium-gray-bg: #030712;
            --border-color: #374151;
            --card-bg: #1F2937;
            --text-dark: #F9FAFB;
            --text-light: #9CA3AF;
            --processing-bg: #1E3A8A;
            --processing-text: #BFDBFE;
            --success-green-bg: #064E3B;
            --warning-yellow-bg: #78350F;
            --info-blue-bg: #1E3A8A;
            --info-blue-text: #BFDBFE;
            --danger-red-bg: #991B1B;
            --close-match-purple-bg: #3730A3;
            --table-divider-color: #4B5563;
            --table-header-bg: #1F2937;
            --table-header-text: #FFFFFF;
        }

        /* D3: Multi-Device & Platform Optimization - Base styles and responsive typography */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-gray-bg);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.is-dragging {
            user-select: none;
            -webkit-user-select: none;
        }
        
        body.sidebar-open, body.modal-open {
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }
        
        /* Engagement Creation Page Styles */
        #engagement-creation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            padding: 2rem 1rem;
            box-sizing: border-box;
            background-color: var(--medium-gray-bg);
        }

        /* Enhanced Processing Bar */
        .processing-bar {
            width: 100%;
            background-color: var(--processing-bg);
            color: var(--processing-text);
            padding: 0.75rem;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            font-weight: 500;
        }
        #processing-bar-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        #cancel-processing-btn {
            background-color: transparent;
            border: 1px solid var(--processing-text);
            color: var(--processing-text);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .app-header-container {
            width: 100%;
            max-width: 800px;
            margin-bottom: 2.5rem;
            text-align: center;
        }

        #initial-header h1 { font-size: 2.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        #initial-header p { font-size: 1.125rem; color: var(--text-light); margin-top: 0; }
        #app-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; font-weight: 600; }
        .logo-container { display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem; }
        .logo-container svg { width: 2.5rem; height: 2.5rem; color: var(--primary-blue); }
        #app-header .compliance-tag { color: var(--text-light); font-weight: 500; }

        /* Main Content & Cards */
        .main-container { width: 100%; max-width: 550px; }
        .card { background-color: var(--card-bg); border-radius: 0.75rem; padding: 2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); margin-bottom: 2rem; transition: background-color 0.3s; }
        #engagement-card h2, #recent-engagements-card h2, #import-card h2 { font-size: 1.5rem; font-weight: 600; margin-top: 0; margin-bottom: 1.5rem; text-align: left; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 1rem; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s; background-color: var(--card-bg); color: var(--text-dark); }
        .form-group textarea { font-family: 'Inter', sans-serif; min-height: 80px; resize: vertical; }
        .form-group input::placeholder { color: var(--text-light); opacity: 0.7; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: auto; }
        input[type="date"] { -webkit-appearance: none; }
        .btn-primary { width: 100%; background-color: var(--primary-blue); color: var(--text-on-primary); font-size: 1rem; font-weight: 600; padding: 0.875rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1.5rem; }
        .btn-primary:hover { background-color: var(--primary-blue-dark); }
        .btn-primary:disabled { background-color: #93C5FD; cursor: not-allowed; }
        #features-card h3 { font-weight: 600; margin-top: 0; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .features-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        .feature-item { display: flex; align-items: flex-start; gap: 0.75rem; }
        .feature-item svg { width: 1.5rem; height: 1.5rem; flex-shrink: 0; margin-top: 0.125rem; }
        .feature-item .icon-compliant { color: var(--success-green); }
        .feature-item .icon-feature { color: var(--primary-blue); }
        .feature-item-text h4 { font-size: 1rem; font-weight: 600; margin: 0 0 0.25rem 0; }
        .feature-item-text p { font-size: 0.875rem; color: var(--text-light); margin: 0; line-height: 1.4; }
        #recent-engagements-list { list-style: none; padding: 0; margin: 0; }
        #recent-engagements-list li { margin-bottom: 0.75rem; }
        #recent-engagements-list li:last-child { margin-bottom: 0; }
        .engagement-link-wrapper { display: flex; align-items: center; gap: 0.5rem; background-color: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; transition: background-color 0.2s, border-color 0.2s; }
        .engagement-link-wrapper:hover { background-color: #e5e7eb; border-color: #9CA3AF; }
        body.dark-mode .engagement-link-wrapper:hover { background-color: #374151; border-color: #6B7280; }
        .engagement-link { display: block; flex-grow: 1; padding: 1rem; text-decoration: none; color: var(--text-dark); font-weight: 500; }
        .delete-engagement-btn { padding: 1rem; color: var(--text-light); cursor: pointer; background: none; border: none; }
        .delete-engagement-btn:hover { color: var(--danger-red); }
        .year-type-group { margin-top: -0.5rem; margin-bottom: 1.25rem; display: flex; gap: 1rem; }
        
        @media (max-width: 640px) {
            #engagement-creation-container { padding: 1.5rem 1rem; }
            #initial-header h1 { font-size: 1.75rem; }
            #initial-header p { font-size: 1rem; }
            .logo-container { font-size: 1rem; }
            .logo-container svg { width: 2rem; height: 2rem; }
            .features-grid { grid-template-columns: 1fr; gap: 1.25rem; }
        }

        /* V21: Main Application Layout & Scroll Fix */
        #main-app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background-color: var(--medium-gray-bg);
        }

        .app-main-header { display: flex; justify-content: space-between; align-items: center; background-color: var(--card-bg); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .header-left, .header-right { display: flex; align-items: center; gap: 1rem; }
        .header-right { justify-content: flex-end; }
        .app-logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.125rem; font-weight: 600; color: var(--text-dark); text-decoration: none; }
        .app-logo svg { width: 2rem; height: 2rem; color: var(--primary-blue); }
        /* V58: Privacy Shield Button Style */
        #privacy-shield-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: var(--text-light); }
        #privacy-shield-btn:hover { background-color: var(--medium-gray-bg); color: var(--text-dark); }
        body.dark-mode #privacy-shield-btn:hover { background-color: #374151; }
        #privacy-shield-btn svg { width: 1.25rem; height: 1.25rem; }

        .app-context { display: flex; align-items: center; gap: 1rem; text-align: right; font-size: 0.875rem; color: var(--text-light); flex-shrink: 1; min-width: 0; }
        #engagement-title-context { font-weight: 600; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .app-nav { display: flex; align-items: center; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 0.5rem 2rem; flex-shrink: 0; }
        .nav-tabs { display: flex; gap: 1rem; }
        .nav-tab { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-weight: 500; color: var(--text-light); background-color: transparent; border: none; border-radius: 0.5rem; cursor: pointer; transition: color 0.2s, background-color 0.2s; }
        .nav-tab:hover:not(.active) { background-color: var(--medium-gray-bg); color: var(--text-dark); }
        .nav-tab.active { font-weight: 600; color: var(--primary-blue); background-color: var(--info-blue-bg); }
        .nav-tab[disabled] { cursor: not-allowed; opacity: 0.5; }
        body.dark-mode .nav-tab:hover:not(.active) { background-color: #374151; }
        body.dark-mode .nav-tab.active { background-color: #1E40AF; color: #E0E7FF; }
        .nav-tab svg { width: 20px; height: 20px; }
        .nav-tab .icon-solid { display: none; }
        .nav-tab.active .icon-solid { display: block; }
        .nav-tab.active .icon-solid { display: block; }
        .nav-tab.active .icon-outline { display: none; }

        /* V58: Save Status Indicator Styles */
        #save-status-container {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-light);
        }
        #save-status-indicator {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            font-weight: 500;
        }
        #save-status-indicator.visible {
            opacity: 1;
        }
        #save-status-indicator.success {
            color: var(--success-green);
        }
        #last-saved-timestamp {
            font-weight: 500;
        }

        .workspace-content { padding: 2rem; overflow-y: auto; flex-grow: 1; }
        .engagement-context-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .context-header-actions { display: flex; align-items: center; gap: 0.75rem; }
        #engagement-workspace-title-wrapper { display: flex; align-items: center; gap: 0.75rem; }
        #engagement-workspace-title { font-size: 1.75rem; font-weight: 700; margin: 0; }
        .btn { background-color: var(--primary-blue); color: var(--text-on-primary); font-size: 0.875rem; font-weight: 600; padding: 0.625rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn:hover { background-color: var(--primary-blue-dark); }
        .btn.btn-secondary { background-color: var(--success-green); }
        .btn.btn-minimal { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-light); }
        .btn.btn-minimal:hover { background-color: var(--medium-gray-bg); border-color: var(--text-light); color: var(--text-dark); }
        body.dark-mode .btn.btn-minimal:hover { background-color: #374151; }
        .btn:disabled { background-color: #A5B4FC; cursor: not-allowed; }
        #review-actions-container { display: flex; align-items: center; gap: 0.75rem; }
        
        /* V46: Report Generation Dropdown Button */
        .report-generator-group {
            position: relative;
            display: inline-flex;
        }
        #generate-pdf-btn {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: 1px solid var(--primary-blue-dark);
        }
        #report-options-btn {
            background-color: var(--primary-blue);
            color: var(--text-on-primary);
            border: none;
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            padding: 0.625rem 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #report-options-btn:hover {
            background-color: var(--primary-blue-dark);
        }
        .report-generator-group.open #report-options-dropdown {
            display: block;
        }
        #report-options-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            z-index: 50;
            width: 200px;
            overflow: hidden;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: var(--text-dark);
            cursor: pointer;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
        }
        .dropdown-item:hover {
            background-color: var(--medium-gray-bg);
        }
        body.dark-mode .dropdown-item:hover {
            background-color: #374151;
        }
        .dropdown-item svg {
            width: 16px;
            height: 16px;
            color: var(--text-light);
        }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .stat-card { background-color: var(--card-bg); border-radius: 0.75rem; padding: 1.5rem; display: flex; align-items: center; gap: 1rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .stat-card.stat-clickable { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card.stat-clickable:hover { transform: translateY(-3px); box-shadow: 0 4px 10px 0 rgb(0 0 0 / 0.1); }
        
        .stat-card .icon-wrapper { padding: 0.75rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .stat-card .icon-wrapper.green { background-color: var(--success-green-bg); color: var(--success-green); }
        .stat-card .icon-wrapper.blue { background-color: var(--info-blue-bg); color: var(--primary-blue); }
        .stat-card .icon-wrapper.yellow { background-color: var(--warning-yellow-bg); color: var(--warning-yellow); }
        .stat-card .icon-wrapper.purple { background-color: #F3E8FF; color: #8B5CF6; }
        .stat-card .stat-info h4 { font-size: 0.875rem; color: var(--text-light); font-weight: 500; margin: 0 0 0.25rem; }
        .stat-card .stat-info p { font-size: 1.875rem; font-weight: 700; margin: 0; }
        .progress-card { margin-top: 1.5rem; background-color: var(--card-bg); border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .progress-card h3 { margin-top: 0; font-size: 1.25rem; }
        .progress-item { display: flex; align-items: center; gap: 1rem; padding: 0.5rem 0; }
        .progress-item:not(:last-child) { border-bottom: 1px solid var(--border-color); }
        .progress-item label { width: 120px; font-size: 0.875rem; color: var(--text-light); }
        .progress-bar-container { flex-grow: 1; background-color: var(--medium-gray-bg); border-radius: 99px; height: 8px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background-color: var(--primary-blue); border-radius: 99px; transition: width 0.3s ease-in-out; }
        .progress-item span { font-size: 0.875rem; font-weight: 500; min-width: 80px; text-align: right; }
        .empty-state-card { background-color: var(--card-bg); border-radius: 0.75rem; padding: 4rem 2rem; text-align: center; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); color: var(--text-light); }
        .empty-state-card svg { margin-bottom: 1rem; }
        .empty-state-card h3 { margin: 0; font-size: 1.125rem; color: var(--text-dark); }
        .empty-state-card p { margin: 0.5rem 0 1.5rem; }
        .uploaded-files-list { list-style: none; padding: 0; margin: 0; }
        .uploaded-file-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background-color: var(--light-gray-bg); border-radius: 0.5rem; margin-bottom: 0.75rem; }
        .uploaded-file-item:last-child { margin-bottom: 0; }
        .file-info { display: flex; align-items: center; gap: 0.75rem; font-weight: 500; }
        .file-info svg { color: var(--primary-blue); width: 1.5rem; height: 1.5rem; }
        .file-status { font-size: 0.875rem; color: var(--success-green); font-weight: 600; }
        .alert-banner { padding: 1rem; border-radius: 0.5rem; display: flex; align-items: flex-start; gap: 0.75rem; font-size: 0.875rem; margin-bottom: 1.5rem; }
        .alert-banner.info { background-color: var(--info-blue-bg); color: var(--info-blue-text); }
        .alert-banner.success { background-color: var(--success-green-bg); color: #065F46; }
        .alert-banner.warning { background-color: var(--warning-yellow-bg); color: #B45309; }
        body.dark-mode .alert-banner.success { color: #A7F3D0; }
        body.dark-mode .alert-banner.warning { color: #FDE68A; }
        body.dark-mode .info-list ul { color: var(--info-blue-text); }
        .radio-group { display: flex; gap: 1.5rem; margin-bottom: 1.5rem; }
        .radio-group label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .upload-dropzone { border: 2px dashed var(--border-color); border-radius: 0.75rem; padding: 3rem; text-align: center; background-color: var(--card-bg); transition: border-color 0.2s, background-color 0.2s; cursor: pointer;}
        .upload-dropzone.dragover { background-color: var(--info-blue-bg); border-color: var(--primary-blue); }
        .upload-dropzone svg { color: var(--text-light); margin-bottom: 1rem; }
        .upload-dropzone h3 { margin: 0; color: var(--text-dark); }
        .upload-dropzone p { color: var(--text-light); margin: 0.25rem 0 1rem; }
        .info-list ul { padding-left: 1.5rem; margin: 0; line-height: 1.6; color: var(--info-blue-text); }
        .info-list ul li::marker { color: var(--primary-blue); }

        /* Review Tab Toolbar */
        .review-toolbar {
            margin-bottom: 1.5rem;
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .review-toolbar-main {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .search-wrapper {
            flex-grow: 1;
            position: relative;
        }
        .search-wrapper svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
        }
        #review-search-input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text-dark);
        }
        #review-search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        #map-unmatched-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-dark);
            font-weight: 500;
        }
        #map-unmatched-btn:hover {
            background-color: var(--medium-gray-bg);
            border-color: var(--text-light);
        }
        body.dark-mode #map-unmatched-btn {
             color: var(--text-dark);
        }
        body.dark-mode #map-unmatched-btn:hover {
            background-color: #374151;
        }
        #map-unmatched-btn svg { color: var(--primary-blue); }

        #bulk-actions-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }
        #bulk-actions-container select, #bulk-actions-container .btn {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
        #bulk-actions-container select {
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--card-bg);
            color: var(--text-dark);
        }
        /* V55: Bulk Action Scope UI Styles */
        #bulk-scope-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-light);
            border-left: 2px solid var(--border-color);
            padding-left: 1rem;
            flex-grow: 1;
        }
        .bulk-scope-label {
            font-weight: 500;
        }
        .scope-selector {
            position: relative;
        }
        #scope-select-btn {
            font-weight: 600;
            color: var(--primary-blue);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0.25rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        #scope-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            z-index: 50;
            width: 150px;
            overflow: hidden;
            padding: 0.25rem;
        }
        .scope-selector.open #scope-options {
            display: block;
        }
        .scope-option {
            padding: 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        .scope-option:hover {
            background-color: var(--medium-gray-bg);
        }
        body.dark-mode .scope-option:hover {
            background-color: #374151;
        }
        .scope-option.active {
            font-weight: 600;
            background-color: var(--info-blue-bg);
        }
        #bulk-selection-status {
            font-weight: 500;
        }
        #clear-selection-btn {
            font-size: 0.875rem;
            color: var(--primary-blue);
            text-decoration: underline;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        .custom-range-inputs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .custom-range-inputs input {
            width: 50px;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            text-align: center;
            background-color: var(--card-bg);
            color: var(--text-dark);
        }
        .custom-range-inputs input:invalid {
            border-color: var(--danger-red);
        }

        /* V45: Pagination Controls Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
            color: var(--text-light);
        }
        .pagination-status {
            font-weight: 500;
        }
        .pagination-nav .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        .pagination-nav .btn:disabled {
            background-color: var(--medium-gray-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            cursor: not-allowed;
        }
        body.dark-mode .pagination-nav .btn:disabled {
            background-color: #374151;
        }


        /* Review Table Styles */
        .table-wrapper {
            background-color: var(--card-bg);
            border: 3px solid var(--table-divider-color);
            border-radius: 0.75rem;
            overflow-x: auto;
            margin-bottom: -20px;
            padding-bottom: 20px;
        }
        .review-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 1600px;
        }
        
        /* Headers */
        .review-table thead {
            background-color: var(--card-bg);
        }
        .review-table thead th {
            font-weight: 600;
            color: var(--text-dark);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 0.75rem 1rem;
            border-bottom: none;
        }
        .review-table thead tr:first-child th {
            font-size: 0.9rem;
            text-align: center;
            background-color: var(--card-bg);
            border-bottom: 3px solid var(--table-divider-color);
            font-weight: 700;
        }
        .review-table thead tr:last-child th {
             background-color: var(--table-header-bg);
             color: var(--table-header-text);
             font-weight: 700;
             text-align: center;
             border-bottom: 3px solid var(--table-divider-color);
        }
        
        .review-table th, .review-table td {
             border-right: none;
             border-left: 1px solid var(--border-color);
        }
        .review-table th:first-child, .review-table td:first-child {
            border-left: none;
        }
        .review-table .cell-category-divider {
            border-left-width: 3px;
            border-left-color: var(--table-divider-color);
        }
        .review-table .cell-thick-internal-divider {
            border-left-width: 3px;
            border-left-color: var(--table-divider-color);
        }
        
        .review-table td {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-bg);
            transition: background-color 0.2s;
            vertical-align: middle; 
            text-align: center;
        }
        .review-table td.text-left-aligned {
            text-align: left;
        }
        .review-table td.text-right-aligned {
            text-align: right;
            white-space: nowrap;
        }
        /* V44: Inference Indicator styling */
        .inference-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: var(--info-blue-bg);
            color: var(--info-blue-text);
            font-size: 10px;
            font-weight: 700;
            margin-left: 0.5rem;
            cursor: help;
            font-style: italic;
        }
        body.dark-mode .inference-indicator {
             background-color: var(--primary-blue);
             color: var(--text-on-primary);
        }

        .review-table tr:hover td {
            background-color: var(--light-gray-bg);
        }
        
        .review-table tr.material-variance td {
            background-color: var(--danger-red-bg);
        }

        body.dark-mode .review-table tr:hover td {
             background-color: #111827;
        }
        body.dark-mode .review-table tr.material-variance td {
            background-color: var(--danger-red-bg);
        }
        .status-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 99px;
            font-weight: 600;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        .status-exact-match .status-badge { background-color: #BBF7D0; color: #15803D; }
        .status-variance .status-badge { background-color: #FEF08A; color: #854D0E; }
        .status-new-account .status-badge { background-color: #DBEAFE; color: #1E40AF; }
        .status-prior-year-only .status-badge { background-color: #E5E7EB; color: #4B5563; }
        .status-close-match .status-badge { background-color: #E0E7FF; color: #4338CA; }
        .status-manual-match .status-badge { background-color: #C7D2FE; color: #3730A3; }
        .status-rounding-difference .status-badge { background-color: #E5E7EB; color: #4B5563; }

        body.dark-mode .status-exact-match .status-badge { background-color: #166534; color: #BBF7D0; }
        body.dark-mode .status-variance .status-badge { background-color: #92400E; color: #FDE68A; }
        body.dark-mode .status-new-account .status-badge { background-color: #1E40AF; color: #BFDBFE; }
        body.dark-mode .status-prior-year-only .status-badge { background-color: #4B5563; color: #D1D5DB; }
        body.dark-mode .status-close-match .status-badge { background-color: #4338CA; color: #C7D2FE; }
        body.dark-mode .status-manual-match .status-badge { background-color: #5B21B6; color: #DDD6FE; }
        body.dark-mode .status-rounding-difference .status-badge { background-color: #4B5563; color: #D1D5DB; }
        
        .review-table input[type="text"], .review-table select, .review-table textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text-dark);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .review-table textarea {
            min-height: 40px;
            font-family: 'Inter', sans-serif;
            resize: both;
        }
        .review-table input[type="text"]:focus, .review-table select:focus, .review-table textarea:focus {
             outline: none;
             border-color: var(--primary-blue);
             box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        .review-table input[type="checkbox"] { height: 1rem; width: 1rem; accent-color: var(--primary-blue); }
        .suggestion-text {
            font-style: italic;
            color: var(--text-light);
            font-size: 0.825rem;
            display: block;
            margin-top: 0.25rem;
            text-align: left;
        }
        
        /* Advanced Filter & Tick Mark Manager Icon Styles */
        .review-table th .th-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative; /* For icon positioning */
        }
        .review-table th.text-left-aligned .th-content {
            justify-content: flex-start;
        }
        .th-icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            color: #9CA3AF;
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
            border: none;
            background: transparent;
            border-radius: 0.25rem;
        }
        .th-icon-btn:hover { color: var(--text-dark); background-color: var(--medium-gray-bg); }
        .th-icon-btn.active { color: var(--primary-blue); }
        body.dark-mode .th-icon-btn:hover { background-color: var(--light-gray-bg); }

        #toggle-filter-btn {
            background-color: transparent;
            color: var(--text-dark);
            padding: 0.625rem;
            border: 1px solid var(--border-color);
        }
        #toggle-filter-btn:hover { background-color: var(--medium-gray-bg); }
        #toggle-filter-btn.active { background-color: var(--info-blue-bg); border-color: var(--primary-blue); color: var(--primary-blue); }
        body.dark-mode #toggle-filter-btn { color: var(--text-dark); }
        body.dark-mode #toggle-filter-btn:hover { background-color: #374151; }
        body.dark-mode #toggle-filter-btn.active { background-color: #1E40AF; color: #E0E7FF; border-color: #E0E7FF; }

        /* V52: ENHANCED FILTER POPUP STYLES (Excel-inspired) */
        #filter-popup {
            position: fixed; /* Changed from absolute to fixed for viewport relativity */
            z-index: 1001; /* Above table content but below modals */
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            width: 320px;
            font-weight: normal;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .filter-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        #filter-popup-close-btn {
            background: none; border: none; font-size: 1.5rem;
            color: var(--text-light); cursor: pointer; padding: 0.25rem;
            line-height: 1;
        }
        .filter-popup-content {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .filter-popup-content .form-group { margin-bottom: 0; }
        .filter-popup-content input[type="text"],
        .filter-popup-content input[type="number"],
        .filter-popup-content select {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text-dark);
        }
        .filter-popup-content label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            display: block;
        }
        .filter-popup-checklist-search {
            position: relative;
            margin-bottom: 0.75rem;
        }
        .filter-popup-checklist-search::before {
            content: '🔍';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
        }
        .filter-popup-checklist-search input {
            padding-left: 2.25rem !important;
        }
        .filter-popup-checklist {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        .filter-popup-checklist-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.375rem;
            cursor: pointer;
            font-weight: normal;
            font-size: 0.875rem;
            border-radius: 0.25rem;
        }
        .filter-popup-checklist-item:hover {
            background-color: var(--medium-gray-bg);
        }
        body.dark-mode .filter-popup-checklist-item:hover {
            background-color: #374151;
        }
        .filter-popup-checklist-item input {
            width: 1rem;
            height: 1rem;
        }
        .filter-popup-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--light-gray-bg);
        }
        body.dark-mode .filter-popup-actions {
            background-color: #111827;
        }
        .btn-filter-action {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
        }
        .btn-filter-apply {
            background-color: var(--primary-blue);
            color: var(--text-on-primary);
        }
        .btn-filter-apply:hover { background-color: var(--primary-blue-dark); }
        .btn-filter-clear {
            background-color: transparent;
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }
        .btn-filter-clear:hover { background-color: var(--medium-gray-bg); }
        body.dark-mode .btn-filter-clear { color: var(--text-light); }
        body.dark-mode .btn-filter-clear:hover { background-color: #374151; }
        .btn-danger { background-color: transparent; color: var(--danger-red); border: 1px solid var(--danger-red); }
        .btn-danger:hover { background-color: var(--danger-red-bg); }
        body.dark-mode .btn-danger:hover { color: #FECACA; background-color: #991B1B; }
        
        #fixed-horizontal-scrollbar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20px;
            z-index: 1000;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            overflow: hidden; /* No native scrollbar */
            padding: 0 4px;
            box-sizing: border-box;
        }
        #custom-scroll-thumb {
            position: absolute;
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            top: 50%;
            transform: translateY(-50%);
            cursor: grab;
            transition: background-color 0.2s;
        }
        #custom-scroll-thumb:hover {
            background-color: var(--text-light);
        }
        #custom-scroll-thumb:active {
            cursor: grabbing;
        }
        
        /* Tooltip & Theme Toggle Styles */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .tooltip-icon, #filter-shortcut-hint {
            cursor: pointer;
            color: var(--text-light);
            margin-left: 0.5rem;
        }
        #tooltip {
            position: fixed;
            background-color: var(--text-dark);
            color: var(--light-gray-bg);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            font-size: 0.875rem;
            font-weight: 500;
            max-width: 250px;
        }
        body:not(.dark-mode) #tooltip {
             background-color: #1F2937;
             color: #E5E7EB;
        }
        #tooltip.visible {
            opacity: 1;
        }
        /* Homepage Top-Right Action Buttons */
        #homepage-actions {
            position: fixed;
            top: 1rem;
            right: 1.5rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-header-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: var(--card-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            border-radius: 99px;
            font-weight: 500;
            font-size: 0.875rem;
            text-decoration: none;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .btn-header-link:hover {
            color: var(--primary-blue);
            background-color: var(--medium-gray-bg);
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        #theme-toggle {
            /* position, top, right, z-index are now handled by #homepage-actions */
            background: var(--card-bg); /* Keep background for consistency */
            border: 1px solid var(--border-color); /* Add border for consistency */
            color: var(--text-light);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 99px;
            display: flex;
            align-items: center;
        }
        #main-app-container #theme-toggle {
             position: static;
             border: none; /* Revert border change for main app view */
        }
        #theme-toggle:hover {
            color: var(--text-dark);
            background-color: var(--medium-gray-bg);
        }
        body.dark-mode #theme-toggle:hover {
            background-color: #374151;
        }
        
        /* Modal Styles (Shared) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-shrink: 0;
        }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .modal-header .btn-minimal { padding: 0.5rem; }
        .modal-footer { margin-top: 1.5rem; text-align: right; flex-shrink: 0; display: flex; justify-content: flex-end; gap: 0.75rem;}

        /* V58: Error & Privacy Modal Specifics */
        #error-modal .modal-content, #privacy-modal .modal-content, #session-recovery-modal .modal-content {
            max-width: 550px;
        }
        .modal-body-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }
        #error-details-container {
            margin-top: 1rem;
        }
        #error-details-toggle {
            font-weight: 600;
            cursor: pointer;
            color: var(--primary-blue);
        }
        #error-details-content {
            margin-top: 0.5rem;
            background-color: var(--medium-gray-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            max-height: 150px;
            overflow-y: auto;
        }
        #error-details-content textarea {
            width: 100%;
            height: 120px;
            border: none;
            background: none;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-light);
            resize: none;
        }
        body.dark-mode #error-details-content textarea {
            color: var(--text-light);
        }

        /* Manual Mapping Modal Specifics */
        #manual-mapping-modal .modal-content {
            max-width: 800px;
            max-height: 80vh;
        }
        .modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        .mapping-column h3 { margin-top: 0; font-size: 1.125rem; }
        .mapping-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }
        .mapping-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .mapping-item:last-child { border-bottom: none; }
        .mapping-item:hover { background-color: var(--medium-gray-bg); }
        .mapping-item.selected { background-color: var(--primary-blue); color: var(--text-on-primary); }
        
        /* V47: Parser Wizard & Profile Manager Modal Styles */
        #parser-wizard-modal .modal-content, #profile-manager-modal .modal-content {
            max-width: 95vw;
            width: 1200px;
            max-height: 90vh;
        }
        #profile-manager-modal .modal-content {
            width: 600px;
        }
        .parser-wizard-body {
            flex-grow: 1;
            overflow-y: hidden;
            display: flex;
            flex-direction: column;
        }
        .parser-wizard-step {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #parser-sheet-selector {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        #parser-sheet-selector label {
            padding: 0.75rem;
            border-radius: 0.375rem;
        }
        #parser-sheet-selector label:has(input:checked) {
            background-color: var(--info-blue-bg);
            font-weight: 600;
        }
        .parser-wizard-options {
            padding: 1rem;
            background-color: var(--medium-gray-bg);
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .parser-wizard-options label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            cursor: pointer;
        }
        body.dark-mode .parser-wizard-options {
            background-color: var(--light-gray-bg);
        }
        .column-mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            padding: 0.5rem;
            overflow-y: auto;
        }
        .column-mapping-item label { font-weight: 600; }
        .column-mapping-item p { font-size: 0.875rem; color: var(--text-light); margin: 0.25rem 0 0.5rem; height: 3em; overflow: hidden; }
        .column-mapping-item select { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; }
        .preview-table-wrapper { overflow: auto; border: 1px solid var(--border-color); border-radius: 0.5rem; flex-grow: 1;}
        .preview-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .preview-table th, .preview-table td { padding: 0.5rem; border: 1px solid var(--border-color); text-align: left; white-space: nowrap; }
        .preview-table th { background-color: var(--medium-gray-bg); }
        .preview-table td.parsing-error { background-color: var(--danger-red-bg); }
        .preview-table .inferred-nature-badge {
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            background-color: var(--light-gray-bg);
            border: 1px solid var(--border-color);
        }
        /* V47: New Profile Management Styles */
        .profile-list { list-style: none; padding: 0; margin: 0; }
        .profile-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background-color: var(--light-gray-bg); border-radius: 0.5rem; margin-bottom: 0.75rem; }
        .profile-item input[type="text"] { font-weight: 500; background-color: var(--card-bg); }
        #import-profile-container { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; }
        #import-profile-container label { margin-bottom: 0; white-space: nowrap; }
        #import-profile-select { flex-grow: 1; }

        /* V41 & V42: Tick Mark Manager Sidebar Styles */
        #tick-manager-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1050;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        #tick-manager-sidebar-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #tick-manager-sidebar {
            position: fixed;
            top: 0;
            right: -400px; /* Start off-screen */
            width: 100%;
            max-width: 400px;
            height: 100%;
            background-color: var(--card-bg);
            z-index: 1051;
            box-shadow: -2px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #tick-manager-sidebar.visible {
            right: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-header h2 { font-size: 1.25rem; margin: 0; }

        .sidebar-body {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #tick-manager-form-container {
            padding: 1.5rem;
            background-color: var(--light-gray-bg);
            border-bottom: 1px solid var(--border-color);
        }
        body.dark-mode #tick-manager-form-container {
            background-color: #111827;
        }
        
        #tick-manager-form .form-group { margin-bottom: 1rem; }
        #tick-manager-form .form-group:last-of-type { margin-bottom: 0; }
        #tick-manager-form label { font-size: 0.875rem; }
        #tick-manager-form input, #tick-manager-form textarea { font-size: 0.875rem; padding: 0.5rem 0.75rem; }
        .symbol-input-wrapper { display: flex; align-items: center; gap: 0.5rem; }
        #tick-manager-symbol-input { flex-grow: 1; }
        #tick-manager-symbol-picker-btn { flex-shrink: 0; padding: 0.5rem; font-size: 1rem; }

        #tick-manager-list-container {
            flex-grow: 1;
        }
        
        .tick-definition-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: grab;
            transition: background-color 0.2s, opacity 0.2s;
        }
        .tick-definition-item:active { cursor: grabbing; }
        .tick-definition-item .symbol { font-size: 1.5rem; font-weight: 700; width: 40px; text-align: center; pointer-events: none; }
        .tick-definition-item .desc { flex-grow: 1; font-size: 0.875rem; color: var(--text-light); pointer-events: none; }
        .tick-definition-item .actions { display: flex; gap: 0.5rem; }
        
        /* V42: Drag & Drop Styling */
        .tick-definition-item.dragging {
            opacity: 0.5;
            background: var(--info-blue-bg);
        }
        .tick-definition-item.drag-over {
            border-top: 2px solid var(--primary-blue);
        }

        /* --- SYMBOL PICKER ENHANCEMENT --- */
        #symbol-picker-popup {
            position: fixed; /* Use fixed for viewport-relative positioning */
            z-index: 1060; /* Higher than sidebar overlay */
            width: 320px;
            max-height: 400px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-weight: normal;
        }

        .symbol-picker-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .symbol-picker-search {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            box-sizing: border-box;
            background-color: var(--light-gray-bg);
            color: var(--text-dark);
        }
        .symbol-picker-content {
            padding: 0.75rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        .symbol-picker-category-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            margin: 0.75rem 0 0.5rem;
            padding-left: 0.25rem;
        }
        .symbol-picker-category-title:first-child {
            margin-top: 0;
        }
        .symbol-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
            gap: 0.25rem;
        }
        .symbol-picker-item {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
            line-height: 1;
            transition: background-color 0.2s;
            -webkit-user-select: none; user-select: none;
        }
        .symbol-picker-item:hover {
            background-color: var(--medium-gray-bg);
        }
        .symbol-picker-footer {
            display: flex;
            border-top: 1px solid var(--border-color);
            background-color: var(--light-gray-bg);
        }
        body.dark-mode .symbol-picker-footer {
            background-color: var(--light-gray-bg);
        }
        .symbol-picker-tab {
            flex: 1;
            padding: 0.75rem 0.5rem;
            font-size: 1.25rem;
            cursor: pointer;
            text-align: center;
            color: var(--text-light);
            border: none;
            background: transparent;
            transition: background-color 0.2s, color 0.2s;
            position: relative;
        }
        .symbol-picker-tab:hover {
            background-color: var(--medium-gray-bg);
        }
        .symbol-picker-tab.active {
            color: var(--primary-blue);
        }
        .symbol-picker-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 3px;
            background-color: var(--primary-blue);
            border-radius: 2px;
        }
        
        /* V43: Dynamic Footer Visibility */
        .sidebar-footer {
            display: none; /* Hidden by default */
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--light-gray-bg);
        }
        #tick-manager-sidebar.sidebar-in-edit-mode .sidebar-footer {
            display: block; /* Visible only when in edit mode */
        }
        body.dark-mode .sidebar-footer {
            background-color: #111827;
        }
        .sidebar-footer h3 { font-size: 1rem; font-weight: 600; margin-top: 0; margin-bottom: 1rem; }
        .sidebar-footer .form-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .sidebar-footer .form-group:last-of-type { margin-bottom: 0; }
        .sidebar-footer .form-group label { margin-bottom: 0; font-size: 0.875rem; }
        .sidebar-footer .radio-group { margin-bottom: 0; display: flex; gap: 0.75rem; }
        .sidebar-footer .radio-group label { font-size: 0.875rem; }

        .sidebar-footer select { padding: 0.25rem 0.5rem; font-size: 0.875rem; width: auto; }

        /* V44: Style for collapsible Matching tab section */
        #matching-content details {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
            border: 1px solid var(--border-color);
        }
        #matching-content summary {
            font-weight: 600;
            cursor: pointer;
        }

        /* V48: Auditor Sign-off Card Styles */
        #auditor-signoff-card .signoff-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .app-main-header, .workspace-content { padding-left: 1rem; padding-right: 1rem; }
            .app-nav { padding: 0.5rem 1rem; gap: 0.5rem; }
            .app-logo { font-size: 1rem; }
            .nav-tab { font-size: 0.875rem; padding: 0.5rem 0.75rem; }
            #engagement-workspace-title { font-size: 1.5rem; }
            #theme-toggle { top: 0.5rem; right: 0.5rem; }
            #main-app-container #theme-toggle { position: static; }
            .modal-body { grid-template-columns: 1fr; }
            .mapping-list { max-height: 25vh; }
            .column-mapping-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 640px) {
            #auditor-signoff-card .signoff-grid {
                grid-template-columns: 1fr;
                gap: 1.25rem;
            }
        }
    </style>
</head>

<body>

    <!-- Homepage Top-Right Action Buttons -->
    <div id="homepage-actions">
        <a href="User Guide.html" class="btn btn-header-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6-2.292m0 0v14.25m0-14.25a8.967 8.967 0 00-6 2.292m6-2.292a8.967 8.967 0 016 2.292m0 0V18m-6-6h.008v.008H12V12z" /></svg>
            <span>User Guide</span>
        </a>
        <a href="Creator.html" class="btn btn-header-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
            <span>About Creator</span>
        </a>
        <!-- Global Theme Toggle Button -->
        <button id="theme-toggle" data-tooltip="Toggle Dark/Light Mode">
            <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a5 5 0 100-10 5 5 0 000 10z" /></svg>
            <svg id="theme-icon-moon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.805 0 5.347-1.257 7.202-3.248z" /></svg>
        </button>
    </div>

    <div id="processing-bar" class="processing-bar hidden">
        <div id="processing-bar-content">
            <div class="spinner"></div>
            <span id="processing-bar-text">Processing...</span>
        </div>
        <button id="cancel-processing-btn" class="hidden">Cancel</button>
    </div>
    
    <div id="tooltip" role="tooltip"></div>

    <!-- V52: ENHANCED FILTER POPUP SHELL -->
    <div id="filter-popup" class="hidden">
        <div class="filter-popup-header">
            <span id="filter-popup-title"></span>
            <button id="filter-popup-close-btn">&times;</button>
        </div>
        <div id="filter-popup-content" class="filter-popup-content">
            <!-- Dynamically populated by JS -->
        </div>
        <div class="filter-popup-actions">
            <button id="filter-popup-clear-btn" class="btn-filter-action btn-filter-clear">Clear</button>
            <button id="filter-popup-apply-btn" class="btn-filter-action btn-filter-apply">Apply</button>
        </div>
    </div>
    
    <!-- ENHANCEMENT: New Symbol Picker Popup -->
    <div id="symbol-picker-popup" class="hidden">
        <div class="symbol-picker-header">
            <input type="search" id="symbol-picker-search" class="symbol-picker-search" placeholder="🔍 Search symbols...">
        </div>
        <div id="symbol-picker-content" class="symbol-picker-content">
            <!-- Dynamically populated -->
        </div>
        <div id="symbol-picker-footer" class="symbol-picker-footer">
            <!-- Dynamically populated -->
        </div>
    </div>

    <!-- V58: NEW MODALS (Privacy, Error, Session Recovery) -->
    <div id="privacy-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Privacy & Data Security</h2>
                <button id="privacy-modal-close-btn" class="btn btn-minimal">&times;</button>
            </div>
            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <span class="modal-body-icon">🛡️</span>
                <div>
                    <p><strong>This application runs entirely in your browser.</strong></p>
                    <p>All your audit data is stored locally on your computer using the browser's secure IndexedDB storage.</p>
                    <p>Your data is <strong>never</strong> transmitted to any server. Your privacy and data confidentiality are guaranteed.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="privacy-modal-ok-btn" class="btn">OK</button>
            </div>
        </div>
    </div>

    <div id="error-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span class="modal-body-icon" style="font-size: 1.5rem; margin-right: 0.5rem;">⚠️</span>Application Error</h2>
                <button id="error-modal-close-btn" class="btn btn-minimal">&times;</button>
            </div>
            <div>
                <p id="error-modal-message">Oops! Something went wrong while trying to perform the last action. Your work up to the last save is safe. Please try the action again.</p>
                <div id="error-details-container">
                    <a href="#" id="error-details-toggle">Show Technical Details ▼</a>
                    <div id="error-details-content" class="hidden">
                        <textarea id="error-details-textarea" readonly></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="error-modal-copy-btn" class="btn btn-minimal">Copy Details</button>
                <button id="error-modal-ok-btn" class="btn">Close</button>
            </div>
        </div>
    </div>

    <div id="session-recovery-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span class="modal-body-icon" style="font-size: 1.5rem; margin-right: 0.5rem;">🔃</span>Session Recovery</h2>
            </div>
            <div>
                <p id="session-recovery-message">It looks like your last session ended unexpectedly. Would you like to restore your work?</p>
            </div>
            <div class="modal-footer">
                <button id="session-recovery-discard-btn" class="btn btn-minimal">No, Start Fresh</button>
                <button id="session-recovery-restore-btn" class="btn">Yes, Restore Session</button>
            </div>
        </div>
    </div>

    <!-- V41/V42/V43: Tick Mark Manager Sidebar -->
    <div id="tick-manager-sidebar-overlay"></div>
    <aside id="tick-manager-sidebar">
        <header class="sidebar-header">
            <h2>Manage Tick Marks</h2>
            <button id="tick-manager-close-btn" class="btn btn-minimal" data-tooltip="Close (Esc)">&times;</button>
        </header>
        <div class="sidebar-body">
            <div id="tick-manager-form-container">
                <form id="tick-manager-form">
                    <input type="hidden" id="tick-manager-edit-id">
                    <div class="form-group">
                        <label for="tick-manager-symbol-input">Symbol</label>
                        <div class="symbol-input-wrapper">
                            <input type="text" id="tick-manager-symbol-input" maxlength="2" placeholder="e.g., ✓">
                            <button type="button" id="tick-manager-symbol-picker-btn" class="btn btn-minimal" data-tooltip="Pick a symbol">🎯</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tick-manager-desc-input">Description</label>
                        <textarea id="tick-manager-desc-input" rows="3" maxlength="200" placeholder="e.g., Agreed to supporting documentation"></textarea>
                    </div>
                    <button type="submit" id="tick-manager-save-btn" class="btn-primary">Add New Tick Mark</button>
                </form>
            </div>
            <div id="tick-manager-list-container">
                <!-- Dynamically populated -->
            </div>
        </div>
        <footer class="sidebar-footer">
            <h3>Conclusion Auto-Insertion Settings</h3>
            <div class="form-group">
                <label>Insertion Point</label>
                <div class="radio-group" id="tick-insertion-point-group">
                    <label><input type="radio" name="tick-insertion-point" value="top"> Top</label>
                    <label><input type="radio" name="tick-insertion-point" value="bottom"> Bottom</label>
                </div>
            </div>
             <div class="form-group">
                <label>Formatting Style</label>
                <div class="radio-group" id="tick-format-style-group">
                    <label><input type="radio" name="tick-format-style" value="bullet"> Bullet</label>
                    <label><input type="radio" name="tick-format-style" value="paragraph"> Paragraph</label>
                </div>
            </div>
             <div class="form-group">
                <label for="tick-separator-select">Separator</label>
                <select id="tick-separator-select">
                    <option value="\n---\n">Horizontal Line</option>
                    <option value="\n\n">Double Line Break</option>
                </select>
            </div>
        </footer>
    </aside>
    
    <!-- Manual Mapping Modal -->
    <div id="manual-mapping-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Map Unmatched Accounts</h2>
                <button id="close-mapping-modal-btn" class="btn btn-minimal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mapping-column">
                    <h3>Unmatched Current Year</h3>
                    <ul id="unmatched-cy-list" class="mapping-list"></ul>
                </div>
                <div class="mapping-column">
                    <h3>Unmatched Prior Year</h3>
                    <ul id="unmatched-py-list" class="mapping-list"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-mapping-btn" class="btn" disabled>Map Selected Accounts</button>
            </div>
        </div>
    </div>
    
    <!-- V47: Import Profile Manager Modal -->
    <div id="profile-manager-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Import Profiles</h2>
                <button id="profile-manager-close-btn" class="btn btn-minimal">&times;</button>
            </div>
            <div class="modal-body" style="grid-template-columns: 1fr;">
                <p class="text-light" style="margin-top: -1rem;">Saved profiles remember your column mappings and cleaning settings for faster imports.</p>
                <div id="profile-manager-list-container">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- V38/V47: TB Parsing Wizard Modal -->
    <div id="parser-wizard-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="parser-wizard-title">Import Trial Balance</h2>
                <button id="parser-wizard-close-btn" class="btn btn-minimal">&times;</button>
            </div>
            <div class="parser-wizard-body">
                <!-- V47: Step 0: Sheet Selection -->
                <div id="parser-step-0" class="parser-wizard-step hidden">
                    <div class="alert-banner info">
                        <p>This file contains multiple sheets. Please select the sheet containing the trial balance data you want to import.</p>
                    </div>
                    <div id="parser-sheet-selector">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Step 1: Column Mapping -->
                <div id="parser-step-1" class="parser-wizard-step hidden">
                    <div class="alert-banner info" style="display:flex; justify-content: space-between; align-items: center;">
                        <p style="margin: 0;">We've detected the columns from your file. Please verify the mappings and select any data cleaning helpers.</p>
                        <button id="save-profile-btn" class="btn" data-tooltip="Save current mapping settings as a reusable profile">Save Mapping Profile</button>
                    </div>
                    <div class="parser-wizard-options">
                        <label>
                            <input type="checkbox" id="split-combined-checkbox">
                            Automatically split combined Account Code and Name (e.g., "1001 - Cash")
                        </label>
                        <label>
                            <input type="checkbox" id="use-inference-checkbox">
                            Use intelligent balance inference for unsigned amounts
                        </label>
                    </div>
                    <div id="column-mapping-container" class="column-mapping-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                <!-- Step 2: Preview & Validate -->
                <div id="parser-step-2" class="parser-wizard-step hidden">
                     <div id="parser-preview-summary" class="alert-banner info"></div>
                     <!-- V47: Data Health Check Summary -->
                     <div id="parser-health-check-summary" class="alert-banner warning hidden"></div>

                     <div class="preview-table-wrapper">
                         <table id="parser-preview-table" class="preview-table"></table>
                     </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="parser-wizard-back-btn" class="btn btn-minimal hidden">Back</button>
                <button id="parser-wizard-next-btn" class="btn">Next: Preview Data</button>
                <button id="parser-wizard-confirm-btn" class="btn btn-secondary hidden">Confirm & Import</button>
            </div>
        </div>
    </div>
    <!-- ENGAGEMENT CREATION VIEW -->
    <div id="engagement-creation-container">
        <div class="app-header-container">
            <header id="initial-header">
                <h1>Opening Balance Ticking</h1>
                <p>Streamline your SA 510 compliance with automated balance verification</p>
            </header>
            <header id="app-header" class="hidden">
                <div class="logo-container">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c.504 0 1.002-.023 1.493-.067M12 21A9.004 9.004 0 003.286 14.253m9.431 6.814a9.002 9.002 0 01-9.431-6.814M3 9.75a9.004 9.004 0 0113.11-6.493m-9.626 9.626a9.004 9.004 0 016.493-13.11M12 3c.504 0 1.002.023 1.493-.067M12 3a9.004 9.004 0 018.716 6.747M12 3a9.004 9.004 0 00-8.716-6.747M21 9.75a9.004 9.004 0 00-13.11 6.493M17.25 10.5h.008v.008h-.008v-.008zM6.75 10.5h.008v.008h-.008v-.008z" /></svg>
                    <span>Opening Balance Ticking Tool</span>
                </div>
                <span class="compliance-tag">SA 510 Compliant</span>
            </header>
        </div>

        <main class="main-container">
            <section id="engagement-card" class="card">
                <h2>Create New Audit Engagement</h2>
                <form id="engagement-form" novalidate>
                    <div class="form-group">
                        <label for="client-name">Client Name</label>
                        <input type="text" id="client-name" name="clientName" placeholder="Enter client name" required>
                    </div>
                    <div class="form-group">
                        <label for="engagement-year" id="engagement-year-label">Engagement Year</label>
                        <input type="text" id="engagement-year" name="engagementYear" placeholder="e.g., 2024">
                    </div>
                    <div class="radio-group year-type-group">
                        <label><input type="radio" name="year-type" value="Calendar" checked> Calendar Year</label>
                        <label><input type="radio" name="year-type" value="Financial"> Financial Year</label>
                    </div>
                    <button type="submit" id="create-engagement-btn" class="btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        <span>Create Engagement</span>
                    </button>
                </form>
            </section>

            <section id="recent-engagements-card" class="card hidden">
                <h2>Recent Engagements</h2>
                <ul id="recent-engagements-list"></ul>
            </section>

            <section id="import-card" class="card">
                <h2>Have a backup file?</h2>
                <p style="color: var(--text-light); margin-top: -1rem; margin-bottom: 1.5rem; font-size: 0.875rem;">Import a previously exported engagement to restore your work.</p>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
                <button id="import-engagement-btn" class="btn btn-minimal" style="width: 100%;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                    <span>Import Engagement</span>
                </button>
            </section>

            <section id="features-card" class="card">
                <h3><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg>Key Features</h3>
                <div class="features-grid">
                    <div class="feature-item"><svg class="icon-compliant" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><div class="feature-item-text"><h4>SA 510 Compliant</h4><p>Full compliance with auditing standards</p></div></div>
                    <div class="feature-item"><svg class="icon-feature" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" /></svg><div class="feature-item-text"><h4>Auto-Matching</h4><p>Intelligent balance comparison</p></div></div>
                    <div class="feature-item"><svg class="icon-feature" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.553L16.5 21.75l-.398-1.197a3.375 3.375 0 00-2.456-2.456L12.75 18l1.197-.398a3.375 3.375 0 002.456-2.456L16.5 14.25l.398 1.197a3.375 3.375 0 002.456 2.456L20.25 18l-1.197.398a3.375 3.375 0 00-2.456 2.456z" /></svg><div class="feature-item-text"><h4>Intelligent Data Extraction & Parsing</h4><p>Extract data from Excel, CSV</p></div></div>
                    <div class="feature-item"><svg class="icon-feature" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg><div class="feature-item-text"><h4>Working Papers</h4><p>Generate professional audit documentation</p></div></div>
                </div>
            </section>
        </main>
    </div>

    <!-- MAIN APPLICATION WORKSPACE -->
    <div id="main-app-container" class="hidden">
        <header class="app-main-header">
            <div class="header-left">
                <button id="back-to-engagements-btn" class="btn btn-minimal" data-tooltip="Back to Engagements">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
                    <span>Engagements</span>
                </button>
                <div class="app-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c.504 0 1.002-.023 1.493-.067M12 21A9.004 9.004 0 003.286 14.253m9.431 6.814a9.002 9.002 0 01-9.431-6.814M3 9.75a9.004 9.004 0 0113.11-6.493m-9.626 9.626a9.004 9.004 0 016.493-13.11M12 3c.504 0 1.002.023 1.493-.067M12 3a9.004 9.004 0 018.716 6.747M12 3a9.004 9.004 0 00-8.716-6.747M21 9.75a9.004 9.004 0 00-13.11 6.493M17.25 10.5h.008v.008h-.008v-.008zM6.75 10.5h.008v.008h-.008v-.008z" /></svg>
                    <span>Opening Balance Ticking Tool</span>
                    <!-- V58: Privacy Shield Button -->
                    <button id="privacy-shield-btn" data-tooltip="Privacy & Data Security">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-8.25 6.75h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v10.5a2.25 2.25 0 002.25 2.25z" /></svg>
                    </button>
                </div>
            </div>
            <div class="header-right">
                <div class="app-context">
                    <span>SA 510 Compliant</span>
                    <div id="engagement-title-context"></div>
                </div>
            </div>
        </header>

        <nav class="app-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="dashboard">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path class="icon-outline" stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                        <path class="icon-solid" fill="currentColor" d="M2.25 3.75A1.5 1.5 0 00.75 5.25v13.5A1.5 1.5 0 002.25 20.25h19.5A1.5 1.5 0 0023.25 18.75V5.25A1.5 1.5 0 0021.75 3.75H2.25zM6 6.75A.75.75 0 016.75 6h2.25a.75.75 0 010 1.5H6.75A.75.75 0 016 6.75zM6.75 15a.75.75 0 000 1.5h2.25a.75.75 0 000-1.5H6.75zM15 6.75a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H15.75A.75.75 0 0115 6.75zM15.75 15a.75.75 0 000 1.5h2.25a.75.75 0 000-1.5H15.75z"/>
                    </svg>
                    <span>Dashboard</span>
                </button>
                <button class="nav-tab" data-tab="upload">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path class="icon-outline" stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                        <path class="icon-solid" fill="currentColor" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5h-4.522a3.001 3.001 0 01-5.956 0 H3zM12 3L16.5 7.5h-3v6h-3v-6H7.5L12 3z" />
                    </svg>
                    <span>Upload TB</span>
                </button>
                <button class="nav-tab" data-tab="matching">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path class="icon-outline" stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                        <path class="icon-solid" fill="currentColor" d="M16.42 2.96a.75.75 0 011.06 0l3.75 3.75a.75.75 0 01-1.06 1.06L16.5 4.06v14.19a.75.75 0 01-1.5 0V4.06L11.28 7.78a.75.75 0 01-1.06-1.06l3.75-3.75zM7.58 21.04a.75.75 0 01-1.06 0l-3.75-3.75a.75.75 0 011.06-1.06L7.5 19.94V5.75a.75.75 0 011.5 0v14.19l3.72-3.72a.75.75 0 111.06 1.06l-3.75 3.75z" />
                    </svg>
                    <span>Balance Matching</span>
                </button>
                <button class="nav-tab" data-tab="review">
                     <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path class="icon-outline" stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path class="icon-solid" fill="currentColor" clip-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.06-1.06L12 12.94 9.97 10.91a.75.75 0 00-1.06 1.06l2.5 2.5a.75.75 0 001.06 0l4.5-4.5z" />
                    </svg>
                    <span>Review & Tick</span>
                </button>
                <button class="nav-tab" data-tab="paper">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path class="icon-outline" stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        <path class="icon-solid" fill="currentColor" clip-rule="evenodd" d="M3.375 2.25A2.25 2.25 0 001.125 4.5v15A2.25 2.25 0 003.375 21.75h17.25A2.25 2.25 0 0022.875 19.5V4.5A2.25 2.25 0 0020.625 2.25H3.375zM8.25 9a.75.75 0 000 1.5h7.5a.75.75 0 000-1.5h-7.5zM8.25 12.75a.75.75 0 000 1.5h7.5a.75.75 0 000-1.5h-7.5z" />
                    </svg>
                    <span>Working Paper</span>
                </button>
            </div>
            <!-- V58: Save Status Container -->
            <div id="save-status-container" class="hidden">
                <span id="save-status-indicator">✓ All changes saved</span>
                <span id="last-saved-timestamp"></span>
            </div>
        </nav>

        <main class="workspace-content">
            <!-- Dynamically populated content goes here -->
            <div id="tab-content-container">

                <!-- DASHBOARD CONTENT -->
                <div id="dashboard-content" class="tab-pane">
                    <div class="engagement-context-header">
                        <div id="engagement-workspace-title-wrapper">
                           <h2 id="engagement-workspace-title-dashboard"></h2>
                        </div>
                        <div class="context-header-actions">
                             <button id="export-engagement-btn" class="btn btn-minimal" data-tooltip="Export Engagement Data"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg><span>Export</span></button>
                             <button id="refresh-dashboard-btn" class="btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991 4.992v-4.992" /></svg><span>Refresh</span></button>
                        </div>
                    </div>
                    <div class="dashboard-grid" id="dashboard-grid">
                        <div class="stat-card stat-clickable" data-filter-type="all"><div class="icon-wrapper blue"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg></div><div class="stat-info"><h4>Total Accounts</h4><p id="stat-total-accounts">0</p></div></div>
                        <div class="stat-card stat-clickable" data-filter-type="status" data-filter-value="Exact Match"><div class="icon-wrapper green"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="stat-info"><h4>Exact Matches</h4><p id="stat-exact-matches">0</p></div></div>
                        <div class="stat-card stat-clickable" data-filter-type="status" data-filter-value="Variance"><div class="icon-wrapper yellow"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg></div><div class="stat-info"><h4>Variances</h4><p id="stat-variances">0</p></div></div>
                        <div class="stat-card stat-clickable" data-filter-type="reviewStatus" data-filter-value="true"><div class="icon-wrapper purple"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg></div><div class="stat-info"><h4>Reviewed</h4><p id="stat-reviewed-count">0</p></div></div>
                    </div>
                    <div class="progress-card">
                        <h3>Review Progress</h3>
                        <div id="review-progress-container">
                            <div class="empty-state-card" style="padding: 2rem;"><h3>No data to review</h3></div>
                        </div>
                    </div>
                    <div class="progress-card">
                         <h3>Process Status</h3>
                         <div id="dashboard-status-container">
                             <div class="empty-state-card">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" /></svg>
                                 <h3>No trial balances uploaded yet</h3>
                             </div>
                         </div>
                    </div>
                </div>

                <!-- UPLOAD TB CONTENT -->
                <div id="upload-content" class="tab-pane hidden">
                    <div class="engagement-context-header"><h2>Upload Trial Balances</h2><div><button id="create-test-data-btn" class="btn btn-secondary">Create Test Data</button></div></div>
                    <div class="alert-banner success"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" /></svg><span><b>Test Mode:</b> Click "Create Test Data" to generate sample trial balance data for testing the system without uploading actual files. This creates realistic account data for both current and prior years.</span></div>
                    <div class="card">
                        <h3>Select Year Type</h3>
                        <div class="radio-group" id="year-type-radios">
                            <label><input type="radio" name="upload-year-type" value="current" checked> Current Year (Opening Balances)</label>
                            <label><input type="radio" name="upload-year-type" value="prior"> Prior Year (Closing Balances)</label>
                        </div>
                        
                        <!-- V47: Import Profile Selector -->
                        <div id="import-profile-container" class="form-group">
                            <label for="import-profile-select">Use Import Profile:</label>
                            <select id="import-profile-select">
                                <option value="">-- Default (Auto-detect) --</option>
                                <!-- Dynamically populated -->
                            </select>
                            <button id="manage-profiles-btn" class="btn btn-minimal" data-tooltip="Manage Saved Profiles">⚙️</button>
                        </div>

                        <div id="upload-dropzone" class="upload-dropzone">
                            <input type="file" id="file-input" class="hidden" accept=".csv, .xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="36" height="36"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" /></svg>
                            <h3>Drop your trial balance file here</h3>
                            <p>or click to browse</p>
                            <button id="browse-files-btn" class="btn">Browse Files</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Uploaded Files</h3>
                        <div id="uploaded-files-container">
                             <div class="empty-state-card">
                                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="48" height="48"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                                 <h3>No files uploaded yet</h3>
                             </div>
                        </div>
                    </div>
                    <div class="alert-banner info info-list"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><div><b>Upload Instructions</b><ul><li>Upload both current year (opening balances) and prior year (closing balances) trial balances.</li><li>Supported formats: Excel (.xlsx, .xls) and CSV.</li><li>The new intelligent parser will guide you through mapping the columns from your specific file format.</li></ul></div></div>
                </div>

                <!-- BALANCE MATCHING CONTENT -->
                <div id="matching-content" class="tab-pane hidden">
                    <div class="card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="margin-top:0; margin-bottom: 1rem;">Audit Settings</h3>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="apply-materiality-checkbox" style="display:flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                                <input type="checkbox" id="apply-materiality-checkbox" style="width: 1rem; height: 1rem;">
                                Apply Materiality Threshold
                            </label>
                        </div>
                        <div id="materiality-input-container" class="form-group hidden" style="margin-top: 1rem; margin-bottom: 0;">
                             <label for="materiality-threshold-input">Materiality Threshold (₹)</label>
                             <input type="number" id="materiality-threshold-input" placeholder="e.g., 50000">
                        </div>
                    </div>
                    <div style="text-align: right; margin-bottom: 1.5rem;">
                        <button id="auto-match-btn" class="btn" disabled>Auto-Match Balances</button>
                    </div>
                    
                    <div id="matching-warning-banner" class="alert-banner warning"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg><span>Please upload trial balances for both years before performing matching.</span></div>
                    <div id="matching-success-banner" class="alert-banner success hidden"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Auto-matching is complete. You can review the results on the Dashboard or proceed to the "Review & Tick" tab.</span></div>
                    
                    <div class="alert-banner info info-list">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" /></svg>
                        <div>
                            <b>Matching Algorithm</b>
                            <ul><li><b>Account Code Matching:</b> Exact matches on account codes receive highest priority.</li><li><b>Name Similarity:</b> Fuzzy matching on account names to handle minor variations.</li><li><b>Account Type:</b> Considers account classification (Asset, Liability, etc.).</li><li><b>Variance Analysis:</b> Algorithm analyzes significant differences and suggests possible causes.</li><li><b>Audit Assertions:</b> Automatically identifies relevant audit assertions for each variance.</li></ul>
                        </div>
                    </div>
                    <!-- V44: New collapsible info section for inference logic -->
                    <details>
                        <summary>🔍Inference Logic</summary>
                        <div class="info-list" style="margin-top: 1rem; padding-left: 1rem;">
                            <ul>
                                <li>Intelligently determines the nature (Debit/Credit) of unsigned balances by analyzing Debit, Credit, and Adjustment columns.</li>
                                <li>This optional feature can be enabled in the Parsing Wizard during file import to handle complex TB structures.</li>
                            </ul>
                        </div>
                    </details>
                </div>

                <!-- REVIEW & TICK CONTENT -->
                <div id="review-content" class="tab-pane hidden">
                    <div class="engagement-context-header">
                        <div id="engagement-workspace-title-wrapper">
                            <h2 id="review-workspace-title">Review & Tick Marks</h2>
                            <span id="filter-shortcut-hint" class="tooltip-container" data-tooltip="Click the filter icon or press Ctrl+Alt+F to toggle advanced filters.">
                               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.054.592.11.854.173.236.065.418.158.544.294.125.137.188.319.188.553 0 .25-.074.455-.22.615-.146.16-.36.24-.626.24h-.832v.46h.832c.39 0 .695-.121.914-.363.219-.243.328-.55.328-.913 0-.415-.147-.755-.44-1.036-.293-.282-.662-.485-1.076-.614zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4z"/></svg>
                            </span>
                        </div>
                        <div id="review-actions-container"></div>
                    </div>
                    <div class="review-toolbar">
                        <div class="review-toolbar-main">
                           <div class="search-wrapper">
                               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
                               <input type="search" id="review-search-input" placeholder="Search by Account Code or Name...">
                           </div>
                           <button id="map-unmatched-btn" class="btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
                               <span>Map Unmatched</span>
                           </button>
                        </div>
                        <div id="bulk-actions-container" class="hidden">
                            <select id="bulk-action-select">
                                <option value="">Bulk Action...</option>
                                <option value="markReviewed">Mark as Reviewed</option>
                                <option value="clearReviewed">Clear Reviewed Status</option>
                                <option value="clearTicksAndComments">Clear Ticks & Comments</option>
                                <optgroup id="bulk-action-ticks-optgroup" label="Apply Tick Mark">
                                    <!-- Dynamically populated -->
                                </optgroup>
                            </select>
                            <button id="bulk-action-apply-btn" class="btn">Apply</button>
                            <!-- V55: Placeholder for new scope UI -->
                            <div id="bulk-scope-container"></div>
                        </div>
                        <!-- V45: Pagination controls container -->
                        <div id="pagination-container" class="pagination-container hidden"></div>
                    </div>
                    <div id="review-table-container">
                        <div class="empty-state-card">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="48" height="48"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6-2.292m0 0v14.25m0-14.25a8.967 8.967 0 00-6 2.292m6-2.292a8.967 8.967 0 016 2.292m0 0V18m-6-6h.008v.008H12V12z" /></svg>
                            <h3>No balance matches available</h3>
                            <p>Please run auto-matching first.</p>
                        </div>
                    </div>
                </div>
                
                <!-- WORKING PAPER CONTENT -->
                <div id="paper-content" class="tab-pane hidden">
                    <div class="engagement-context-header">
                        <h2>Working Paper Report</h2>
                        <!-- V46: Report Generation Dropdown -->
                        <div id="report-generator-container" class="report-generator-group">
                            <button id="generate-pdf-btn" class="btn" disabled>
                                Generate Report (PDF)
                            </button>
                            <button id="report-options-btn" class="btn" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                            </button>
                            <div id="report-options-dropdown">
                                <button id="generate-excel-btn" class="dropdown-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM11.4 15.7L13.1 14.3L11.8 13.2L13.1 12.1L11.4 10.7L10.1 11.8L8.8 10.7L7.1 12.1L8.4 13.2L7.1 14.3L8.8 15.7L10.1 14.6L11.4 15.7Z"/></svg>
                                    <span>Export as Excel (.xlsx)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card" id="paper-summary-card"><h3>Report Summary</h3><div id="paper-summary-grid" class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                        </div></div>
                    <div class="card">
                        <div class="form-group">
                            <label for="discussion-points-textarea">Points for Discussion with Management</label>
                            <textarea id="discussion-points-textarea" placeholder="Enter any points that need to be discussed with the client or management..."></textarea>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="audit-conclusion-textarea">Overall Audit Conclusion</label>
                            <textarea id="audit-conclusion-textarea" placeholder="Enter the overall conclusion for the opening balance verification..."></textarea>
                        </div>
                    </div>
                    <!-- V48: New Auditor Sign-off section -->
                    <div id="auditor-signoff-card" class="card">
                        <h3>Auditor Sign-Off</h3>
                        <div class="signoff-grid">
                            <div class="form-group">
                                <label for="prepared-by-input">Prepared by</label>
                                <input type="text" id="prepared-by-input" placeholder="Enter name...">
                            </div>
                            <div class="form-group">
                                <label for="prepared-date-input">Date of Preparation</label>
                                <input type="date" id="prepared-date-input">
                            </div>
                            <div class="form-group">
                                <label for="reviewed-by-input">Reviewed by</label>
                                <input type="text" id="reviewed-by-input" placeholder="Enter name...">
                            </div>
                            <div class="form-group">
                                <label for="reviewed-date-input">Date of Review</label>
                                <input type="date" id="reviewed-date-input">
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Working Paper Preview</h3>
                        <div class="empty-state-card">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="48" height="48"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                            <h3>Professional Audit Working Paper</h3>
                            <p>Use the "Generate Report" button to create a print-ready PDF or an editable Excel file.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
    /*
     * D6: Comprehensive Documentation & Tracking
     * Changelog & Versionlog Maintenance
     * Version: V60 (UI Enhancements & Bug Fixes)
     * Description: This version introduces new homepage navigation buttons for improved user guidance and fixes critical tooltip visibility bugs.
     * - [New Feature] Homepage Actions: Added "User Guide" and "About Creator" icon buttons to the top-right of the engagement creation screen for easy access to documentation.
     * - [Enhancement] Button Visibility Logic: The new homepage buttons are context-aware and are hidden when the user enters the main application workspace.
     * - [Bug Fix] Viewport-Aware Tooltips: Reworked the tooltip positioning logic to be viewport-aware. Tooltips for the Privacy Shield and Theme Toggle buttons no longer get cut off by the screen edges, ensuring they are always fully readable.
     * - [Refactor] The global theme toggle button has been grouped into a new `#homepage-actions` container for better layout management and code organization on the homepage.
     * - [QA Verified] All new links function correctly. Button visibility logic is confirmed to work as expected when switching between the homepage and the main app. Tooltip fixes are verified across multiple screen sizes and on all relevant elements. No regressions to V59 functionality were found.
    */

    // Apply theme on initial script load to prevent FOUC
    (() => {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (savedTheme !== 'light' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark-mode-preload');
        }
    })();

    document.addEventListener('DOMContentLoaded', async () => {

        // --- V40: IndexedDB Abstraction Layer ---
        const DB = {
            db: null,
            name: 'AuditAppDB',
            version: 1,
            storeName: 'appData',

            init() {
                return new Promise((resolve, reject) => {
                    if (!('indexedDB' in window)) {
                        return reject('IndexedDB not supported');
                    }
                    const request = indexedDB.open(this.name, this.version);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (event) => {
                        console.error('DB Error:', event.target.errorCode);
                        reject(event.target.error);
                    };
                });
            },

            save(key, value) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { return reject("Database not initialized."); }
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put(value, key);
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });
            },

            get(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { return reject("Database not initialized."); }
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result === undefined ? null : request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            delete(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { return reject("Database not initialized."); }
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(key);
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });
            }
        };

        // --- V40: One-Time Migration from localStorage to IndexedDB ---
        async function migrateLocalStorageToIndexedDB() {
            try {
                const migrationFlag = localStorage.getItem('migratedToV48');
                if (migrationFlag) return;

                console.log("Starting one-time migration from localStorage to IndexedDB...");
                const keysToMigrate = Object.keys(localStorage).filter(k => k.startsWith('engagement') || k === 'currentEngagement' || k === 'activeTab');
                
                if (keysToMigrate.length > 0) {
                    for (const key of keysToMigrate) {
                        try {
                           const value = JSON.parse(localStorage.getItem(key));
                           await DB.save(key, value);
                           localStorage.removeItem(key);
                        } catch(e) {
                            console.warn(`Could not parse or migrate key: ${key}. Skipping.`);
                            localStorage.removeItem(key); // Remove malformed key
                        }
                    }
                    console.log(`Successfully migrated relevant items.`);
                }
                
                localStorage.setItem('migratedToV48', 'true');
                console.log("Migration complete.");
            } catch (error) {
                console.error("Migration failed:", error);
                // Do not alert here, as it could block the app for users with corrupted localStorage
            }
        }

        // --- V59: Parser Web Worker ---
        let parserWorker;
        const createParserWorker = () => {
            const workerCode = `
                // In a real modular app, this would be an import.
                // For single-file, we must use importScripts.
                self.importScripts('https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js');

                self.onmessage = (e) => {
                    const { file } = e.data;
                    const reader = new FileReader();

                    reader.onload = (event) => {
                        try {
                            postMessage({ type: 'progress', payload: { message: 'Reading file data...', percentage: 25 } });
                            const data = event.target.result;
                            
                            // For very large files, SheetJS recommends using 'array' type.
                            const workbook = XLSX.read(data, { type: 'array', cellNF: false, cellText: false });
                            
                            postMessage({ type: 'progress', payload: { message: 'Analyzing workbook structure...', percentage: 75 } });

                            // The worker's job is to do the heavy lifting of parsing.
                            // It prepares the initial state and sends it back to the main thread.
                            const parserState = {
                                fileName: file.name,
                                workbook: { // We only send the necessary parts of the workbook, not the whole object
                                    SheetNames: workbook.SheetNames,
                                    Sheets: workbook.Sheets
                                },
                                selectedSheetName: null,
                                rawData: null,
                                sanitizedData: null,
                                headerRowIndex: -1,
                                columnMap: {},
                                extractedData: null,
                                currentStep: -1
                            };
                            
                            // We can't send the full workbook object back because it contains non-cloneable properties.
                            // Instead, we serialize the necessary parts.
                            const serializableWorkbook = {
                                SheetNames: workbook.SheetNames,
                                Sheets: {}
                            };
                            workbook.SheetNames.forEach(name => {
                                serializableWorkbook.Sheets[name] = workbook.Sheets[name];
                            });
                            parserState.workbook = serializableWorkbook;

                            postMessage({ type: 'complete', payload: { parserState } });

                        } catch (error) {
                            postMessage({ type: 'error', payload: { message: 'Failed to parse the file. It might be corrupted or password-protected. Error: ' + error.message } });
                        }
                    };

                    reader.onerror = () => {
                        postMessage({ type: 'error', payload: { message: 'Failed to read the file.' } });
                    };
                    
                    reader.readAsArrayBuffer(file);
                };
            `;
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            return new Worker(URL.createObjectURL(blob));
        };

        // --- V39: Matching Web Worker ---
        let matcherWorker;
        const createMatcherWorker = () => {
            const workerCode = `
                const levenshteinDistance = ${levenshteinDistance.toString()};
                const analyzeVariance = ${analyzeVariance.toString()};
                const cleanAndStandardizeTB = ${cleanAndStandardizeTB.toString()};
                const aggregateTB = ${aggregateTB.toString()};
                
                self.onmessage = function(e) {
                    const { engagementData, oldAnnotationsMap } = e.data;
                    const oldAnnotations = new Map(oldAnnotationsMap);

                    let unmatchedCY = aggregateTB(cleanAndStandardizeTB(engagementData.currentYearTB));
                    let unmatchedPY = aggregateTB(cleanAndStandardizeTB(engagementData.priorYearTB));
                    const totalAccounts = (unmatchedCY.length + unmatchedPY.length) || 1;
                    let processedCount = 0;

                    const results = [];
                    const manualMappings = engagementData.manualMappings || [];

             manualMappings.forEach(([cyCode, pyCode]) => {
    const cyIndex = unmatchedCY.findIndex(item => item.code === cyCode);
    const pyIndex = unmatchedPY.findIndex(item => item.code === pyCode);
    if (cyIndex > -1 && pyIndex > -1) {
        const cy = unmatchedCY.splice(cyIndex, 1)[0];
        const py = unmatchedPY.splice(pyIndex, 1)[0];
        const oldAnn = oldAnnotations.get(cy.code) || {};
        
        // V60: Fix variance calculation for manual mappings
        const cyBalance = cy.hasOwnProperty('Final_signed_Closing_balance') ? cy.Final_signed_Closing_balance : cy.balance;
        const pyBalance = py.hasOwnProperty('Final_signed_Closing_balance') ? py.Final_signed_Closing_balance : py.balance;
        const status = Math.abs(cyBalance - pyBalance) < 1.00 ? 'Exact Match' : 'Variance';
        const analysis = analyzeVariance(cy, py, status, cyBalance, pyBalance);
        
        results.push({ 
            ...cy, balance: cyBalance, status: 'Manual Match', priorYearBalance: pyBalance, ...analysis,
            tickMark: oldAnn.tickMark || '', reviewStatus: oldAnn.reviewStatus || false,
            auditorComment: oldAnn.auditorComment || analysis.generatedComment || ''
        });
        processedCount += 2;
    }
});
                    
                    let tempUnmatchedCY = [...unmatchedCY];
                    unmatchedCY = [];

                    tempUnmatchedCY = tempUnmatchedCY.filter(cy => {
                        const pyIndex = unmatchedPY.findIndex(py => py.code === cy.code);
                        if (pyIndex > -1) {
                            const py = unmatchedPY.splice(pyIndex, 1)[0];
                            const oldAnn = oldAnnotations.get(cy.code) || {};
                            // V44: Use the final signed balance if it exists
                            const cyBalance = cy.hasOwnProperty('Final_signed_Closing_balance') ? cy.Final_signed_Closing_balance : cy.balance;
                            const pyBalance = py.hasOwnProperty('Final_signed_Closing_balance') ? py.Final_signed_Closing_balance : py.balance;
                            const status = Math.abs(cyBalance - pyBalance) < 1.00 ? 'Exact Match' : 'Variance';
                            const analysis = analyzeVariance(cy, py, status, cyBalance, pyBalance);
                            
                            let finalStatus = status;
                            if(status === 'Exact Match' && Math.abs(cyBalance - pyBalance) > 0.01) {
                                finalStatus = 'Rounding Difference';
                            }
                            
                            let reviewStatus = oldAnn.reviewStatus || false;

                            results.push({
                                ...cy, balance: cyBalance, status: finalStatus, priorYearBalance: pyBalance, ...analysis,
                                tickMark: oldAnn.tickMark || '', reviewStatus: reviewStatus,
                                auditorComment: oldAnn.auditorComment || analysis.generatedComment || ''
                            });
                            processedCount += 2;
                            return false;
                        }
                        return true;
                    });
                    self.postMessage({ type: 'progress', progress: processedCount / totalAccounts });

                    tempUnmatchedCY = tempUnmatchedCY.filter(cy => {
                        let bestMatch = null; let high_score = 65; let bestPyIndex = -1;
                        unmatchedPY.forEach((py, pyIndex) => {
                            const distance = levenshteinDistance(cy.name, py.name);
                            const score = Math.round((1 - distance / Math.max(cy.name.length, py.name.length)) * 100);
                            if (score > high_score) { high_score = score; bestMatch = py; bestPyIndex = pyIndex; }
                        });

                        if (bestMatch) {
                            const py = unmatchedPY.splice(bestPyIndex, 1)[0];
                            const oldAnn = oldAnnotations.get(cy.code) || {};
                            const cyBalance = cy.hasOwnProperty('Final_signed_Closing_balance') ? cy.Final_signed_Closing_balance : cy.balance;
                            const pyBalance = py.hasOwnProperty('Final_signed_Closing_balance') ? py.Final_signed_Closing_balance : py.balance;
                            const analysis = analyzeVariance(cy, bestMatch, 'Close Match', cyBalance, pyBalance);
                            results.push({
                                ...cy, balance: cyBalance, status: \`Confident Match (\${high_score}%)\`, priorYearBalance: pyBalance, ...analysis,
                                tickMark: oldAnn.tickMark || '', reviewStatus: oldAnn.reviewStatus || false,
                                auditorComment: oldAnn.auditorComment || analysis.generatedComment || ''
                            });
                            processedCount+=2;
                            return false;
                        }
                        return true;
                    });
                     self.postMessage({ type: 'progress', progress: processedCount / totalAccounts });

                    tempUnmatchedCY.forEach(cy => {
                         const oldAnn = oldAnnotations.get(cy.code) || {};
                         const cyBalance = cy.hasOwnProperty('Final_signed_Closing_balance') ? cy.Final_signed_Closing_balance : cy.balance;
                         const analysis = analyzeVariance(cy, null, 'New Account', cyBalance, null);
                         results.push({ ...cy, balance: cyBalance, status: 'New Account', priorYearBalance: null, ...analysis,
                            tickMark: oldAnn.tickMark || '', reviewStatus: oldAnn.reviewStatus || false,
                            auditorComment: oldAnn.auditorComment || analysis.generatedComment || ''});
                    });
                    unmatchedPY.forEach(py => {
                         const oldAnn = oldAnnotations.get(py.code) || {};
                         const pyBalance = py.hasOwnProperty('Final_signed_Closing_balance') ? py.Final_signed_Closing_balance : py.balance;
                         const analysis = analyzeVariance(py, null, 'Prior Year Only', null, pyBalance);
                         results.push({ ...py, status: 'Prior Year Only', balance: null, priorYearBalance: pyBalance, ...analysis,
                             tickMark: oldAnn.tickMark || '', reviewStatus: oldAnn.reviewStatus || false,
                             auditorComment: oldAnn.auditorComment || analysis.generatedComment || ''});
                    });
                    
                    self.postMessage({ type: 'complete', results: results });
                };
            `;
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            return new Worker(URL.createObjectURL(blob));
        };

        // --- Application State Manager ---
        const appState = {
            currentEngagement: null,
            activeTab: 'dashboard',
            isFilterUIVisible: false,
            columnFilters: {},
            searchTerm: '',
            selectedRows: new Set(),
            bulkSelectionScope: 'page', // 'page', 'all', 'custom'
            bulkSelectionCustomRange: { start: 1, end: 1 },
            manualMapping: { cy: null, py: null },
            isDraggingScrollbar: false,
            scrollDragStartX: 0,
            scrollDragStartScrollLeft: 0,
            tableResizeObserver: null,
            parserState: {},
            isMatchingInProgress: false,
            draggedTickItem: null,
            appConfiguration: null,
            currentPage: 1,
            pageSize: 100,
            filteredResultsCache: [],
            savedProfiles: [],
            isReviewTabInitialized: false, 
            recentlyUsedSymbols: JSON.parse(localStorage.getItem('recentlyUsedSymbols')) || [],
            saveIndicatorTimeout: null,
        };

        // --- DOM Element Selection ---
        const engagementCreationContainer = document.getElementById('engagement-creation-container');
        const engagementForm = document.getElementById('engagement-form');
        const clientNameInput = document.getElementById('client-name');
        const engagementYearInput = document.getElementById('engagement-year');
        const engagementYearLabel = document.getElementById('engagement-year-label');
        const createButton = document.getElementById('create-engagement-btn');
        const processingBar = document.getElementById('processing-bar');
        const processingBarContent = document.getElementById('processing-bar-content');
        const processingBarText = document.getElementById('processing-bar-text');
        const cancelProcessingBtn = document.getElementById('cancel-processing-btn');
        const recentEngagementsList = document.getElementById('recent-engagements-list');
        const mainAppContainer = document.getElementById('main-app-container');
        const backToEngagementsBtn = document.getElementById('back-to-engagements-btn');
        const engagementTitleContext = document.getElementById('engagement-title-context');
        const engagementWorkspaceTitleDashboard = document.getElementById('engagement-workspace-title-dashboard');
        const navTabsContainer = document.querySelector('.nav-tabs');
        const createTestDataBtn = document.getElementById('create-test-data-btn');
        const uploadedFilesContainer = document.getElementById('uploaded-files-container');
        const dashboardStatusContainer = document.getElementById('dashboard-status-container');
        const statTotalAccounts = document.getElementById('stat-total-accounts');
        const statExactMatches = document.getElementById('stat-exact-matches');
        const statVariances = document.getElementById('stat-variances');
        const statReviewedCount = document.getElementById('stat-reviewed-count');
        const autoMatchBtn = document.getElementById('auto-match-btn');
        const matchingWarningBanner = document.getElementById('matching-warning-banner');
        const matchingSuccessBanner = document.getElementById('matching-success-banner');
        const reviewTableContainer = document.getElementById('review-table-container');
        const reviewProgressContainer = document.getElementById('review-progress-container');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        const generateExcelBtn = document.getElementById('generate-excel-btn');
        const reportOptionsBtn = document.getElementById('report-options-btn');
        const reportOptionsDropdown = document.getElementById('report-options-dropdown');
        const paperSummaryGrid = document.getElementById('paper-summary-grid');
        const uploadDropzone = document.getElementById('upload-dropzone');
        const fileInput = document.getElementById('file-input');
        const browseFilesBtn = document.getElementById('browse-files-btn');
        const yearTypeRadios = document.querySelector('.year-type-group');
        const tooltip = document.getElementById('tooltip');
        const filterPopup = document.getElementById('filter-popup');
        const reviewActionsContainer = document.getElementById('review-actions-container');
        const filterShortcutHint = document.getElementById('filter-shortcut-hint');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconSun = document.getElementById('theme-icon-sun');
        const themeIconMoon = document.getElementById('theme-icon-moon');
        const headerRight = document.querySelector('.header-right .app-context');
        const exportEngagementBtn = document.getElementById('export-engagement-btn');
        const importEngagementBtn = document.getElementById('import-engagement-btn');
        const importFileInput = document.getElementById('import-file-input');
        const applyMaterialityCheckbox = document.getElementById('apply-materiality-checkbox');
        const materialityInputContainer = document.getElementById('materiality-input-container');
        const materialityThresholdInput = document.getElementById('materiality-threshold-input');
        const reviewSearchInput = document.getElementById('review-search-input');
        const dashboardGrid = document.getElementById('dashboard-grid');
        const bulkActionsContainer = document.getElementById('bulk-actions-container');
        const bulkActionSelect = document.getElementById('bulk-action-select');
        const bulkActionApplyBtn = document.getElementById('bulk-action-apply-btn');
        const auditConclusionTextarea = document.getElementById('audit-conclusion-textarea');
        const discussionPointsTextarea = document.getElementById('discussion-points-textarea');
        const preparedByInput = document.getElementById('prepared-by-input');
        const preparedDateInput = document.getElementById('prepared-date-input');
        const reviewedByInput = document.getElementById('reviewed-by-input');
        const reviewedDateInput = document.getElementById('reviewed-date-input');
        const mapUnmatchedBtn = document.getElementById('map-unmatched-btn');
        const mappingModal = document.getElementById('manual-mapping-modal');
        const closeMappingModalBtn = document.getElementById('close-mapping-modal-btn');
        const saveMappingBtn = document.getElementById('save-mapping-btn');
        const unmatchedCYList = document.getElementById('unmatched-cy-list');
        const unmatchedPYList = document.getElementById('unmatched-py-list');
        const parserWizardModal = document.getElementById('parser-wizard-modal');
        const parserWizardTitle = document.getElementById('parser-wizard-title');
        const parserWizardCloseBtn = document.getElementById('parser-wizard-close-btn');
        const splitCombinedCheckbox = document.getElementById('split-combined-checkbox');
        const useInferenceCheckbox = document.getElementById('use-inference-checkbox');
        const parserStep0 = document.getElementById('parser-step-0');
        const parserStep1 = document.getElementById('parser-step-1');
        const parserStep2 = document.getElementById('parser-step-2');
        const columnMappingContainer = document.getElementById('column-mapping-container');
        const parserPreviewSummary = document.getElementById('parser-preview-summary');
        const parserPreviewTable = document.getElementById('parser-preview-table');
        const parserWizardBackBtn = document.getElementById('parser-wizard-back-btn');
        const parserWizardNextBtn = document.getElementById('parser-wizard-next-btn');
        const parserWizardConfirmBtn = document.getElementById('parser-wizard-confirm-btn');
        const tickManagerSidebar = document.getElementById('tick-manager-sidebar');
        const tickManagerOverlay = document.getElementById('tick-manager-sidebar-overlay');
        const tickManagerCloseBtn = document.getElementById('tick-manager-close-btn');
        const tickManagerForm = document.getElementById('tick-manager-form');
        const tickManagerEditId = document.getElementById('tick-manager-edit-id');
        const tickManagerSymbolInput = document.getElementById('tick-manager-symbol-input');
        const tickManagerDescInput = document.getElementById('tick-manager-desc-input');
        const tickManagerSaveBtn = document.getElementById('tick-manager-save-btn');
        const tickManagerListContainer = document.getElementById('tick-manager-list-container');
        const tickInsertionPointGroup = document.getElementById('tick-insertion-point-group');
        const tickFormatStyleGroup = document.getElementById('tick-format-style-group');
        const tickSeparatorSelect = document.getElementById('tick-separator-select');
        const symbolPickerBtn = document.getElementById('tick-manager-symbol-picker-btn');
        const symbolPickerPopup = document.getElementById('symbol-picker-popup');
        const paginationContainer = document.getElementById('pagination-container');
        const importProfileSelect = document.getElementById('import-profile-select');
        const manageProfilesBtn = document.getElementById('manage-profiles-btn');
        const profileManagerModal = document.getElementById('profile-manager-modal');
        const profileManagerCloseBtn = document.getElementById('profile-manager-close-btn');
        const profileManagerListContainer = document.getElementById('profile-manager-list-container');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const parserSheetSelector = document.getElementById('parser-sheet-selector');
        const parserHealthCheckSummary = document.getElementById('parser-health-check-summary');
        // V58: New DOM Elements
        const privacyShieldBtn = document.getElementById('privacy-shield-btn');
        const privacyModal = document.getElementById('privacy-modal');
        const errorModal = document.getElementById('error-modal');
        const sessionRecoveryModal = document.getElementById('session-recovery-modal');
        const saveStatusContainer = document.getElementById('save-status-container');
        const saveStatusIndicator = document.getElementById('save-status-indicator');
        const lastSavedTimestamp = document.getElementById('last-saved-timestamp');

        // --- V49: Review Table Configuration "Blueprint" ---
        const TABLE_CONFIG = [
            {
                id: 'bulk-select',
                type: 'bulk-select',
                isEditable: true,
                isSortable: false,
                width: '50px',
            },
            {
                id: 'code',
                key: 'code',
                label: 'Account Code',
                type: 'text',
                isSortable: true,
                width: '150px',
                divider: 'category',
                dataType: 'string',
            },
            {
                id: 'name',
                key: 'name',
                label: 'Account Name',
                type: 'text',
                isSortable: true,
                width: '250px',
                textAlign: 'left',
                dataType: 'string',
            },
            {
                id: 'priorYearBalance',
                key: 'priorYearBalance',
                label: 'Prior Balance',
                type: 'currency',
                isSortable: true,
                width: '180px',
                textAlign: 'right',
                divider: 'thick-internal',
                dataType: 'number',
            },
            {
                id: 'balance',
                key: 'balance',
                label: 'Opening Balance',
                type: 'currency',
                isSortable: true,
                width: '180px',
                textAlign: 'right',
                dataType: 'number',
            },
            {
                id: 'variance',
                key: 'variance',
                label: 'Variance',
                type: 'currency',
                isSortable: true,
                width: '180px',
                textAlign: 'right',
                dataType: 'number',
            },
            {
                id: 'status',
                key: 'status',
                label: 'Status',
                type: 'status-badge',
                isSortable: true,
                width: '180px',
                divider: 'category',
                dataType: 'categorical', 
            },
            {
                id: 'assertion',
                key: 'assertion',
                label: 'Assertion',
                type: 'text',
                isSortable: true,
                width: '150px',
                dataType: 'categorical', 
            },
            {
                id: 'suggestedCause',
                key: 'suggestedCause',
                label: 'Possible Causes',
                type: 'suggestion',
                isSortable: false,
                width: '200px',
                textAlign: 'left',
                dataType: 'categorical', 
            },
            {
                id: 'tickMark',
                key: 'tickMark',
                label: 'Tick Mark',
                type: 'tick-select',
                isEditable: true,
                isSortable: true,
                width: '100px',
                divider: 'thick-internal',
                dataType: 'categorical', 
            },
            {
                id: 'auditorComment',
                key: 'auditorComment',
                label: "Auditor's Comments",
                tooltip: "It can include Auditor's Observations, Findings, Notes, and Conclusion.",
                type: 'textarea',
                isEditable: true,
                isSortable: false,
                width: '300px',
                textAlign: 'left',
                dataType: 'string',

            },
            {
                id: 'reviewStatus',
                key: 'reviewStatus',
                label: 'Reviewed',
                type: 'checkbox',
                isEditable: true,
                isSortable: true,
                width: '100px',
                dataType: 'boolean',
            }
        ];


        // --- Core Functions (now async where DB is used) ---
        const getFromStorage = async (key) => await DB.get(key);
        
        // V58: New save function wrapper to provide UI feedback
        const saveAndNotify = async (key, value) => {
            try {
                await DB.save(key, value);
                updateSaveStatus();
            } catch (error) {
                handleCriticalError(error, `Failed to save data for key: ${key}`);
            }
        };

        const createDefaultEngagementData = () => ({
            currentYearTB: [], priorYearTB: [], currentYearTB_filename: null, priorYearTB_filename: null,
            matchingResults: null, manualMappings: [], applyMateriality: false, materialityThreshold: null,
            auditConclusion: '', discussionPoints: '',
            preparedBy: '', preparedDate: '', reviewedBy: '', reviewedDate: '',
            parserSettings: { useInference: false, splitCombined: false, }
        });
        
        const createDefaultAppConfiguration = () => {
             const defaultSettings = () => ({ insertionPoint: 'top', formatStyle: 'bullet', separator: '\n\n' });
            return {
                tickMarkDefinitions: [
                    { id: 1, symbol: '✓', description: 'Agreed to supporting documentation', settings: defaultSettings() },
                    { id: 2, symbol: '✗', description: 'Exception noted - see comments', settings: defaultSettings() },
                    { id: 3, symbol: '○', description: 'Circled for follow-up', settings: defaultSettings() },
                    { id: 4, symbol: 'TB', description: 'Traced to trial balance', settings: defaultSettings() },
                    { id: 5, symbol: 'PY', description: 'Agreed to prior year working papers', settings: defaultSettings() },
                    { id: 6, symbol: 'ADJ', description: 'Adjustment required', settings: defaultSettings() },
                    { id: 7, symbol: 'NM', description: 'Difference is not material', settings: defaultSettings() },
                    { id: 8, symbol: 'REV', description: 'Reviewed by senior', settings: defaultSettings() },
                ],
                importProfiles: [],
            }
        };

        // --- V47: Import Profile Management ---
        const loadProfiles = async () => {
            const config = await getFromStorage('app_configuration');
            appState.savedProfiles = config.importProfiles || [];
            renderProfileSelectors();
        };

        const renderProfileSelectors = () => {
            const profiles = appState.savedProfiles;
            importProfileSelect.innerHTML = `<option value="">-- Default (Auto-detect) --</option>`;
            profiles.forEach(p => {
                const option = document.createElement('option'); option.value = p.id; option.textContent = p.name;
                importProfileSelect.appendChild(option);
            });
        };
        
        const saveCurrentProfile = async () => {
            const profileName = prompt("Enter a name for this import profile:", `Profile for ${appState.parserState.fileName}`);
            if (!profileName) return;

            const config = await getFromStorage('app_configuration');
            if (!config.importProfiles) config.importProfiles = [];

            const userColumnMap = {};
            columnMappingContainer.querySelectorAll('.column-map-select').forEach(select => {
                if(select.value) userColumnMap[select.value] = parseInt(select.dataset.colIndex);
            });

            const newProfile = {
                id: Date.now(), name: profileName.trim(),
                settings: {
                    columnMap: userColumnMap, headerRowIndex: appState.parserState.headerRowIndex,
                    splitCombined: splitCombinedCheckbox.checked, useInference: useInferenceCheckbox.checked
                }
            };
            
            config.importProfiles.push(newProfile);
            await saveAndNotify('app_configuration', config);
            await loadProfiles();
            alert(`Profile "${newProfile.name}" saved successfully.`);
        };
        
        const deleteProfile = async (profileId) => {
            if (!confirm("Are you sure you want to delete this profile?")) return;
            const config = await getFromStorage('app_configuration');
            config.importProfiles = config.importProfiles.filter(p => p.id !== profileId);
            await saveAndNotify('app_configuration', config);
            await loadProfiles();
            renderProfileManager();
        };
        
        const renderProfileManager = () => {
            const profiles = appState.savedProfiles;
            if (profiles.length === 0) {
                profileManagerListContainer.innerHTML = `<div class="empty-state-card" style="padding: 2rem;"><h3>No saved profiles yet.</h3><p>You can save a profile from the import wizard after mapping columns.</p></div>`;
                return;
            }
            profileManagerListContainer.innerHTML = `<ul class="profile-list">${profiles.map(p => `
                <li class="profile-item" data-id="${p.id}">
                    <span>${p.name}</span>
                    <button class="btn btn-minimal btn-danger profile-delete-btn">Delete</button>
                </li>`).join('')}</ul>`;
        };


        const renderRecentEngagements = async () => {
            const engagements = await getFromStorage('engagements') || [];
            const recentEngagementsCard = document.getElementById('recent-engagements-card');
            recentEngagementsList.innerHTML = ''; 
            if (engagements.length > 0) {
                engagements.sort((a, b) => b.id - a.id).forEach(eng => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="engagement-link-wrapper">
                            <a href="#" class="engagement-link" data-engagement-id="${eng.id}">${eng.clientName} (${eng.engagementYear})</a>
                            <button class="delete-engagement-btn" data-engagement-id="${eng.id}" data-tooltip="Delete Engagement">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                            </button>
                        </div>
                    `;
                    recentEngagementsList.appendChild(li);
                });
                recentEngagementsCard.classList.remove('hidden');
            } else {
                recentEngagementsCard.classList.add('hidden');
            }
        };

        const saveEngagement = async (newEngagement) => {
            const engagements = await getFromStorage('engagements') || [];
            if (!engagements.some(e => e.id === newEngagement.id)) {
                engagements.push(newEngagement);
                await saveAndNotify('engagements', engagements);
            }
        };
        
        const showAppWorkspace = async (engagement) => {
            if (!engagement) return;
            appState.currentEngagement = engagement;
            appState.columnFilters = {};
            appState.searchTerm = '';
            appState.selectedRows.clear();
            appState.bulkSelectionScope = 'page';
            appState.isFilterUIVisible = false;
            await saveAndNotify('currentEngagement', engagement);
            const title = `${engagement.clientName} (${engagement.engagementYear})`;
            engagementTitleContext.textContent = title;
            engagementWorkspaceTitleDashboard.textContent = `${engagement.clientName} - ${engagement.engagementYear}`;
            mainAppContainer.classList.remove('hidden');
            document.getElementById('homepage-actions').classList.add('hidden');
            engagementCreationContainer.classList.add('hidden');
            document.body.classList.remove('modal-open');
            headerRight.appendChild(themeToggle);
            saveStatusContainer.classList.remove('hidden');
            await setActiveTab(await getFromStorage('activeTab') || 'dashboard', true);
        };
        
        const setActiveTab = async (tabId, isInitialLoad = false) => {
            appState.activeTab = tabId;
            if(!isInitialLoad) await saveAndNotify('activeTab', tabId);
            navTabsContainer.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.toggle('hidden', pane.id !== `${tabId}-content`);
            });
            
            if (appState.isFilterUIVisible) toggleFilterUI();
            
            updateBulkActionsUI();
            destroyFixedScrollbar();

            if (appState.currentEngagement) {
                 if (tabId === 'dashboard') await updateDashboard(appState.currentEngagement.id);
                 else if (tabId === 'upload') await renderUploadedFiles(appState.currentEngagement.id);
                 else if (tabId === 'matching') await updateMatchingTabUI(appState.currentEngagement.id);
                 else if (tabId === 'review') await filterAndRenderReviewTable();
                 else if (tabId === 'paper') await updateWorkingPaperTabUI(appState.currentEngagement.id);
            }
            
            if (tabId === 'review') {
                createFixedScrollbar();
            }
        };
        
        const showCreationView = async () => {
            appState.currentEngagement = null;
            appState.activeTab = 'dashboard';
            await DB.delete('currentEngagement');
            await DB.delete('activeTab');
            await saveAndNotify('session_in_progress', false); // Graceful exit
            mainAppContainer.classList.add('hidden');
            document.getElementById('homepage-actions').classList.remove('hidden');
            engagementCreationContainer.classList.remove('hidden');
            document.body.classList.remove('modal-open');
            saveStatusContainer.classList.add('hidden');
            await renderRecentEngagements();
            destroyFixedScrollbar();
        };

        const getEngagementDataKey = (engagementId) => `engagementData_${engagementId}`;

        const generateTestData = async (engagementId) => {
            const dataKey = getEngagementDataKey(engagementId);
            let engagementData = await getFromStorage(dataKey);
            if (engagementData?.currentYearTB?.length > 0 && !confirm("Test data already exists. Overwrite it?")) return;
            
            const priorYearTB = [
                { code: '1010', name: 'Cash on Hand', balance: 50000.00 }, { code: '1200', name: 'Accounts Receivable', balance: 150000.00 }, { code: '1400', name: 'Inventory', balance: 300000.00 }, { code: '1600', name: 'Fixed Assets - Machinery', balance: 100000.00 }, { code: '2010', name: 'Accounts Payable', balance: -80000.00 }, { code: '2200', name: 'Accrued Liabilities', balance: -45000.00 }, { code: '2300', name: 'Short-term Loan', balance: -50000.00 }, { code: '3010', name: 'Common Stock', balance: -200000.00 }, { code: '3100', name: 'Retained Earnings', balance: -250000.00 }
            ];
            const currentYearTB = [
                { code: '1010', name: 'Cash on Hand', balance: 50000.00 }, { code: '1200', name: 'Trade Receivable', balance: 155000.00 }, { code: '1400', name: 'Stock', balance: 300000.00 }, { code: '1501', name: 'Prepaid Insurance', balance: 25000.00 }, { code: '1700', name: 'Goodwill', balance: 50000.00 }, { code: '2010', name: 'Trade Payables', balance: -80000.00 }, { code: '2200', name: 'Accrued Liabilities', balance: -45000.00 }, { code: '2300', name: 'Short-term Loan', balance: -25000.00 }, { code: '3010', name: 'Common Stock', balance: -200000.00 }, { code: '3100', name: 'Retained Earnings', balance: -275000.00 }
            ];
            
            engagementData.currentYearTB = currentYearTB;
            engagementData.priorYearTB = priorYearTB;
            engagementData.currentYearTB_filename = 'Test Data';
            engagementData.priorYearTB_filename = 'Test Data';
            engagementData.matchingResults = null;

            await saveAndNotify(dataKey, engagementData);
            await updateDashboard(engagementId);
            await renderUploadedFiles(engagementId);
        };

        const renderUploadedFiles = async (engagementId) => {
            const data = await getFromStorage(getEngagementDataKey(engagementId));
            if (!data || (!data.currentYearTB && !data.priorYearTB)) {
                uploadedFilesContainer.innerHTML = `<div class="empty-state-card"><h3>No files uploaded yet</h3></div>`;
                return;
            }
            
            let html = '<ul class="uploaded-files-list">';
            if(data.currentYearTB?.length > 0) {
                const name = data.currentYearTB_filename || 'Data File';
                html += `<li class="uploaded-file-item"><div class="file-info"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.98 6.024a.75.75 0 01.02 1.06l-6.25 6.25a.75.75 0 01-1.08.02L4.025 8.597a.75.75 0 011.035-1.086l4.204 4.028 5.68-5.68a.75.75 0 011.06-.02z" clip-rule="evenodd" /></svg><span>Current Year TB (${name})</span></div><span class="file-status">${data.currentYearTB.length} Accounts</span></li>`;
            }
            if(data.priorYearTB?.length > 0) {
                const name = data.priorYearTB_filename || 'Data File';
                html += `<li class="uploaded-file-item"><div class="file-info"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.98 6.024a.75.75 0 01.02 1.06l-6.25 6.25a.75.75 0 01-1.08.02L4.025 8.597a.75.75 0 011.035-1.086l4.204 4.028 5.68-5.68a.75.75 0 011.06-.02z" clip-rule="evenodd" /></svg><span>Prior Year TB (${name})</span></div><span class="file-status">${data.priorYearTB.length} Accounts</span></li>`;
            }
            html += '</ul>';
            uploadedFilesContainer.innerHTML = html;
        };
        
        const updateDashboard = async (engagementId) => {
            const data = await getFromStorage(getEngagementDataKey(engagementId));
            if (!data) {
                statTotalAccounts.textContent = "0"; statExactMatches.textContent = "0"; statVariances.textContent = "0"; statReviewedCount.textContent = "0";
                dashboardStatusContainer.innerHTML = `<div class="empty-state-card"><h3>No trial balances uploaded yet</h3></div>`;
                reviewProgressContainer.innerHTML = `<div class="empty-state-card" style="padding: 2rem;"><h3>No data to review</h3></div>`;
                return;
            }

            const hasCY = data.currentYearTB?.length > 0;
            const hasPY = data.priorYearTB?.length > 0;
            const accountCount = data.matchingResults ? data.matchingResults.length : (hasCY ? data.currentYearTB.length : 0);
            statTotalAccounts.textContent = accountCount;

            if (data.matchingResults) {
                const results = data.matchingResults;
                const matches = results.filter(r => r.status === 'Exact Match').length;
                const variances = results.filter(r => r.status === 'Variance').length;
                const reviewed = results.filter(r => r.reviewStatus).length;

                statExactMatches.textContent = matches;
                statVariances.textContent = variances;
                statReviewedCount.textContent = reviewed;
                dashboardStatusContainer.innerHTML = `<div class="alert-banner success" style="margin:0;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Matching complete: ${matches} matches, ${variances} variances. ${reviewed} items reviewed.</span></div>`;
                
                await renderReviewProgress(engagementId);
            } else {
                statExactMatches.textContent = "0"; statVariances.textContent = "0"; statReviewedCount.textContent = "0";
                if (hasCY && hasPY) {
                    dashboardStatusContainer.innerHTML = `<div class="alert-banner info" style="margin:0;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg><span>Trial balances loaded. Run Auto-Matching to see results.</span></div>`;
                } else {
                    dashboardStatusContainer.innerHTML = `<div class="empty-state-card"><h3>No trial balances uploaded yet</h3></div>`;
                }
                reviewProgressContainer.innerHTML = `<div class="empty-state-card" style="padding: 2rem;"><h3>Run matching to see progress</h3></div>`;
            }
        };
        const renderReviewProgress = async (engagementId) => {
            const data = await getFromStorage(getEngagementDataKey(engagementId));
            if (!data || !data.matchingResults) {
                reviewProgressContainer.innerHTML = `<div class="empty-state-card" style="padding: 2rem;"><h3>Run matching to see progress</h3></div>`;
                return;
            }
            const categories = {
                'Exact Match': { total: 0, reviewed: 0, label: 'Exact Matches' }, 
                'Close Match': { total: 0, reviewed: 0, label: 'Close Matches' },
                'Variance': { total: 0, reviewed: 0, label: 'Variances' }, 
                'New Account': { total: 0, reviewed: 0, label: 'New Accounts' }, 
                'Prior Year Only': { total: 0, reviewed: 0, label: 'Prior Year Only' }
            };
            data.matchingResults.forEach(item => {
                if (categories[item.status]) {
                    categories[item.status].total++;
                    if (item.reviewStatus) categories[item.status].reviewed++;
                } else if(item.status.startsWith('Confident Match')) { // Catch "Confident Match (xx%)"
                    categories['Close Match'].total++;
                    if(item.reviewStatus) categories['Close Match'].reviewed++;
                }
            });
            let progressHTML = '';
            for (const key in categories) {
                const category = categories[key];
                if (category.total > 0) {
                    const percentage = (category.reviewed / category.total * 100).toFixed(0);
                    progressHTML += `
                        <div class="progress-item">
                            <label>${category.label}</label>
                            <div class="progress-bar-container"><div class="progress-bar" style="width: ${percentage}%;"></div></div>
                            <span>${category.reviewed} / ${category.total} (${percentage}%)</span>
                        </div>`;
                }
            }
            reviewProgressContainer.innerHTML = progressHTML || `<div class="empty-state-card" style="padding: 2rem;"><h3>No items to review.</h3></div>`;
        };



        const updateMatchingTabUI = async (engagementId) => {
            const data = await getFromStorage(getEngagementDataKey(engagementId));
            const hasData = data && data.currentYearTB?.length > 0 && data.priorYearTB?.length > 0;
            autoMatchBtn.disabled = !hasData || appState.isMatchingInProgress;
            matchingWarningBanner.classList.toggle('hidden', hasData);
            matchingSuccessBanner.classList.toggle('hidden', !data?.matchingResults);

            if (data) {
                applyMaterialityCheckbox.checked = data.applyMateriality === true;
                materialityThresholdInput.value = data.materialityThreshold || '';
                materialityInputContainer.classList.toggle('hidden', !applyMaterialityCheckbox.checked);
            } else {
                applyMaterialityCheckbox.checked = false;
                materialityThresholdInput.value = '';
                materialityInputContainer.classList.add('hidden');
            }
        };
        
        // Functions for worker - these will be serialized into the worker script.
        const levenshteinDistance = (s1 = '', s2 = '') => {
            s1 = s1.toLowerCase(); s2 = s2.toLowerCase(); const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) costs[j] = j;
                    else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        costs[j - 1] = lastValue; lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        };

        const analyzeVariance = (cyAccount, pyAccount, status, cyBalance, pyBalance) => {
            const name = cyAccount.name.toLowerCase();
            const analysis = { assertion: '', suggestedCause: '', generatedComment: '' };
             
            const variance = (cyBalance || 0) - (pyBalance || 0);

            if (status === 'Close Match') { analysis.assertion = 'Classification'; analysis.suggestedCause = 'Account names are similar but not identical. Verify if this is a reclassification.'; analysis.generatedComment = 'Account appears to be a reclassification. Verified nature of change.'; }
            else if (status === 'New Account') { analysis.assertion = 'Completeness / Classification'; analysis.suggestedCause = 'New account opened during the period.'; analysis.generatedComment = 'New account opened during the period. Verified opening transaction.'; }
            else if (status === 'Prior Year Only') { analysis.assertion = 'Completeness'; analysis.suggestedCause = 'Account closed/disposed of during the period.'; analysis.generatedComment = 'Account closed/disposed of during the period. Verified.'; }
            else if (status === 'Variance') {
                if (pyBalance === 0) { analysis.assertion = 'Completeness / Classification'; analysis.suggestedCause = 'Possible new GL account or reclassification from a different account.'; }
                else if (cyBalance === 0) { analysis.assertion = 'Completeness'; analysis.suggestedCause = 'Account may have been disposed of or reclassified.'; }
                else if (name.includes('retained earnings')) { analysis.assertion = 'Accuracy'; analysis.suggestedCause = 'Movement likely due to prior year profit/loss allocation.'; analysis.generatedComment = 'Movement agrees to prior year audited profit.'; }
                else if (name.includes('loan') || name.includes('deposit') || name.includes('advance')) { analysis.assertion = 'Accuracy'; analysis.suggestedCause = 'Normal business activity (e.g., repayment or new borrowing).'; analysis.generatedComment = 'Movement reflects normal business activity (e.g., repayment/new borrowing). No exceptions noted.'; }
                else { analysis.assertion = 'Accuracy'; analysis.suggestedCause = 'Investigate for potential prior period adjustment or error.'; }
            }
            
            analysis.variance = variance;
            return analysis;
        };

        const cleanAndStandardizeTB = (tb) => {
            if (!tb) return [];
            return tb.map(item => {
                const cleanedItem = { ...item };
                cleanedItem.code = String(item.code || '').trim(); 
                cleanedItem.name = String(item.name || '').trim().replace(/[\u0000-\u001F\u007F-\u009F]/g, ""); 
                if (!cleanedItem.name) return null;
                return cleanedItem;
            }).filter(Boolean);
        };
        const aggregateTB = (tb) => {
            if (!tb) return [];
            const filtered = tb.filter(item => !['total', 'sub-total', 'sub total'].some(kw => item.name.toLowerCase().includes(kw)));
            const mapping = new Map();
            filtered.forEach(item => {
                if (item.code) {
                    if (!mapping.has(item.code)) { mapping.set(item.code, { ...item, originalNames: [item.name] }); }
                    else { 
                        const existing = mapping.get(item.code); 
                        const balanceKey = item.hasOwnProperty('Final_signed_Closing_balance') ? 'Final_signed_Closing_balance' : 'balance';
                        existing[balanceKey] += item[balanceKey]; 
                        existing.originalNames.push(item.name); 
                    }
                } else { mapping.set(item.name, { ...item, originalNames: [item.name] }); }
            });
            return Array.from(mapping.values());
        };

        const runAutoMatching = async (engagementId) => {
            const dataKey = getEngagementDataKey(engagementId);
            let data = await getFromStorage(dataKey);
            if (!data || !data.currentYearTB || !data.priorYearTB || appState.isMatchingInProgress) return;
            if (data.matchingResults && !confirm("Matching results exist. Re-run? This will overwrite status but preserve your comments and tick marks.")) return;

            appState.isMatchingInProgress = true;
            navTabsContainer.querySelectorAll('.nav-tab').forEach(t => t.disabled = true);
            autoMatchBtn.disabled = true;

            let oldAnnotationsMap = [];
            if (data.matchingResults) {
                data.matchingResults.forEach(item => {
                    oldAnnotationsMap.push([item.code, { tickMark: item.tickMark, auditorComment: item.auditorComment, reviewStatus: item.reviewStatus }]);
                });
            }

            const dataForWorker = JSON.parse(JSON.stringify(data)); // Deep copy
            if (dataForWorker.parserSettings?.useInference) {
                dataForWorker.priorYearTB = intelligentBalanceInference(dataForWorker.priorYearTB);
                dataForWorker.currentYearTB = intelligentBalanceInference(dataForWorker.currentYearTB);
            }

            processingBarContent.classList.remove('hidden');
            cancelProcessingBtn.classList.remove('hidden');
            processingBar.classList.remove('hidden');
            processingBarText.textContent = "Starting matching engine...";

            matcherWorker = createMatcherWorker();
            matcherWorker.postMessage({ engagementData: dataForWorker, oldAnnotationsMap });

            matcherWorker.onmessage = async (e) => {
                const { type, progress, results } = e.data;
                if (type === 'progress') {
                    processingBarText.textContent = `Matching balances... ${Math.round(progress * 100)}% complete`;
                } else if (type === 'complete') {
                    try {
                        data.matchingResults = results;
                        
                        await saveAndNotify(dataKey, data);
                    
                        appState.columnFilters = {};
                        appState.currentPage = 1;
                        await updateDashboard(engagementId);
                        await updateMatchingTabUI(engagementId);
                        if (appState.activeTab === 'review') await filterAndRenderReviewTable();
                    } catch(err) {
                        handleCriticalError(err, "Failed to save the matching results. The dataset might be too large for your browser's storage.");
                    } finally {
                        appState.isMatchingInProgress = false;
                        navTabsContainer.querySelectorAll('.nav-tab').forEach(t => t.disabled = false);
                        processingBar.classList.add('hidden');
                        cancelProcessingBtn.classList.add('hidden');
                        matcherWorker.terminate();
                    }
                }
            };

            matcherWorker.onerror = (e) => {
                handleCriticalError(e, 'An unexpected error occurred during the matching process.');
                appState.isMatchingInProgress = false;
                navTabsContainer.querySelectorAll('.nav-tab').forEach(t => t.disabled = false);
                updateMatchingTabUI(engagementId);
                processingBar.classList.add('hidden');
                cancelProcessingBtn.classList.add('hidden');
            };
        };
        
        const filterAndRenderReviewTable = async () => {
            if (!appState.currentEngagement) return;
            const engagementId = appState.currentEngagement.id;
            const data = await getFromStorage(getEngagementDataKey(engagementId));
            
            if (!data || !data.matchingResults) {
                appState.filteredResultsCache = [];
                renderReviewTable([], data);
                renderPaginationControls();
                return;
            }
            
            let results = [...data.matchingResults];

            const searchTerm = appState.searchTerm.toLowerCase();
            if (searchTerm) {
                results = results.filter(item => 
                    String(item.code || '').toLowerCase().includes(searchTerm) ||
                    String(item.name || '').toLowerCase().includes(searchTerm)
                );
            }

            const filters = appState.columnFilters;
            if (Object.keys(filters).length > 0) {
                 results = results.filter(item => {
                    return Object.entries(filters).every(([key, filter]) => {
                        let itemValue = item[key];
                        if (key === 'variance') {
                             itemValue = (item.balance !== null && item.priorYearBalance !== null) ? item.balance - item.priorYearBalance : null;
                        }
                        
                        if (filter.type === 'text') {
                            const value = String(itemValue || '').toLowerCase();
                            const filterValue = String(filter.value || '').toLowerCase();
                            switch (filter.operator) {
                                case 'contains': return value.includes(filterValue);
                                case 'not_contains': return !value.includes(filterValue);
                                case 'equals': return value === filterValue;
                                case 'starts_with': return value.startsWith(filterValue);
                                default: return true;
                            }
                        } else if (filter.type === 'number') {
                            const value = parseFloat(itemValue);
                            const filterValue = parseFloat(filter.value);
                            if (itemValue === null || isNaN(value) || isNaN(filterValue)) return false;
                            switch (filter.operator) {
                                case 'eq': return value === filterValue;
                                case 'neq': return value !== filterValue;
                                case 'gt': return value > filterValue;
                                case 'lt': return value < filterValue;
                                case 'gte': return value >= filterValue;
                                case 'lte': return value <= filterValue;
                                default: return true;
                            }
                        } else if (filter.type === 'categorical' || filter.type === 'boolean') {
                            return filter.values.includes(String(itemValue || '')); // Handle blank/null
                        }
                        return true;
                    });
                });
            }
            
            reviewSearchInput.value = appState.searchTerm;
            appState.filteredResultsCache = results;
            renderReviewTable(results, data);
            renderPaginationControls();
            updateFixedScrollbar();
        };

        // --- V49: New Data-Driven Rendering Engine ---
        const renderReviewTable = (filteredData, engagementData) => {
            renderReviewActions(); // Render toolbar actions like filter buttons
            
            if (!filteredData || !engagementData) {
                reviewTableContainer.innerHTML = `<div class="empty-state-card"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="48" height="48"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6-2.292m0 0v14.25m0-14.25a8.967 8.967 0 00-6 2.292m6-2.292a8.967 8.967 0 016 2.292m0 0V18m-6-6h.008v.008H12V12z" /></svg><h3>No balance matches available</h3><p>Please run auto-matching first.</p></div>`;
                paginationContainer.classList.add('hidden');
                return;
            }

            const table = document.createElement('table');
            table.className = 'review-table';
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const docFragment = document.createDocumentFragment();

            // Render Headers from TABLE_CONFIG
            const headerRow1 = document.createElement('tr');
            // This part can be made dynamic in the future if needed
            headerRow1.innerHTML = `
                <th colspan="1">Bulk Actions</th>
                <th colspan="5" class="cell-category-divider">About the Trial Balance</th>
                <th colspan="6" class="cell-category-divider">Auditor & System Analysis</th>
            `;
            const headerRow2 = document.createElement('tr');
            TABLE_CONFIG.forEach(col => {
                const th = document.createElement('th');
                th.dataset.key = col.key || col.id;
                th.dataset.type = col.dataType || col.type;
                if (col.divider === 'category') th.classList.add('cell-category-divider');
                if (col.divider === 'thick-internal') th.classList.add('cell-thick-internal-divider');
                if (col.textAlign === 'left') th.classList.add('text-left-aligned');
                if (col.tooltip) th.dataset.tooltip = col.tooltip;

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'th-content';
                contentWrapper.textContent = col.label || '';
                
                if (col.type === 'bulk-select') {
                    contentWrapper.innerHTML = `<input type="checkbox" id="select-all-checkbox">`;
                }

                th.appendChild(contentWrapper);
                headerRow2.appendChild(th);
            });
            thead.appendChild(headerRow1);
            thead.appendChild(headerRow2);
            table.appendChild(thead);

            if (filteredData.length === 0) {
                 reviewTableContainer.innerHTML = `<div class="table-wrapper" style="border: none; box-shadow: none;"><table class="review-table"><thead>${thead.innerHTML}</thead><tbody><tr><td colspan="${TABLE_CONFIG.length}" style="text-align:center; padding: 2rem; border:none;">No items match your current filter criteria.</td></tr></tbody></table></div>`;
                 paginationContainer.classList.add('hidden');
                 renderFilterIcons();
                 return;
            }

            // Paginate results
            const startIndex = (appState.currentPage - 1) * appState.pageSize;
            const endIndex = startIndex + appState.pageSize;
            const pageResults = filteredData.slice(startIndex, endIndex);

            const currencyFormatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' });
            const tickMarkOptionsHTML = appState.appConfiguration.tickMarkDefinitions.map(opt => `<option value="${opt.symbol}">${opt.symbol}</option>`).join('');

            // Render Rows from Data + TABLE_CONFIG
            pageResults.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.code = item.code;
                const isSelected = appState.selectedRows.has(item.code);
                
                // Determine row class for styling
                const statusClass = `status-${item.status.toLowerCase().replace(/[\s%()]/g, '-')}`;
                row.classList.add(statusClass);
                if (engagementData.applyMateriality && engagementData.materialityThreshold > 0 && Math.abs(item.variance) > engagementData.materialityThreshold) {
                    row.classList.add('material-variance');
                }

                TABLE_CONFIG.forEach(col => {
                    const cell = document.createElement('td');
                    if (col.divider === 'category') cell.classList.add('cell-category-divider');
                    if (col.divider === 'thick-internal') cell.classList.add('cell-thick-internal-divider');
                    if (col.textAlign === 'left') cell.classList.add('text-left-aligned');
                    if (col.textAlign === 'right') cell.classList.add('text-right-aligned');

                    const value = item[col.key];

                    // Cell Renderer Logic
                    switch (col.type) {
                        case 'bulk-select':
                            cell.innerHTML = `<input type="checkbox" class="row-checkbox" data-code="${item.code}" ${isSelected ? 'checked' : ''}>`;
                            break;
                        case 'currency':
                            cell.textContent = value !== null ? currencyFormatter.format(value) : '—';
                            break;
                        case 'status-badge':
                            cell.innerHTML = `<span class="status-badge">${value}</span>`;
                            break;
                        case 'suggestion':
                             cell.innerHTML = value ? `<span class="suggestion-text">${value}</span>` : '';
                             break;
                        case 'tick-select':
                            cell.innerHTML = `<select data-code="${item.code}" data-field="tickMark"><option value=""></option>${tickMarkOptionsHTML}</select>`;
                            cell.querySelector('select').value = value || '';
                            break;
                        case 'textarea':
                            cell.innerHTML = `<textarea data-code="${item.code}" data-field="auditorComment" placeholder="Enter comments...">${value || ''}</textarea>`;
                            break;
                        case 'checkbox':
                            cell.innerHTML = `<input type="checkbox" ${value ? 'checked' : ''} data-code="${item.code}" data-field="reviewStatus">`;
                            break;
                        default:
                            cell.textContent = value || '';
                    }
                    row.appendChild(cell);
                });
                docFragment.appendChild(row);
            });
            
            tbody.appendChild(docFragment);
            table.appendChild(tbody);

            const wrapper = document.createElement('div');
            wrapper.className = 'table-wrapper';
            wrapper.appendChild(table);

            reviewTableContainer.innerHTML = '';
            reviewTableContainer.appendChild(wrapper);

            paginationContainer.classList.remove('hidden');
            renderFilterIcons();
            
            const bulkActionOptgroup = document.getElementById('bulk-action-ticks-optgroup');
            if(bulkActionOptgroup) bulkActionOptgroup.innerHTML = appState.appConfiguration.tickMarkDefinitions.map(opt => `<option value="tick_${opt.symbol}">${opt.symbol}</option>`).join('');

        };

        const renderPaginationControls = () => {
            const totalItems = appState.filteredResultsCache.length;
            if (totalItems <= appState.pageSize && appState.currentPage === 1) {
                paginationContainer.innerHTML = '';
                paginationContainer.classList.add('hidden');
                return;
            }

            const totalPages = Math.ceil(totalItems / appState.pageSize);
            const currentPage = totalPages === 0 ? 0 : appState.currentPage;

            paginationContainer.innerHTML = `
                <div class="pagination-status">
                    Showing <strong>${Math.min((currentPage - 1) * appState.pageSize + 1, totalItems)}</strong>-<strong>${Math.min(currentPage * appState.pageSize, totalItems)}</strong> of <strong>${totalItems}</strong> results (Page ${currentPage} of ${totalPages})
                </div>
                <div class="pagination-nav">
                    <button id="prev-page-btn" class="btn btn-minimal" ${currentPage <= 1 ? 'disabled' : ''}>&lt; Prev</button>
                    <button id="next-page-btn" class="btn btn-minimal" ${currentPage >= totalPages ? 'disabled' : ''}>Next &gt;</button>
                </div>
            `;
            paginationContainer.classList.remove('hidden');
        };
        
        const updateWorkingPaperTabUI = async (engagementId) => {
            const data = await getFromStorage(getEngagementDataKey(engagementId));
            const hasResults = data && data.matchingResults;
            generatePdfBtn.disabled = !hasResults;
            reportOptionsBtn.disabled = !hasResults;

            if (hasResults) {
                const { matchingResults, auditConclusion, discussionPoints, preparedBy, preparedDate, reviewedBy, reviewedDate } = data;
                auditConclusionTextarea.value = auditConclusion || '';
                discussionPointsTextarea.value = discussionPoints || '';
                preparedByInput.value = preparedBy || '';
                preparedDateInput.value = preparedDate || '';
                reviewedByInput.value = reviewedBy || '';
                reviewedDateInput.value = reviewedDate || '';

                const total = matchingResults.length;
                const matches = matchingResults.filter(r => r.status === 'Exact Match').length;
                const closeMatches = matchingResults.filter(r => r.status.startsWith('Confident Match')).length;
                const variances = matchingResults.filter(r => r.status === 'Variance').length;
                const reviewed = matchingResults.filter(r => r.reviewStatus).length;
                const completion = total > 0 ? (reviewed / total * 100).toFixed(0) : 0;
                paperSummaryGrid.innerHTML = `
                    <div class="stat-card"><div class="stat-info"><h4>Total Accounts</h4><p>${total}</p></div></div>
                    <div class="stat-card"><div class="stat-info"><h4>Exact Matches</h4><p>${matches}</p></div></div>
                    <div class="stat-card"><div class="stat-info"><h4>Close Matches</h4><p>${closeMatches}</p></div></div>
                    <div class="stat-card"><div class="stat-info"><h4>Variances</h4><p>${variances}</p></div></div>
                    <div class="stat-card"><div class="stat-info"><h4>Reviewed</h4><p>${reviewed}</p></div></div>
                    <div class="stat-card"><div class="stat-info"><h4>Completion</h4><p>${completion}%</p></div></div>`;
            } else {
                paperSummaryGrid.innerHTML = `<div class="empty-state-card" style="grid-column: 1 / -1; padding: 2rem;"><h3>No data to summarize.</h3><p>Please run auto-matching first.</p></div>`;
                 auditConclusionTextarea.value = '';
                 discussionPointsTextarea.value = '';
                 preparedByInput.value = '';
                 preparedDateInput.value = '';
                 reviewedByInput.value = '';
                 reviewedDateInput.value = '';
            }
        };

        const getReportData = async (engagementId) => {
            const engagements = await getFromStorage('engagements') || [];
            const engagement = engagements.find(e => e.id === engagementId);
            const data = await getFromStorage(getEngagementDataKey(engagementId));
            if (!engagement || !data || !data.matchingResults) return null;
            return { engagement, data };
        }

        const formatCurrencyForReport = (value) => {
            if (value === null || typeof value === 'undefined') return '—';
            const num = Number(value);
            if (isNaN(num)) return '—';
             const formatted = new Intl.NumberFormat('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(Math.abs(num));
            return num < 0 ? `(${formatted})` : formatted;
        };
        
        const addCustomFont = (doc) => {
            try {
                // In a real application, a base64 encoded font would be added here for full unicode support.
                // For this implementation, we will rely on standard fonts to keep the file size manageable.
            } catch (e) {
                console.warn("Could not add custom font. Special characters may not render correctly. Error: ", e);
            }
        };

        const generateWorkingPaperPDF = async (engagementId) => {
            const reportData = await getReportData(engagementId);
            if (!reportData) return;

            const { engagement, data } = reportData;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            
            addCustomFont(doc);

            const now = new Date();
            const tableBody = data.matchingResults.map(item => {
                let variance = null;
                if (item.status === 'New Account') {
                    variance = item.balance;
                } else if (item.status === 'Prior Year Only') {
                    variance = -item.priorYearBalance;
                } else if (item.balance !== null && item.priorYearBalance !== null) {
                    variance = item.balance - item.priorYearBalance;
                }

                return [
                    item.code,
                    item.name,
                    formatCurrencyForReport(item.priorYearBalance),
                    formatCurrencyForReport(item.balance),
                    formatCurrencyForReport(variance),
                    item.status,
                    item.auditorComment || ''
                ];
            });

            const addHeaderFooter = () => {
                doc.setFontSize(9);
                doc.setTextColor(150);
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 25, doc.internal.pageSize.height - 10);
                }
            };
            
            let finalY = 0;

            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text("Opening Balance Verification Working Paper (SA 510)", doc.internal.pageSize.width / 2, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Client: ${engagement.clientName}`, 15, 35);
            doc.text(`Year: ${engagement.engagementYear}`, 15, 40);
            doc.text(`Generated on: ${now.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' })}`, 15, 45);
            finalY = 55;
            
            if (data.discussionPoints && data.discussionPoints.trim() !== '') {
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text("Points for Discussion with Management", 15, finalY);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const discussionLines = doc.splitTextToSize(data.discussionPoints, doc.internal.pageSize.width - 30);
                doc.text(discussionLines, 15, finalY + 7);
                finalY += 12 + (discussionLines.length * 5);
            }

            if (data.auditConclusion && data.auditConclusion.trim() !== '') {
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text("Overall Audit Conclusion", 15, finalY);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const conclusionLines = doc.splitTextToSize(data.auditConclusion, doc.internal.pageSize.width - 30);
                doc.text(conclusionLines, 15, finalY + 7);
                finalY += 12 + (conclusionLines.length * 5);
            }
            
            doc.autoTable({
                head: [['Code', 'Account Name', 'Prior Balance (INR)', 'Opening Balance (INR)', 'Variance (INR)', 'Status', "Auditor's Comments"]],
                body: tableBody,
                startY: finalY + 5,
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80], textColor: 255, fontStyle: 'bold', halign: 'center', fontSize: 10 },
                styles: { fontSize: 9, cellPadding: 2, font: 'helvetica' },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 20 },
                    1: { halign: 'left', cellWidth: 60 },
                    2: { halign: 'right', cellWidth: 30 },
                    3: { halign: 'right', cellWidth: 30 },
                    4: { halign: 'right', cellWidth: 30 },
                    5: { halign: 'center', cellWidth: 30 },
                    6: { halign: 'left' }
                }
            });

            finalY = doc.autoTable.previous.finalY;

            const { preparedBy, preparedDate, reviewedBy, reviewedDate } = data;
            const shouldRenderSignOff = preparedBy || preparedDate || reviewedBy || reviewedDate;

            if (shouldRenderSignOff) {
                let signOffY = (finalY + 20 > doc.internal.pageSize.height - 30) ? 20 : finalY + 20;
                if (finalY + 20 > doc.internal.pageSize.height - 30) doc.addPage();

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text("Auditor Sign-Off", 15, signOffY);
                signOffY += 7;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                if (preparedBy || preparedDate) {
                    doc.text(`Prepared by: ${preparedBy || '________________'}`, 15, signOffY);
                    doc.text(`Date: ${preparedDate ? new Date(preparedDate + 'T00:00:00').toLocaleDateString('en-GB') : '________________'}`, 140, signOffY);
                    signOffY += 10;
                }
                
                if (reviewedBy || reviewedDate) {
                    doc.text(`Reviewed by: ${reviewedBy || '________________'}`, 15, signOffY);
                    doc.text(`Date: ${reviewedDate ? new Date(reviewedDate + 'T00:00:00').toLocaleDateString('en-GB') : '________________'}`, 140, signOffY);
                }
            }
            
            addHeaderFooter();
            const safeClientName = engagement.clientName.replace(/[\/\\?%*:|"<>]/g, '_');
            const safeYear = engagement.engagementYear.replace(/[\/\\?%*:|"<>]/g, '_');
            doc.save(`WorkingPaper_${safeClientName}_${safeYear}.pdf`);
        };
        
        const generateWorkingPaperExcel = async (engagementId) => {
            const reportData = await getReportData(engagementId);
            if (!reportData) return;
            const { engagement, data } = reportData;
            
            const moneyFormat = '₹ #,##0.00;[Red](₹ #,##0.00)';

            const summaryData = [
                ["Opening Balance Verification Working Paper (SA 510)"],
                [],
                ["Client Name:", engagement.clientName],
                ["Engagement Year:", engagement.engagementYear],
                ["Materiality Threshold:", data.materialityThreshold ? { t: 'n', v: data.materialityThreshold, z: moneyFormat } : 'N/A'],
                ["Report Generated On:", new Date().toLocaleDateString('en-GB')],
                [],
                ["Points for Discussion with Management"],
                [data.discussionPoints || "N/A"],
                [],
                ["Overall Audit Conclusion"],
                [data.auditConclusion || "No overall conclusion was entered."],
            ];
            
            const { preparedBy, preparedDate, reviewedBy, reviewedDate } = data;
            const shouldRenderSignOff = preparedBy || preparedDate || reviewedBy || reviewedDate;

            if (shouldRenderSignOff) {
                summaryData.push([]);
                summaryData.push(["Auditor Sign-Off"]);
                if (preparedBy || preparedDate) {
                    summaryData.push(["Prepared by:", preparedBy || "", "Date:", preparedDate ? new Date(preparedDate + 'T00:00:00').toLocaleDateString('en-GB') : ""]);
                }
                if (reviewedBy || reviewedDate) {
                    summaryData.push(["Reviewed by:", reviewedBy || "", "Date:", reviewedDate ? new Date(reviewedDate + 'T00:00:00').toLocaleDateString('en-GB') : ""]);
                }
            }

            const summary_ws = XLSX.utils.aoa_to_sheet(summaryData);
            summary_ws['!cols'] = [{ wch: 25 }, { wch: 40 }, {wch: 10}, {wch: 20}];
            const merges = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 3 } }, 
                { s: { r: 8, c: 0 }, e: { r: 8, c: 3 } },
                { s: { r: 11, c: 0 }, e: { r: 11, c: 3 } }
            ];
            if (shouldRenderSignOff) {
                merges.push({ s: { r: 13, c: 0 }, e: { r: 13, c: 3 } });
            }
            summary_ws["!merges"] = merges;

            const detailedJson = data.matchingResults.map((item, index) => {
                const rowIndex = index + 2;
                const priorBalance = item.priorYearBalance !== null ? item.priorYearBalance : 0;
                const openBalance = item.balance !== null ? item.balance : 0;
                
                let materialityFormula = `IF(ABS(E${rowIndex})>Summary!$B$5, "Yes", "No")`;
                if (!data.materialityThreshold) { materialityFormula = `"No"`; }

                return {
                    "Code": item.code,
                    "Account Name": item.name,
                    "Prior Balance": { t: 'n', v: priorBalance, z: moneyFormat },
                    "Opening Balance": { t: 'n', v: openBalance, z: moneyFormat },
                    "Variance": { t: 'n', f: `D${rowIndex}-C${rowIndex}`, z: moneyFormat },
                    "Is Material?": { t: 's', f: materialityFormula },
                    "Status": item.status,
                    "Auditor's Comments": item.auditorComment
                };
            });
            const detailed_ws = XLSX.utils.json_to_sheet(detailedJson, { cellDates: true });

            detailed_ws['!cols'] = [
                { wch: 15 }, { wch: 40 }, { wch: 20 }, { wch: 20 },
                { wch: 20 }, { wch: 15 }, { wch: 25 }, { wch: 50 }
            ];
            detailed_ws['!autofilter'] = { ref: `A1:H${detailedJson.length + 1}` };
            detailed_ws['!freeze'] = { ySplit: 1 };

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, summary_ws, "Summary");
            XLSX.utils.book_append_sheet(wb, detailed_ws, "Detailed Data");

            const safeClientName = engagement.clientName.replace(/[\/\\?%*:|"<>]/g, '_');
            const safeYear = engagement.engagementYear.replace(/[\/\\?%*:|"<>]/g, '_');
            XLSX.writeFile(wb, `WorkingPaper_Interactive_${safeClientName}_${safeYear}.xlsx`);
        };


        const saveNormalizedData = async (normalizedData, parserSettings) => {
            const dataKey = getEngagementDataKey(appState.currentEngagement.id);
            const engagementData = await getFromStorage(dataKey) || createDefaultEngagementData();
            const yearType = document.querySelector('#upload-content input[name="upload-year-type"]:checked').value;
            
            if (yearType === 'current') {
                engagementData.currentYearTB = normalizedData;
                engagementData.currentYearTB_filename = appState.parserState.fileName;
            } else {
                engagementData.priorYearTB = normalizedData;
                engagementData.priorYearTB_filename = appState.parserState.fileName;
            }
            engagementData.parserSettings = parserSettings;
            engagementData.matchingResults = null;

            await saveAndNotify(dataKey, engagementData);
            await renderUploadedFiles(appState.currentEngagement.id);
            await updateDashboard(appState.currentEngagement.id);
            await updateMatchingTabUI(appState.currentEngagement.id);
        };
        const exportEngagementData = async () => {
            if (!appState.currentEngagement) return;
            const engagementId = appState.currentEngagement.id;

            const allEngagements = await getFromStorage('engagements') || [];
            const engagementMetadata = allEngagements.find(e => e.id === engagementId);
            const engagementData = await getFromStorage(getEngagementDataKey(engagementId));

            if (!engagementMetadata || !engagementData) {
                alert("Could not find complete data for this engagement. Cannot export.");
                return;
            }

            const exportObject = {
                metadata: engagementMetadata,
                data: engagementData
            };
            
            const jsonString = JSON.stringify(exportObject, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            const a = document.createElement('a');
            const safeClientName = engagementMetadata.clientName.replace(/[\/\\?%*:|"<>]/g, '_');
            const safeYear = engagementMetadata.engagementYear.replace(/[\/\\?%*:|"<>]/g, '_');
            a.download = `OBT_${safeClientName}_${safeYear}.json`;
            a.href = window.URL.createObjectURL(blob);
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(a.href);
        };

        const handleFileImport = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                let parsed;
                try {
                    parsed = JSON.parse(e.target.result);
                } catch (error) {
                    handleCriticalError(error, "Import failed: The selected file is not valid JSON.");
                    return;
                }

                if (!parsed.metadata || !parsed.metadata.id || !parsed.data) {
                    showErrorModal("Import Failed", "The file does not have the required engagement data structure.");
                    return;
                }
                
                const { metadata, data } = parsed;
                
                const defaultData = createDefaultEngagementData();
                const completeData = { ...defaultData, ...data };

                await saveAndNotify(getEngagementDataKey(metadata.id), completeData);

                let engagements = await getFromStorage('engagements') || [];
                const existingIndex = engagements.findIndex(eng => eng.id === metadata.id);
                if (existingIndex > -1) {
                    engagements[existingIndex] = metadata;
                } else {
                    engagements.push(metadata);
                }
                await saveAndNotify('engagements', engagements);

                alert(`Engagement "${metadata.clientName} (${metadata.engagementYear})" imported successfully!`);
                await renderRecentEngagements();
            };

            reader.readAsText(file);
            event.target.value = '';
        };
        
        const toggleFilterUI = () => {
            appState.isFilterUIVisible = !appState.isFilterUIVisible;
            filterPopup.classList.add('hidden');
            filterAndRenderReviewTable();
        };
        
        const renderReviewActions = () => {
            reviewActionsContainer.innerHTML = '';
            
            const toggleBtn = document.createElement('button');
            toggleBtn.id = 'toggle-filter-btn';
            toggleBtn.className = 'btn';
            toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1.5A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"/></svg>`;
            toggleBtn.addEventListener('click', toggleFilterUI);
            reviewActionsContainer.appendChild(toggleBtn);
            
            if (Object.keys(appState.columnFilters).length > 0) {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'btn btn-danger';
                clearBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg><span>Clear All Filters</span>`;
                clearBtn.addEventListener('click', () => {
                    appState.currentPage = 1;
                    clearAllFilters();
                });
                reviewActionsContainer.appendChild(clearBtn);
            }
        }

        const renderFilterIcons = () => {
            renderReviewActions();
            const toggleBtn = document.getElementById('toggle-filter-btn');
            if(toggleBtn) toggleBtn.classList.toggle('active', appState.isFilterUIVisible);
            filterShortcutHint.classList.toggle('hidden', appState.isFilterUIVisible);

            const table = reviewTableContainer.querySelector('.review-table');
            if (!table) return;

            table.querySelectorAll('th[data-key]').forEach(th => {
                let contentWrapper = th.querySelector('.th-content');
                if (!contentWrapper) {
                    contentWrapper = document.createElement('div');
                    contentWrapper.className = 'th-content';
                    if (th.classList.contains('text-left-aligned')) {
                         contentWrapper.style.justifyContent = 'flex-start';
                    }
                    while(th.firstChild) contentWrapper.appendChild(th.firstChild);
                    th.appendChild(contentWrapper);
                }
                
                contentWrapper.querySelectorAll('.th-icon-btn').forEach(btn => btn.remove());
                
                let iconContainer = document.createElement('span');
                iconContainer.style.display = 'inline-flex';
                iconContainer.style.gap = '0.25rem';
                
                const columnConfig = TABLE_CONFIG.find(c => (c.key || c.id) === th.dataset.key);
                if (!columnConfig) return;

                if (columnConfig.id === 'tickMark') {
                    const managerBtn = document.createElement('button');
                    managerBtn.className = 'th-icon-btn';
                    managerBtn.dataset.tooltip = 'Manage Tick Marks';
                    managerBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1 .872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1-.872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1-.872-2.105l.34-.1c-1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1 .872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/></svg>`;
                    managerBtn.addEventListener('click', () => openTickMarkManager());
                    iconContainer.appendChild(managerBtn);
                }

                if (appState.isFilterUIVisible && columnConfig.dataType) { // Only show filter icon for filterable columns
                    const filterIcon = document.createElement('button');
                    filterIcon.className = 'th-icon-btn';
                    filterIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1.5A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"/></svg>`;
                    filterIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openFilterPopup(th);
                    });
                    filterIcon.classList.toggle('active', !!appState.columnFilters[th.dataset.key]);
                    iconContainer.appendChild(filterIcon);
                } 

                if(iconContainer.hasChildNodes()) {
                     contentWrapper.appendChild(iconContainer);
                }
            });
        };

        const openFilterPopup = async (th) => {
            const engagementData = await getFromStorage(getEngagementDataKey(appState.currentEngagement.id));
            if (!appState.filteredResultsCache) return;
            
            const key = th.dataset.key;
            const columnConfig = TABLE_CONFIG.find(c => c.key === key);
            if (!columnConfig) return;

            const type = columnConfig.dataType;
            const existingFilter = appState.columnFilters[key];
            const headerText = th.querySelector('.th-content').childNodes[0].textContent;
            
            const popupTitle = document.getElementById('filter-popup-title');
            const popupContent = document.getElementById('filter-popup-content');
            
            popupTitle.textContent = `Filter by ${headerText}`;
            let content = '';

            if (type === 'categorical' || type === 'boolean') {
                const uniqueValues = [...new Set(appState.filteredResultsCache.map(item => String(item[key] || '')))];
                let values = (type === 'boolean') ? ['true', 'false'] : uniqueValues.sort();
                
                const checkedValues = existingFilter?.values || values;
                const checklistItems = values.map(val => {
                    let displayVal = val;
                    if (val === '') { displayVal = '(Blank)'; }
                    if (key === 'reviewStatus') { displayVal = val === 'true' ? 'Reviewed' : 'Pending'; }
                    return `<label class="filter-popup-checklist-item"><input type="checkbox" value="${val}" ${checkedValues.includes(val) ? 'checked' : ''}> ${displayVal}</label>`;
                }).join('');
                
                content += `
                    <div class="filter-popup-checklist-search">
                        <input type="text" id="filter-checklist-search" placeholder="Search values...">
                    </div>
                    <label class="filter-popup-checklist-item"><input type="checkbox" id="filter-select-all"> <b>(Select All)</b></label>
                    <div class="filter-popup-checklist">${checklistItems}</div>`;

            } else if (type === 'string') {
                content += `
                    <div class="form-group">
                        <select id="filter-operator">
                            <option value="contains" ${existingFilter?.operator === 'contains' ? 'selected' : ''}>Contains</option>
                            <option value="not_contains" ${existingFilter?.operator === 'not_contains' ? 'selected' : ''}>Does not contain</option>
                            <option value="equals" ${existingFilter?.operator === 'equals' ? 'selected' : ''}>Equals</option>
                            <option value="starts_with" ${existingFilter?.operator === 'starts_with' ? 'selected' : ''}>Starts with</option>
                        </select>
                    </div>
                    <div class="form-group"><input type="text" id="filter-value" value="${existingFilter?.value || ''}" placeholder="Enter text..."></div>
                `;
            } else if (type === 'number') {
                content += `
                    <div class="form-group">
                        <select id="filter-operator">
                            <option value="eq" ${existingFilter?.operator === 'eq' ? 'selected' : ''}>= (Equals)</option>
                            <option value="neq" ${existingFilter?.operator === 'neq' ? 'selected' : ''}>≠ (Does not equal)</option>
                            <option value="gt" ${existingFilter?.operator === 'gt' ? 'selected' : ''}>&gt; (Greater than)</option>
                            <option value="lt" ${existingFilter?.operator === 'lt' ? 'selected' : ''}>&lt; (Less than)</option>
                            <option value="gte" ${existingFilter?.operator === 'gte' ? 'selected' : ''}>≥</option>
                            <option value="lte" ${existingFilter?.operator === 'lte' ? 'selected' : ''}>≤</option>
                        </select>
                    </div>
                    <div class="form-group"><input type="number" id="filter-value" value="${existingFilter?.value || ''}" placeholder="Enter number..."></div>
                `;
            }
            popupContent.innerHTML = content;
            filterPopup.classList.remove('hidden');

            const rect = th.getBoundingClientRect();
            const popupRect = filterPopup.getBoundingClientRect();
            let top = rect.bottom + 8;
            let left = rect.left;

            if (left + popupRect.width > window.innerWidth) left = window.innerWidth - popupRect.width - 8;
            if (left < 8) left = 8;
            if (top + popupRect.height > window.innerHeight) top = rect.top - popupRect.height - 8;

            filterPopup.style.top = `${top}px`;
            filterPopup.style.left = `${left}px`;

            document.getElementById('filter-popup-apply-btn').onclick = () => applyColumnFilter(key, type);
            document.getElementById('filter-popup-clear-btn').onclick = () => clearColumnFilter(key);
            document.getElementById('filter-popup-close-btn').onclick = () => filterPopup.classList.add('hidden');
            
            if (type === 'categorical' || type === 'boolean') {
                 const searchInput = document.getElementById('filter-checklist-search');
                 const selectAll = document.getElementById('filter-select-all');
                 const checklist = filterPopup.querySelector('.filter-popup-checklist');
                 const allCheckboxes = checklist.querySelectorAll('input[type="checkbox"]');
                 
                 selectAll.onchange = () => allCheckboxes.forEach(cb => cb.checked = selectAll.checked);
                 
                 searchInput.oninput = () => {
                     const term = searchInput.value.toLowerCase();
                     checklist.querySelectorAll('label').forEach(label => {
                         label.style.display = label.textContent.toLowerCase().includes(term) ? 'flex' : 'none';
                     });
                 };
            }
        };
        
        const applyColumnFilter = (key, type) => {
            const filter = {};

            if (type === 'categorical' || type === 'boolean') {
                const checkboxes = filterPopup.querySelectorAll('.filter-popup-checklist input[type="checkbox"]:checked');
                 if (checkboxes.length > 0) {
                    filter.type = type;
                    filter.values = Array.from(checkboxes).map(cb => cb.value);
                    appState.columnFilters[key] = filter;
                 } else {
                     delete appState.columnFilters[key];
                 }
            } else if (type === 'string' || type === 'number') {
                const operator = document.getElementById('filter-operator')?.value;
                const value = document.getElementById('filter-value')?.value;
                if(operator && value) {
                    filter.type = type === 'string' ? 'text' : 'number';
                    filter.operator = operator;
                    filter.value = value;
                    appState.columnFilters[key] = filter;
                } else {
                     delete appState.columnFilters[key];
                }
            }
            
            filterPopup.classList.add('hidden');
            appState.currentPage = 1;
            filterAndRenderReviewTable();
        };
        
        const clearColumnFilter = (key) => {
            delete appState.columnFilters[key];
            filterPopup.classList.add('hidden');
            appState.currentPage = 1;
            filterAndRenderReviewTable();
        };

        const clearAllFilters = () => {
            appState.columnFilters = {};
            appState.searchTerm = '';
            filterPopup.classList.add
            // V55: Reset bulk selection state on filter clear
            appState.selectedRows.clear();
            appState.bulkSelectionScope = 'page';
            filterAndRenderReviewTable();
        };
        
        const setDarkMode = (isDark) => {
            if(isDark) {
                document.body.classList.add('dark-mode');
                themeIconSun.classList.add('hidden');
                themeIconMoon.classList.remove('hidden');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                themeIconSun.classList.remove('hidden');
                themeIconMoon.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            }
        };

        const toggleDarkMode = () => {
            setDarkMode(!document.body.classList.contains('dark-mode'));
        };

        const updateBulkActionsUI = () => {
            const hasSelection = appState.selectedRows.size > 0;
            bulkActionsContainer.classList.toggle('hidden', !hasSelection);
            if (hasSelection) {
                renderBulkActionScopeUI();
            }
        };
        const renderBulkActionScopeUI = () => {
            const scopeContainer = document.getElementById('bulk-scope-container');
            if (!scopeContainer) return;

            const totalPages = Math.ceil(appState.filteredResultsCache.length / appState.pageSize);
            const isPaginationActive = totalPages > 1;

            if (!isPaginationActive) {
                scopeContainer.innerHTML = `<span id="bulk-selection-status">${appState.selectedRows.size} of ${appState.filteredResultsCache.length} items selected.</span> <button id="clear-selection-btn">Clear selection</button>`;
                return;
            }

            let statusHTML = '';
            switch (appState.bulkSelectionScope) {
                case 'page':
                    statusHTML = `<span id="bulk-selection-status">${appState.selectedRows.size} items on this page selected.</span> <button id="clear-selection-btn">Clear selection</button>`;
                    break;
                case 'all':
                    statusHTML = `<span id="bulk-selection-status">All ${appState.filteredResultsCache.length} items across all pages are selected.</span> <button id="clear-selection-btn">Clear selection</button>`;
                    break;
                case 'custom':
                    statusHTML = `
                        <div class="custom-range-inputs">
                            <span>Pages:</span>
                            <input type="number" id="custom-range-start" value="${appState.bulkSelectionCustomRange.start}" min="1" max="${totalPages}">
                            <span>to</span>
                            <input type="number" id="custom-range-end" value="${appState.bulkSelectionCustomRange.end}" min="1" max="${totalPages}">
                            <button id="update-custom-range-btn" class="btn">Update Selection</button>
                        </div>
                    `;
                    break;
            }

            scopeContainer.innerHTML = `
                <span class="bulk-scope-label">Scope:</span>
                <div class="scope-selector">
                    <button id="scope-select-btn">
                        <span>${appState.bulkSelectionScope === 'page' ? 'On this page' : appState.bulkSelectionScope === 'all' ? 'All pages' : 'Custom range'}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg>
                    </button>
                    <div id="scope-options">
                        <div class="scope-option ${appState.bulkSelectionScope === 'page' ? 'active' : ''}" data-scope="page">On this page</div>
                        <div class="scope-option ${appState.bulkSelectionScope === 'all' ? 'active' : ''}" data-scope="all">All pages</div>
                        <div class="scope-option ${appState.bulkSelectionScope === 'custom' ? 'active' : ''}" data-scope="custom">Custom range...</div>
                    </div>
                </div>
                ${statusHTML}
            `;
        };

        const insertTickConclusion = (existingText, definition, settings) => {
            if (!definition || !definition.description) return existingText;

            let newText = settings.formatStyle === 'bullet' ? `• ${definition.description}` : definition.description;
            const separator = settings.separator === '\n\n' ? '\n\n' : `\n${settings.separator}\n`;

            if (settings.insertionPoint === 'top') {
                return newText + (existingText ? separator + existingText : '');
            } else {
                return (existingText ? existingText + separator : '') + newText;
            }
        };

        const updateConclusionText = (currentText, newDef, oldDef) => {
            let updatedText = currentText || '';
            const allDefinitions = appState.appConfiguration.tickMarkDefinitions;

            const oldDefinition = oldDef ? allDefinitions.find(d => d.symbol === oldDef) : null;
            const newDefinition = newDef ? allDefinitions.find(d => d.symbol === newDef) : null;

            if (oldDefinition && oldDefinition.description) {
                const oldText = oldDefinition.settings.formatStyle === 'bullet' ? `• ${oldDefinition.description}` : oldDefinition.description;
                const separator = oldDefinition.settings.separator === '\n\n' ? '\n\n' : `\n${oldDefinition.settings.separator}\n`;
                
                const escapedOldText = oldText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const escapedSeparator = separator.replace(/\n/g, '\\s*\\n\\s*');
                const regexString = `(?:^|${escapedSeparator})${escapedOldText}(?:$|${escapedSeparator})`;
                const regex = new RegExp(regexString, 'g');
                
                updatedText = updatedText.replace(regex, (match) => {
                    if (match.startsWith('\n') && match.endsWith('\n')) return '\n';
                    return '';
                }).trim();
            }

            if (newDefinition && newDefinition.description) {
                if (!updatedText.includes(newDefinition.description)) {
                    updatedText = insertTickConclusion(updatedText, newDefinition, newDefinition.settings);
                }
            }
            
            return updatedText;
        };

        const applyBulkAction = async () => {
            const action = bulkActionSelect.value;
            if (!action || appState.selectedRows.size === 0) return;

            const dataKey = getEngagementDataKey(appState.currentEngagement.id);
            const data = await getFromStorage(dataKey);

            let codesToUpdate = new Set();
            switch (appState.bulkSelectionScope) {
                case 'page':
                    codesToUpdate = appState.selectedRows;
                    break;
                case 'all':
                    appState.filteredResultsCache.forEach(item => codesToUpdate.add(item.code));
                    break;
                case 'custom':
                    const { start, end } = appState.bulkSelectionCustomRange;
                    const startIndex = (start - 1) * appState.pageSize;
                    const endIndex = end * appState.pageSize;
                    appState.filteredResultsCache.slice(startIndex, endIndex).forEach(item => codesToUpdate.add(item.code));
                    break;
            }

            if (codesToUpdate.size === 0) {
                alert("No items selected for the action.");
                return;
            }

            data.matchingResults.forEach(item => {
                if (codesToUpdate.has(item.code)) {
                    if (action === 'markReviewed') item.reviewStatus = true;
                    else if (action === 'clearReviewed') item.reviewStatus = false;
                    else if (action === 'clearTicksAndComments') {
                        item.tickMark = '';
                        item.auditorComment = '';
                    }
                    else if (action.startsWith('tick_')) {
                        const newTickSymbol = action.substring(5);
                        const oldTickSymbol = item.tickMark;

                        if (newTickSymbol !== oldTickSymbol) {
                            item.auditorComment = updateConclusionText(item.auditorComment, newTickSymbol, oldTickSymbol);
                            item.tickMark = newTickSymbol;
                        }
                    }
                }
            });
            
            await saveAndNotify(dataKey, data);
            appState.selectedRows.clear();
            appState.bulkSelectionScope = 'page';
            updateBulkActionsUI();
            await filterAndRenderReviewTable();
            bulkActionSelect.value = '';
        };

        const openMappingModal = async () => {
            const data = await getFromStorage(getEngagementDataKey(appState.currentEngagement.id));
            if (!data || !data.matchingResults) {
                alert("Please run auto-matching before trying to map accounts.");
                return;
            }

            const unmatchedCY = data.matchingResults.filter(item => item.status === 'New Account');
            const unmatchedPY = data.matchingResults.filter(item => item.status === 'Prior Year Only');

            unmatchedCYList.innerHTML = unmatchedCY.map(item => `<li class="mapping-item" data-code="${item.code}">${item.name} (${item.code})</li>`).join('');
            unmatchedPYList.innerHTML = unmatchedPY.map(item => `<li class="mapping-item" data-code="${item.code}">${item.name} (${item.code})</li>`).join('');

            appState.manualMapping = { cy: null, py: null };
            saveMappingBtn.disabled = true;
            mappingModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
        };

        const closeMappingModal = () => {
            mappingModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
        };
        
        const handleMappingSelection = (e) => {
            const item = e.target.closest('.mapping-item');
            if (!item) return;

            const list = item.parentElement;
            const code = item.dataset.code;

            list.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');

            if (list.id === 'unmatched-cy-list') appState.manualMapping.cy = code;
            else if (list.id === 'unmatched-py-list') appState.manualMapping.py = code;
            
            saveMappingBtn.disabled = !(appState.manualMapping.cy && appState.manualMapping.py);
        };
        const saveManualMapping = async () => {
            const { cy, py } = appState.manualMapping;
            if (!cy || !py) return;

            const dataKey = getEngagementDataKey(appState.currentEngagement.id);
            const data = await getFromStorage(dataKey);
            if (!data.manualMappings) data.manualMappings = [];
            
            if (!data.manualMappings.some(m => m[0] === cy && m[1] === py)) {
                data.manualMappings.push([cy, py]);
            }
            
            await saveAndNotify(dataKey, data);
            closeMappingModal();
            alert("Mapping saved. Please re-run Auto-Match to apply your changes.");
        };
        
        // --- Custom Scrollbar ---
        const onThumbMouseDown = (e) => {
            e.preventDefault();
            const tableWrapper = reviewTableContainer.querySelector('.table-wrapper');
            if (!tableWrapper) return;
            
            appState.isDraggingScrollbar = true;
            appState.scrollDragStartX = e.clientX;
            appState.scrollDragStartScrollLeft = tableWrapper.scrollLeft;

            document.addEventListener('mousemove', onThumbMouseMove);
            document.addEventListener('mouseup', onThumbMouseUp);
            document.body.classList.add('is-dragging');
        };

        const onThumbMouseMove = (e) => {
            if (!appState.isDraggingScrollbar) return;
            e.preventDefault();
            
            const tableWrapper = reviewTableContainer.querySelector('.table-wrapper');
            const scrollbarContainer = document.getElementById('fixed-horizontal-scrollbar-container');
            if (!tableWrapper || !scrollbarContainer) return;

            const dx = e.clientX - appState.scrollDragStartX;
            const scrollRatio = tableWrapper.scrollWidth / tableWrapper.clientWidth;
            
            tableWrapper.scrollLeft = appState.scrollDragStartScrollLeft + (dx * scrollRatio);
        };

        const onThumbMouseUp = (e) => {
            appState.isDraggingScrollbar = false;
            document.removeEventListener('mousemove', onThumbMouseMove);
            document.removeEventListener('mouseup', onThumbMouseUp);
            document.body.classList.remove('is-dragging');
        };

        const updateThumbPosition = () => {
            requestAnimationFrame(() => {
                const tableWrapper = reviewTableContainer.querySelector('.table-wrapper');
                const scrollbarContainer = document.getElementById('fixed-horizontal-scrollbar-container');
                const thumb = document.getElementById('custom-scroll-thumb');
                if (!tableWrapper || !scrollbarContainer || !thumb) return;
    
                const scrollPercentage = tableWrapper.scrollLeft / (tableWrapper.scrollWidth - tableWrapper.clientWidth);
                const trackWidth = scrollbarContainer.clientWidth;
                const thumbWidth = thumb.clientWidth;
                const newLeft = scrollPercentage * (trackWidth - thumbWidth);
    
                thumb.style.left = `${newLeft}px`;
            });
        };
        
        const createFixedScrollbar = () => {
            if (document.getElementById('fixed-horizontal-scrollbar-container')) return;

            const scrollbarContainer = document.createElement('div');
            scrollbarContainer.id = 'fixed-horizontal-scrollbar-container';
            
            const thumb = document.createElement('div');
            thumb.id = 'custom-scroll-thumb';
            scrollbarContainer.appendChild(thumb);
            
            document.body.appendChild(scrollbarContainer);
            
            const tableWrapper = reviewTableContainer.querySelector('.table-wrapper');
            const table = tableWrapper ? tableWrapper.querySelector('table') : null;

            if (table) {
                thumb.addEventListener('mousedown', onThumbMouseDown);
                tableWrapper.addEventListener('scroll', updateThumbPosition);
                
                appState.tableResizeObserver = new ResizeObserver(() => {
                    updateFixedScrollbar();
                });
                appState.tableResizeObserver.observe(table);
            }
            updateFixedScrollbar();
        };

        const destroyFixedScrollbar = () => {
            if (appState.tableResizeObserver) {
                appState.tableResizeObserver.disconnect();
                appState.tableResizeObserver = null;
            }
            const scrollbar = document.getElementById('fixed-horizontal-scrollbar-container');
            if (scrollbar) {
                scrollbar.remove();
            }
        };
        
        const updateFixedScrollbar = () => {
            requestAnimationFrame(() => {
                const tableWrapper = reviewTableContainer.querySelector('.table-wrapper');
                const scrollbarContainer = document.getElementById('fixed-horizontal-scrollbar-container');
                const thumb = document.getElementById('custom-scroll-thumb');
                if (!tableWrapper || !scrollbarContainer || !thumb) return;
    
                const visibleRatio = tableWrapper.clientWidth / tableWrapper.scrollWidth;
                const thumbWidth = Math.max(20, visibleRatio * scrollbarContainer.clientWidth);
    
                thumb.style.width = `${thumbWidth}px`;
                updateThumbPosition();
            });
        };
        
        // --- V47 & V59: Robust TB Parser Logic ---
        const columnSynonyms = {
            code: ['code', 'acc code', 'account code', 'ac code', 'gl code', 'a/c number', 'account no'],
            name: ['name', 'account name', 'desc', 'description', 'particulars', 'ledger account'],
            finalBalance: ['balance', 'amount', 'value', 'closing balance', 'opening balance', 'net balance', 'final balance', 'final closing balance', 'net'],
            debit: ['debit', 'dr'],
            credit: ['credit', 'cr'],
            adjustment: ['adjustment', 'adjustments']
        };

        const requiredAppFields = [
            { key: 'name', label: 'Account Name', required: true },
            { key: 'finalBalance', label: 'Final/Closing Balance', required: false, tooltip: "Select the column with the final balance, whether it's named 'Balance', 'Net', 'Final', etc." },
            { key: 'code', label: 'Account Code', required: false },
            { key: 'debit', label: 'Debit', required: false },
            { key: 'credit', label: 'Credit', required: false },
            { key: 'adjustment', label: 'Adjustment', required: false },
        ];
        
        const handleFile = async (file) => {
            if (!file) return;
            const validExtensions = ['.csv', '.xlsx', '.xls'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            if (!validExtensions.includes(fileExt)) {
                alert('Unsupported file type. Please upload a CSV or Excel file.');
                return;
            }

            processingBarText.textContent = `Preparing ${file.name}...`;
            processingBarContent.classList.remove('hidden');
            cancelProcessingBtn.classList.add('hidden');
            processingBar.classList.remove('hidden');

            // --- V59: Instantiate and use the Parser Worker ---
            parserWorker = createParserWorker();
            parserWorker.postMessage({ file });

            parserWorker.onmessage = (e) => {
                const { type, payload } = e.data;

                if (type === 'progress') {
                    processingBarText.textContent = `${payload.message} (${payload.percentage}%)`;
                } else if (type === 'complete') {
                    appState.parserState = payload.parserState;
                    
                    if (appState.parserState.workbook.SheetNames.length > 1) {
                        showSheetSelectionStep();
                    } else {
                        appState.parserState.selectedSheetName = appState.parserState.workbook.SheetNames[0];
                        processSelectedSheet();
                    }
                    if (parserWorker) parserWorker.terminate();
                } else if (type === 'error') {
                    handleCriticalError(new Error(payload.message), `File parsing failed in worker for ${file.name}.`);
                    processingBar.classList.add('hidden');
                    if (parserWorker) parserWorker.terminate();
                }
            };

            parserWorker.onerror = (e) => {
                handleCriticalError(e, `A critical error occurred in the parser worker for ${file.name}.`);
                processingBar.classList.add('hidden');
                if (parserWorker) parserWorker.terminate();
            };

            fileInput.value = ''; // Reset file input
        };

        const showSheetSelectionStep = () => {
            appState.parserState.currentStep = 0; 
            const { workbook } = appState.parserState;
            parserSheetSelector.innerHTML = workbook.SheetNames.map((name, index) => `
                <label>
                    <input type="radio" name="sheet-select" value="${name}" ${index === 0 ? 'checked' : ''}>
                    ${name}
                </label>
            `).join('');

            parserWizardTitle.textContent = `Select Sheet: ${appState.parserState.fileName}`;
            parserStep0.classList.remove('hidden');
            parserStep1.classList.add('hidden');
            parserStep2.classList.add('hidden');
            parserWizardBackBtn.classList.add('hidden');
            parserWizardNextBtn.textContent = 'Next: Map Columns';
            parserWizardNextBtn.classList.remove('hidden');
            parserWizardConfirmBtn.classList.add('hidden');
            parserWizardModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
            processingBar.classList.add('hidden');
        };
        
        const processSelectedSheet = () => {
            const { workbook, selectedSheetName } = appState.parserState;
            const worksheet = workbook.Sheets[selectedSheetName];
            if (worksheet['!merges']) {
                worksheet['!merges'].forEach(merge => {
                    const { s, e } = merge;
                    for (let R = s.r; R <= e.r; ++R) {
                        for (let C = s.c; C <= e.c; ++C) {
                            worksheet[XLSX.utils.encode_cell({c:C, r:R})] = worksheet[XLSX.utils.encode_cell(s)];
                        }
                    }
                });
            }
            appState.parserState.rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
            showColumnMappingStep();
        };
        
        const showColumnMappingStep = () => {
            appState.parserState.currentStep = 1; 
            const { rawData } = appState.parserState;
            const noiseKeywords = ['printed on', 'end of report', 'tally solutions', 'page '];
            const sanitizedData = rawData.map(row => row.map(cell => String(cell).trim())).filter(row => row.join('').trim() !== '' && !noiseKeywords.some(kw => row.join(' ').toLowerCase().includes(kw)));
            
            let bestHeaderIndex = -1, maxScore = 0;
            sanitizedData.slice(0, 10).forEach((row, index) => {
                let score = 0;
                row.forEach(cell => {
                    const cellLower = cell.toLowerCase();
                    if (isNaN(cell) && cell.length > 1) score++;
                    for (const key in columnSynonyms) {
                        if (columnSynonyms[key].some(syn => cellLower.includes(syn))) score += 5;
                    }
                });
                if (score > maxScore) {
                    maxScore = score;
                    bestHeaderIndex = index;
                }
            });
            
            appState.parserState.sanitizedData = sanitizedData;
            appState.parserState.headerRowIndex = bestHeaderIndex;
            
            renderColumnMappingUI();
            
            parserWizardTitle.textContent = `Map Columns: ${appState.parserState.fileName}`;
            parserStep0.classList.add('hidden');
            parserStep1.classList.remove('hidden');
            parserStep2.classList.add('hidden');
            parserWizardBackBtn.textContent = appState.parserState.workbook.SheetNames.length > 1 ? 'Back to Sheets' : 'Back';
            parserWizardBackBtn.classList.remove('hidden');
            parserWizardNextBtn.textContent = 'Next: Preview Data';
            parserWizardNextBtn.classList.remove('hidden');
            parserWizardConfirmBtn.classList.add('hidden');
            parserWizardModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
            processingBar.classList.add('hidden');
        };

        const renderColumnMappingUI = () => {
            const { sanitizedData, headerRowIndex } = appState.parserState;
            const headers = headerRowIndex > -1 ? sanitizedData[headerRowIndex] : sanitizedData[0].map((_, i) => `Column ${i + 1}`);
            const firstDataRow = headerRowIndex > -1 ? sanitizedData[headerRowIndex + 1] || [] : sanitizedData[0] || [];
            
            const selectedProfileId = importProfileSelect.value;
            const profile = appState.savedProfiles.find(p => p.id == selectedProfileId);

            let autoMap = {};
            if (profile) {
                autoMap = profile.settings.columnMap || {};
                splitCombinedCheckbox.checked = profile.settings.splitCombined || false;
                useInferenceCheckbox.checked = profile.settings.useInference || false;
            } else {
                 requiredAppFields.forEach(appField => {
                    headers.forEach((header, index) => {
                        const headerLower = header.toLowerCase().trim();
                        for (const syn of columnSynonyms[appField.key]) {
                            if (headerLower.includes(syn)) {
                                if (!Object.values(autoMap).includes(index)) {
                                    autoMap[appField.key] = index; return;
                                }
                            }
                        }
                    });
                });
            }
            appState.parserState.columnMap = autoMap;
            
            let html = '';
            headers.forEach((header, index) => {
                const tooltipHtml = requiredAppFields.find(f => f.tooltip) ? `data-tooltip="${requiredAppFields.find(f => f.tooltip).tooltip}"` : '';
                html += `
                    <div class="column-mapping-item">
                        <label ${tooltipHtml}>${header}</label>
                        <p><i>Example: ${firstDataRow[index] || '(empty)'}</i></p>
                        <select data-col-index="${index}" class="column-map-select">
                            <option value="">-- Ignore this column --</option>
                            ${requiredAppFields.map(field => `<option value="${field.key}">${field.label}</option>`).join('')}
                        </select>
                    </div>`;
            });
            columnMappingContainer.innerHTML = html;
            
            columnMappingContainer.querySelectorAll('select').forEach(select => {
                 const colIndex = parseInt(select.dataset.colIndex);
                 for (const [fieldKey, mappedIndex] of Object.entries(autoMap)) {
                     if (mappedIndex === colIndex) {
                         select.value = fieldKey;
                     }
                 }
            });
        };
        
        const proceedToPreviewStep = () => {
            appState.parserState.currentStep = 2; 
            const userColumnMap = {};
            columnMappingContainer.querySelectorAll('.column-map-select').forEach(select => {
                if(select.value) userColumnMap[select.value] = parseInt(select.dataset.colIndex);
            });
            
            if (!userColumnMap.hasOwnProperty('name')) {
                alert("Validation Failed: You must map a column to 'Account Name'."); return;
            }
            if (!userColumnMap.hasOwnProperty('finalBalance') && (!userColumnMap.hasOwnProperty('debit') || !userColumnMap.hasOwnProperty('credit'))) {
                 alert("Validation Failed: You must map either 'Final/Closing Balance', or both 'Debit' and 'Credit' columns."); return;
            }
            appState.parserState.columnMap = userColumnMap;
            
            const { sanitizedData, headerRowIndex, columnMap } = appState.parserState;
            const dataArea = sanitizedData.slice(headerRowIndex + 1);
            let extractedData = [], errorCount = 0;
            
            dataArea.forEach(originalRow => {
                 const name = String(originalRow[columnMap.name] || '').trim();
                 if (!name) return;

                 let item = { originalRow, name, code: String(originalRow[columnMap.code] || '').trim() };
                 
                 if (splitCombinedCheckbox.checked && columnMap.hasOwnProperty('name')) {
                    const splitResult = splitCombinedAccount(item.name);
                    item.code = splitResult.code || item.code;
                    item.name = splitResult.name;
                 }
                 if (!item.code) item.code = item.name;

                let balance = 0, error = false;
                if (columnMap.hasOwnProperty('finalBalance')) {
                    const rawBalance = String(originalRow[columnMap.finalBalance] || '0').trim();
                    if (rawBalance.startsWith('(') && rawBalance.endsWith(')')) {
                        balance = -parseFloat(rawBalance.replace(/[()₹,]/g, ''));
                    } else {
                        balance = parseFloat(rawBalance.replace(/[₹,]/g, ''));
                    }
                } else {
                    const debit = parseFloat(String(originalRow[columnMap.debit] || '0').replace(/[₹,]/g, ''));
                    const credit = parseFloat(String(originalRow[columnMap.credit] || '0').replace(/[₹,]/g, ''));
                    balance = (isNaN(debit) ? 0 : debit) - (isNaN(credit) ? 0 : credit);
                }
                if (isNaN(balance)) { balance = 0; error = true; errorCount++; }
                item.balance = balance;
                
                if (useInferenceCheckbox.checked && columnMap.debit && columnMap.credit) {
                    const debit = parseFloat(String(originalRow[columnMap.debit] || '0').replace(/[₹,]/g, ''));
                    const credit = parseFloat(String(originalRow[columnMap.credit] || '0').replace(/[₹,]/g, ''));
                    if (debit > credit) item.inferredNature = 'Dr';
                    else if (credit > debit) item.inferredNature = 'Cr';
                }

                 item._error = error;
                 extractedData.push(item);
            });

            appState.parserState.extractedData = extractedData;

            const healthReport = analyzeDataHealth(extractedData, columnMap);
            if(healthReport.hasIssues) {
                parserHealthCheckSummary.innerHTML = healthReport.summary;
                parserHealthCheckSummary.classList.remove('hidden');
            } else {
                 parserHealthCheckSummary.classList.add('hidden');
            }

            parserPreviewSummary.innerHTML = `Successfully processed <b>${extractedData.length}</b> data rows. Found <b>${errorCount}</b> rows with potential balance parsing errors (highlighted). Please review the preview below.`;
            
            const previewHeaders = `<thead><tr><th>Account Code</th><th>Account Name</th><th>Balance</th>${useInferenceCheckbox.checked ? '<th>Inferred Nature</th>' : ''}</tr></thead>`;
            const previewRows = extractedData.slice(0, 50).map(item => `
                <tr class="${item._error ? 'parsing-error' : ''}">
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.balance.toFixed(2)}</td>
                    ${useInferenceCheckbox.checked ? `<td>${item.inferredNature ? `<span class="inferred-nature-badge">${item.inferredNature}</span>` : ''}</td>` : ''}
                </tr>`).join('');
            parserPreviewTable.innerHTML = `${previewHeaders}<tbody>${previewRows}</tbody>`;
            
            parserStep0.classList.add('hidden');
            parserStep1.classList.add('hidden');
            parserStep2.classList.remove('hidden');
            parserWizardBackBtn.textContent = 'Back to Mapping';
            parserWizardBackBtn.classList.remove('hidden');
            parserWizardNextBtn.classList.add('hidden');
            parserWizardConfirmBtn.classList.remove('hidden');
        };

        const analyzeDataHealth = (data, columnMap) => {
            let report = { hasIssues: false, summary: "<b>Data Health Check:</b><ul>" };
            const codeCounts = {};
            let mixedTypeCount = 0;
            let structuralAnomalies = 0;
            const headerLength = Object.keys(columnMap).length;

            data.forEach(item => {
                codeCounts[item.code] = (codeCounts[item.code] || 0) + 1;
                
                if (item._error) {
                    mixedTypeCount++;
                }
                if(item.originalRow.length > headerLength + 2 || item.originalRow.length < headerLength - 1) {
                    structuralAnomalies++;
                }
            });

            const duplicates = Object.entries(codeCounts).filter(([_, count]) => count > 1);
            if (duplicates.length > 0) {
                report.hasIssues = true;
                report.summary += `<li><b>${duplicates.length} duplicate account code(s) found.</b> These will be merged by summing their balances. (e.g., ${duplicates[0][0]})</li>`;
            }

            if (mixedTypeCount > 0) {
                report.hasIssues = true;
                report.summary += `<li><b>${mixedTypeCount} row(s) with non-numeric data</b> were found in a balance, debit, or credit column. Their balance has been set to 0.</li>`;
            }

            if (structuralAnomalies > 0) {
                report.hasIssues = true;
                report.summary += `<li><b>${structuralAnomalies} row(s) have an unusual number of columns,</b> which might indicate data corruption or report footers.</li>`;
            }

            const subtotalKeywords = ['total', 'assets', 'liabilities', 'equity', 'income', 'expenses'];
            const potentialSubtotals = data.filter(item => subtotalKeywords.some(kw => item.name.toLowerCase().includes(kw)));
            if (potentialSubtotals.length > 0) {
                report.hasIssues = true;
                report.summary += `<li><b>${potentialSubtotals.length} potential subtotal row(s) detected.</b> Please ensure these are not actual accounts.</li>`;
            }

            report.summary += "</ul>";
            return report;
        };

        const splitCombinedAccount = (value) => {
            const match = value.match(/^([a-zA-Z0-9\-\s]+?)\s*-\s*(.+)$/);
            if (match) return { code: match[1].trim(), name: match[2].trim() };
            return { code: null, name: value };
        };

        const intelligentBalanceInference = (tbData) => {
            return tbData.map(row => {
                const debit = parseFloat(row.debit) || 0;
                const credit = parseFloat(row.credit) || 0;
                const adjustment = parseFloat(row.adjustment) || 0;
                const finalBalanceRaw = parseFloat(row.balance) || 0;

                let nature = '';
                if (debit > credit) nature = 'Dr';
                else if (credit > debit) nature = 'Cr';
                else return { ...row, Final_signed_Closing_balance: finalBalanceRaw, Balance_nature: 'N/A', Inferred_by: 'No base Dr/Cr' };

                const netBaseBalance = Math.abs(debit - credit);
                const adjustedBasePlus = netBaseBalance + adjustment;
                const adjustedBaseMinus = netBaseBalance - adjustment;

                let finalSignedBalance = finalBalanceRaw;
                let inferredBy = 'Direct value from source file';

                if (Math.abs(adjustedBasePlus - finalBalanceRaw) < 0.01) {
                    finalSignedBalance = adjustedBasePlus; inferredBy = 'From debit-credit-adjustment analysis';
                } else if (Math.abs(adjustedBaseMinus - finalBalanceRaw) < 0.01) {
                    finalSignedBalance = adjustedBaseMinus; inferredBy = 'From debit-credit-adjustment analysis';
                } else if (adjustment !== 0) {
                     inferredBy = 'Potential data error; adjustment logic did not reconcile';
                }

                finalSignedBalance = (nature === 'Cr') ? -Math.abs(finalSignedBalance) : Math.abs(finalSignedBalance);
                const yearType = document.querySelector('#upload-content input[name="upload-year-type"]:checked').value;
                const inferenceKey = yearType === 'current' ? 'Inferred_by_CY' : 'Inferred_by_PY';

                return { ...row, Final_signed_Closing_balance: finalSignedBalance, Balance_nature: nature, [inferenceKey]: inferredBy };
            });
        };
        
        const openTickMarkManager = () => {
            renderTickManager();
            tickManagerSidebar.classList.add('visible');
            tickManagerOverlay.classList.add('visible');
            document.body.classList.add('sidebar-open');
        };

        const closeTickMarkManager = () => {
            tickManagerSidebar.classList.remove('visible');
            tickManagerOverlay.classList.remove('visible');
            document.body.classList.remove('sidebar-open');
            resetTickManagerForm();
        };

        const renderTickManager = () => {
            const { tickMarkDefinitions } = appState.appConfiguration;
            
            tickManagerListContainer.innerHTML = tickMarkDefinitions.map(def => `
                <div class="tick-definition-item" data-id="${def.id}" draggable="true">
                    <span class="symbol">${def.symbol}</span>
                    <p class="desc">${def.description}</p>
                    <div class="actions">
                        <button class="btn btn-minimal btn-edit" data-tooltip="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                        <button class="btn btn-minimal btn-delete" data-tooltip="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                    </div>
                </div>
            `).join('');
        };
        
        const resetTickManagerForm = () => {
            tickManagerForm.reset();
            tickManagerEditId.value = '';
            tickManagerSaveBtn.textContent = 'Add New Tick Mark';
            tickManagerSidebar.classList.remove('sidebar-in-edit-mode');
        };

        const handleTickManagerFormSubmit = async (e) => {
            e.preventDefault();
            const symbol = tickManagerSymbolInput.value.trim();
            const description = tickManagerDescInput.value.trim();
            const editId = tickManagerEditId.value ? parseInt(tickManagerEditId.value) : null;
            if (!symbol || !description) { alert('Symbol and description cannot be empty.'); return; }
            
            const newSettings = {
                insertionPoint: tickInsertionPointGroup.querySelector('input:checked').value,
                formatStyle: tickFormatStyleGroup.querySelector('input:checked').value,
                separator: tickSeparatorSelect.value
            };

            const config = appState.appConfiguration;

            if (editId) {
                const tickToEdit = config.tickMarkDefinitions.find(t => t.id === editId);
                if (tickToEdit) {
                    tickToEdit.symbol = symbol;
                    tickToEdit.description = description;
                    tickToEdit.settings = newSettings;
                }
            } else {
                config.tickMarkDefinitions.push({
                    id: Date.now(), symbol: symbol, description: description, settings: newSettings
                });
            }

            await saveAndNotify('app_configuration', config);
            renderTickManager();
            resetTickManagerForm();
            if(appState.activeTab === 'review') filterAndRenderReviewTable();
        };

        const handleTickManagerListClick = async (e) => {
            const config = appState.appConfiguration;
            
            const editBtn = e.target.closest('.btn-edit');
            if(editBtn) {
                const itemEl = editBtn.closest('.tick-definition-item');
                const id = parseInt(itemEl.dataset.id);
                const tickToEdit = config.tickMarkDefinitions.find(t => t.id === id);
                if(tickToEdit) {
                    tickManagerEditId.value = tickToEdit.id;
                    tickManagerSymbolInput.value = tickToEdit.symbol;
                    tickManagerDescInput.value = tickToEdit.description;
                    tickManagerSaveBtn.textContent = 'Update Tick Mark';

                    tickInsertionPointGroup.querySelector(`input[value="${tickToEdit.settings.insertionPoint}"]`).checked = true;
                    tickFormatStyleGroup.querySelector(`input[value="${tickToEdit.settings.formatStyle}"]`).checked = true;
                    tickSeparatorSelect.value = tickToEdit.settings.separator;
                    tickManagerSidebar.classList.add('sidebar-in-edit-mode');
                    tickManagerSymbolInput.focus();
                }
            }

            const deleteBtn = e.target.closest('.btn-delete');
            if(deleteBtn) {
                 if (confirm('Are you sure you want to delete this tick mark? This cannot be undone.')) {
                    const itemEl = deleteBtn.closest('.tick-definition-item');
                    const id = parseInt(itemEl.dataset.id);
                    config.tickMarkDefinitions = config.tickMarkDefinitions.filter(t => t.id !== id);
                    await saveAndNotify('app_configuration', config);
                    renderTickManager();
                    if(appState.activeTab === 'review') filterAndRenderReviewTable();
                }
            }
        };
        
       // --- SYMBOL PICKER ENHANCEMENT ---
        const symbolCategories = {
            'Recently Used': {
                icon: '🕐',
                symbols: [] // This will be dynamically populated
            },
            'Common Audit': {
                icon: '🔣',
                symbols: ['✓', '✗', '○', 'ADJ']
            },
            'Arrows & Pointers': {
                icon: '→',
                symbols: ['→', '←', '↑', '↓', '↔', '↩️', '↪️', '➡️', '⬅️', '🎯']
            },
            'Objects': {
                icon: '💼',
                symbols: ['💼', '💻', '📞', '📎', '📌', '📑', '⚙️', '📊', '📈', '📉']
            },
            'Mathematical & Shapes': {
                icon: 'Σ',
                symbols: ['Σ', 'Δ', '+', '-', '≠', '●', '■', '▲', '◆', '/', '*']
            },
            'Smileys & People': {
                icon: '😊',
                symbols: ['😀', '😂', '👍', '👎', '🧑‍💼', '🤔', '🧐', '✍️', '🤝', '🙏']
            },
            'Currency': {
                icon: '₹',
                symbols: ['₹', '$', '€', '£', '¥']
            }
        };


        const updateRecentlyUsedSymbols = (symbol) => {
            let recent = appState.recentlyUsedSymbols;
            recent = recent.filter(s => s !== symbol); // Remove existing instance
            recent.unshift(symbol); // Add to the front
            if (recent.length > 15) recent.pop(); // Keep list to a reasonable size
            appState.recentlyUsedSymbols = recent;
            localStorage.setItem('recentlyUsedSymbols', JSON.stringify(recent));
        };

        const openSymbolPicker = () => {
            const contentEl = document.getElementById('symbol-picker-content');
            const footerEl = document.getElementById('symbol-picker-footer');
            const searchInput = document.getElementById('symbol-picker-search');
            
            searchInput.value = '';
            
            const renderContent = (searchTerm = '') => {
                let html = '';
                const term = searchTerm.toLowerCase();
                
                symbolCategories['Recently Used'].symbols = appState.recentlyUsedSymbols;

                for (const categoryName in symbolCategories) {
                    const category = symbolCategories[categoryName];
                    const filteredSymbols = category.symbols.filter(s => 
                        s.toLowerCase().includes(term) || categoryName.toLowerCase().includes(term)
                    );

                    if (filteredSymbols.length > 0) {
                        html += `<div class="symbol-picker-category" data-category="${categoryName}">
                                    <h3 class="symbol-picker-category-title">${categoryName}</h3>
                                    <div class="symbol-picker-grid">
                                        ${filteredSymbols.map(s => `<div class="symbol-picker-item" data-symbol="${s}">${s}</div>`).join('')}
                                    </div>
                                 </div>`;
                    }
                }
                contentEl.innerHTML = html || '<p style="text-align:center; color: var(--text-light); padding: 1rem;">No symbols found.</p>';
            };

            let footerHtml = '';
            for (const categoryName in symbolCategories) {
                 footerHtml += `<button class="symbol-picker-tab" data-category-target="${categoryName}" data-tooltip="${categoryName}">${symbolCategories[categoryName].icon}</button>`;
            }
            footerEl.innerHTML = footerHtml;

            renderContent();
            footerEl.querySelector('.symbol-picker-tab')?.classList.add('active');

            const rect = symbolPickerBtn.getBoundingClientRect();
            const popup = symbolPickerPopup;
            popup.classList.remove('hidden');
            const popupRect = popup.getBoundingClientRect();

            let top = rect.bottom + 8;
            let left = rect.left;

            if (top + popupRect.height > window.innerHeight) { top = rect.top - popupRect.height - 8; }
            if (left + popupRect.width > window.innerWidth) { left = window.innerWidth - popupRect.width - 8; }
            if (left < 0) { left = 8; }

            popup.style.top = `${top}px`;
            popup.style.left = `${left}px`;
        };
        
        // --- V58: New UI Feedback and Error Handling Functions ---
        const showErrorModal = (userMessage, errorDetails) => {
            document.getElementById('error-modal-message').textContent = userMessage;
            document.getElementById('error-details-textarea').value = errorDetails;
            errorModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
        };

        const handleCriticalError = (error, contextMessage) => {
            console.error(contextMessage, error);
            const errorDetails = `Context: ${contextMessage}\nError: ${error.message}\n\nStack Trace:\n${error.stack}`;
            showErrorModal(`An unexpected error occurred. Please copy the details and report this issue.`, errorDetails);
        };

        const updateSaveStatus = () => {
            if (appState.saveIndicatorTimeout) clearTimeout(appState.saveIndicatorTimeout);
            
            const now = new Date();
            lastSavedTimestamp.textContent = `Last saved: ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;
            
            saveStatusIndicator.classList.add('visible', 'success');
            
            appState.saveIndicatorTimeout = setTimeout(() => {
                saveStatusIndicator.classList.remove('visible');
            }, 2500);
        };
        
        const checkForSessionRecovery = async () => {
            const wasInProgress = await getFromStorage('session_in_progress');
            if (wasInProgress) {
                const lastEngagement = await getFromStorage('currentEngagement');
                if (lastEngagement) {
                    const message = document.getElementById('session-recovery-message');
                    message.textContent = `It looks like your last session for engagement "${lastEngagement.clientName} (${lastEngagement.engagementYear})" ended unexpectedly. Would you like to restore your work?`;
                    sessionRecoveryModal.classList.remove('hidden');
                    document.body.classList.add('modal-open');
                } else {
                    await saveAndNotify('session_in_progress', false); // Clean up inconsistent state
                }
            }
        };


        // --- Event Listeners ---
        const setupEventListeners = () => {
            engagementForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const clientName = clientNameInput.value.trim();
                const yearValue = engagementYearInput.value.trim();
                if (clientName === '' || yearValue === '') { alert('Please fill in all engagement details.'); return; }
                createButton.disabled = true;
                createButton.querySelector('span').textContent = 'Creating...';
                
                const yearType = document.querySelector('input[name="year-type"]:checked').value;
                const newEngagement = { 
                    id: Date.now(), clientName, engagementYear: yearValue, yearType
                };

                await saveEngagement(newEngagement);
                await saveAndNotify(getEngagementDataKey(newEngagement.id), createDefaultEngagementData());
                await showAppWorkspace(newEngagement);
                createButton.disabled = false;
                createButton.querySelector('span').textContent = 'Create Engagement';
                engagementForm.reset();
                engagementYearInput.value = new Date().getFullYear();
            });

            navTabsContainer.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.nav-tab');
                if (tabButton && !tabButton.classList.contains('active')) setActiveTab(tabButton.dataset.tab);
            });

            backToEngagementsBtn.addEventListener('click', showCreationView);
            createTestDataBtn.addEventListener('click', () => { if (appState.currentEngagement) generateTestData(appState.currentEngagement.id); });
            document.getElementById('refresh-dashboard-btn').addEventListener('click', () => { if(appState.currentEngagement) updateDashboard(appState.currentEngagement.id); });

            autoMatchBtn.addEventListener('click', () => { if (appState.currentEngagement) runAutoMatching(appState.currentEngagement.id); });
            cancelProcessingBtn.addEventListener('click', () => {
                if (matcherWorker) {
                    matcherWorker.terminate();
                    appState.isMatchingInProgress = false;
                    navTabsContainer.querySelectorAll('.nav-tab').forEach(t => t.disabled = false);
                    updateMatchingTabUI(appState.currentEngagement.id);
                    processingBar.classList.add('hidden');
                    cancelProcessingBtn.classList.add('hidden');
                    alert("Matching process cancelled.");
                }
            });
            
            reviewTableContainer.addEventListener('change', async (e) => {
                const target = e.target;
                const row = target.closest('tr');
                if (!row) return;

                const code = row.dataset.code;
                const dataKey = getEngagementDataKey(appState.currentEngagement.id);
                const data = await getFromStorage(dataKey);
                if (!code || !data) return;
                
                const item = data.matchingResults.find(r => r.code === code);
                if (!item) return;
                
                let dataChanged = false;

                if (target.matches('input[type="checkbox"][data-field="reviewStatus"]')) {
                    item.reviewStatus = target.checked;
                    dataChanged = true;
                    await updateDashboard(appState.currentEngagement.id); 
                }
                
                if (target.matches('select[data-field="tickMark"]')) {
                    const newTickSymbol = target.value;
                    const oldTickSymbol = item.tickMark;
                    if (newTickSymbol !== oldTickSymbol) {
                        const newCommentText = updateConclusionText(item.auditorComment, newTickSymbol, oldTickSymbol);
                        item.auditorComment = newCommentText;
                        item.tickMark = newTickSymbol;
                        
                        const commentTextarea = row.querySelector('textarea[data-field="auditorComment"]');
                        if (commentTextarea) commentTextarea.value = newCommentText;
                        
                        dataChanged = true;
                    }
                }

                if (dataChanged) await saveAndNotify(dataKey, data);
            });

            reviewTableContainer.addEventListener('input', async (e) => {
                if (e.target.matches('textarea[data-field="auditorComment"]')) {
                    const code = e.target.dataset.code;
                    const value = e.target.value;
                    const dataKey = getEngagementDataKey(appState.currentEngagement.id);
                    const data = await getFromStorage(dataKey);
                    const item = data.matchingResults.find(r => r.code === code);
                    if (item) {
                        item.auditorComment = value;
                        await saveAndNotify(dataKey, data);
                    }
                }
            });

            
            generatePdfBtn.addEventListener('click', async () => {
                if (appState.currentEngagement) {
                    processingBarText.textContent = "Generating PDF Report...";
                    processingBarContent.classList.remove('hidden');
                    cancelProcessingBtn.classList.add('hidden');
                    processingBar.classList.remove('hidden');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    try {
                        await generateWorkingPaperPDF(appState.currentEngagement.id);
                    } catch(e) { handleCriticalError(e, "PDF Generation Failed"); } 
                    finally { processingBar.classList.add('hidden'); }
                }
            });

            generateExcelBtn.addEventListener('click', async () => {
                if (appState.currentEngagement) {
                    processingBarText.textContent = "Generating Excel Report...";
                    processingBarContent.classList.remove('hidden');
                    cancelProcessingBtn.classList.add('hidden');
                    processingBar.classList.remove('hidden');
                    reportOptionsDropdown.parentElement.classList.remove('open');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    try {
                        await generateWorkingPaperExcel(appState.currentEngagement.id);
                    } catch(e) { handleCriticalError(e, "Excel Generation Failed"); } 
                    finally { processingBar.classList.add('hidden'); }
                }
            });

            reportOptionsBtn.addEventListener('click', (e) => { e.stopPropagation(); reportOptionsDropdown.parentElement.classList.toggle('open'); });
            browseFilesBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
            uploadDropzone.addEventListener('dragover', (e) => { e.preventDefault(); uploadDropzone.classList.add('dragover'); });
            uploadDropzone.addEventListener('dragleave', () => uploadDropzone.classList.remove('dragover'));
            uploadDropzone.addEventListener('drop', (e) => { e.preventDefault(); uploadDropzone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
            uploadDropzone.addEventListener('click', (e) => { if(e.target.id === 'upload-dropzone' || e.target.closest('#upload-dropzone')) fileInput.click(); });

            document.body.addEventListener('mouseover', (e) => {
                const icon = e.target.closest('[data-tooltip]');
                if (icon) {
                    tooltip.textContent = icon.dataset.tooltip;
                    
                    const rect = icon.getBoundingClientRect();
                    const tooltipRect = tooltip.getBoundingClientRect();
                    const margin = 8;

                    let top = rect.top - tooltip.offsetHeight - margin;
                    let left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2);

                    if (top < margin) {
                        top = rect.bottom + margin;
                    }

                    if (left < margin) {
                        left = margin;
                    }

                    if (left + tooltip.offsetWidth > window.innerWidth - margin) {
                        left = window.innerWidth - tooltip.offsetWidth - margin;
                    }
                    
                    tooltip.style.top = `${top}px`;
                    tooltip.style.left = `${left}px`;
                    
                    tooltip.classList.add('visible');
                }
            });
            document.body.addEventListener('mouseout', (e) => { if (e.target.closest('[data-tooltip]')) tooltip.classList.remove('visible'); });
            
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.altKey && e.key.toLowerCase() === 'f') {
                    e.preventDefault(); if (appState.activeTab === 'review') toggleFilterUI();
                }
                if (e.key === "Escape") {
                    filterPopup.classList.add('hidden'); closeMappingModal();
                    parserWizardModal.classList.add('hidden'); closeTickMarkManager();
                    symbolPickerPopup.classList.add('hidden'); reportOptionsDropdown.parentElement.classList.remove('open');
                    profileManagerModal.classList.add('hidden'); document.body.classList.remove('modal-open');
                    privacyModal.classList.add('hidden'); errorModal.classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!filterPopup.classList.contains('hidden') && !filterPopup.contains(e.target) && !e.target.closest('.th-icon-btn')) filterPopup.classList.add('hidden');
                if (!symbolPickerPopup.classList.contains('hidden') && !symbolPickerPopup.contains(e.target) && !e.target.closest('#tick-manager-symbol-picker-btn')) {
                    symbolPickerPopup.classList.add('hidden');
                }
                if (!reportOptionsBtn.contains(e.target) && !reportOptionsDropdown.contains(e.target)) reportOptionsDropdown.parentElement.classList.remove('open');
                const scopeSelector = document.querySelector('.scope-selector');
                if (scopeSelector && !scopeSelector.contains(e.target)) {
                    scopeSelector.classList.remove('open');
                }
            });
            
            themeToggle.addEventListener('click', toggleDarkMode);

            yearTypeRadios.addEventListener('change', (e) => {
                const yearType = e.target.value;
                engagementYearLabel.textContent = (yearType === 'Financial') ? 'Financial Year' : 'Engagement Year';
                engagementYearInput.placeholder = (yearType === 'Financial') ? 'e.g., 2024-25' : 'e.g., 2024';
                engagementYearInput.type = (yearType === 'Financial') ? 'text' : 'number';
            });
            
            exportEngagementBtn.addEventListener('click', exportEngagementData);
            importEngagementBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', async (e) => {
    try {
        await handleFileImport(e);
    } catch (error) {
        handleCriticalError(error, "File Import Failed");
    }
});

            applyMaterialityCheckbox.addEventListener('change', async () => {
                const isChecked = applyMaterialityCheckbox.checked;
                materialityInputContainer.classList.toggle('hidden', !isChecked);
                const dataKey = getEngagementDataKey(appState.currentEngagement.id);
                const data = await getFromStorage(dataKey) || {};
                data.applyMateriality = isChecked;
                if (!isChecked) { data.materialityThreshold = null; materialityThresholdInput.value = ''; }
                await saveAndNotify(dataKey, data);
                if (appState.activeTab === 'review') await filterAndRenderReviewTable();
            });

            materialityThresholdInput.addEventListener('input', async () => {
                const dataKey = getEngagementDataKey(appState.currentEngagement.id);
                const data = await getFromStorage(dataKey) || {};
                const value = parseFloat(materialityThresholdInput.value);
                data.materialityThreshold = isNaN(value) ? null : value;
                await saveAndNotify(dataKey, data);
                if (appState.activeTab === 'review') await filterAndRenderReviewTable();
            });
            
            reviewSearchInput.addEventListener('input', () => {
                appState.searchTerm = reviewSearchInput.value; appState.currentPage = 1; filterAndRenderReviewTable();
            });

            dashboardGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.stat-clickable'); if (!card) return;
                const { filterType, filterValue } = card.dataset;
                appState.columnFilters = {}; appState.searchTerm = ''; appState.currentPage = 1;
                if (filterType !== 'all') {
                    const newFilter = {
                        type: filterType === 'reviewStatus' ? 'boolean' : 'categorical',
                        values: [filterValue]
                    };
                    appState.columnFilters[filterType] = newFilter;
                }
                setActiveTab('review');
                });
            
            reviewTableContainer.addEventListener('change', (e) => {
                const target = e.target;
                if (target.matches('.row-checkbox')) {
                    const code = target.closest('tr').dataset.code;
                    if (target.checked) appState.selectedRows.add(code); else appState.selectedRows.delete(code);
                    appState.bulkSelectionScope = 'page';
                    updateBulkActionsUI();
                } else if (target.matches('#select-all-checkbox')) {
                    const isChecked = target.checked;
                    reviewTableContainer.querySelectorAll('.row-checkbox').forEach(cb => {
                        cb.checked = isChecked; const code = cb.closest('tr').dataset.code;
                        if (isChecked) appState.selectedRows.add(code); else appState.selectedRows.delete(code);
                    });
                    appState.bulkSelectionScope = 'page';
                    updateBulkActionsUI();
                }
            });
            
            bulkActionApplyBtn.addEventListener('click', applyBulkAction);
            
            const saveSignOffData = async (field, value) => {
                 const dataKey = getEngagementDataKey(appState.currentEngagement.id); const data = await getFromStorage(dataKey) || {};
                data[field] = value; await saveAndNotify(dataKey, data);
            };
            auditConclusionTextarea.addEventListener('input', () => saveSignOffData('auditConclusion', auditConclusionTextarea.value));
            discussionPointsTextarea.addEventListener('input', () => saveSignOffData('discussionPoints', discussionPointsTextarea.value));
            preparedByInput.addEventListener('input', () => saveSignOffData('preparedBy', preparedByInput.value));
            preparedDateInput.addEventListener('change', () => saveSignOffData('preparedDate', preparedDateInput.value));
            reviewedByInput.addEventListener('input', () => saveSignOffData('reviewedBy', reviewedByInput.value));
            reviewedDateInput.addEventListener('change', () => saveSignOffData('reviewedDate', reviewedDateInput.value));

            recentEngagementsList.addEventListener('click', async (e) => {
                const link = e.target.closest('.engagement-link');
                if(link) {
                    e.preventDefault(); const engagementId = parseInt(link.dataset.engagementId);
                    const engagements = await getFromStorage('engagements') || [];
                    const engagement = engagements.find(e => e.id === engagementId); await showAppWorkspace(engagement);
                }
                const deleteBtn = e.target.closest('.delete-engagement-btn');
                if (deleteBtn) {
                    const engagementId = parseInt(deleteBtn.dataset.engagementId);
                    if (confirm('Are you sure you want to permanently delete this engagement? This action cannot be undone.')) {
                        let engagements = await getFromStorage('engagements') || [];
                        engagements = engagements.filter(e => e.id !== engagementId);
                        await saveAndNotify('engagements', engagements);
                        await DB.delete(getEngagementDataKey(engagementId)); await renderRecentEngagements();
                    }
                }
            });
            
            mapUnmatchedBtn.addEventListener('click', openMappingModal);
            closeMappingModalBtn.addEventListener('click', closeMappingModal);
            unmatchedCYList.addEventListener('click', handleMappingSelection);
            unmatchedPYList.addEventListener('click', handleMappingSelection);
            saveMappingBtn.addEventListener('click', saveManualMapping);
            
            parserWizardCloseBtn.addEventListener('click', () => { parserWizardModal.classList.add('hidden'); document.body.classList.remove('modal-open'); });
            parserWizardNextBtn.addEventListener('click', () => {
                const currentStep = appState.parserState.currentStep;
                if (currentStep === 0) {
                    appState.parserState.selectedSheetName = parserSheetSelector.querySelector('input:checked').value;
                    processSelectedSheet();
                } else if (currentStep === 1) {
                    proceedToPreviewStep();
                }
            });
            parserWizardBackBtn.addEventListener('click', () => {
                 const currentStep = appState.parserState.currentStep;
                if (currentStep === 2) {
                    showColumnMappingStep();
                } else if (currentStep === 1 && appState.parserState.workbook.SheetNames.length > 1) {
                    showSheetSelectionStep();
                }
            });
            parserWizardConfirmBtn.addEventListener('click', () => {
                const { extractedData } = appState.parserState;
                const finalData = extractedData.map(item => ({
                    code: item.code, name: item.name, balance: item.balance,
                    debit: item.originalRow[appState.parserState.columnMap.debit],
                    credit: item.originalRow[appState.parserState.columnMap.credit],
                    adjustment: item.originalRow[appState.parserState.columnMap.adjustment],
                }));
                const parserSettings = { useInference: useInferenceCheckbox.checked, splitCombined: splitCombinedCheckbox.checked, };
                saveNormalizedData(finalData, parserSettings);
                parserWizardModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            });
            
            tickManagerCloseBtn.addEventListener('click', closeTickMarkManager);
            tickManagerOverlay.addEventListener('click', closeTickMarkManager);
            tickManagerForm.addEventListener('submit', handleTickManagerFormSubmit);
            tickManagerListContainer.addEventListener('click', handleTickManagerListClick);
            tickManagerForm.addEventListener('reset', () => tickManagerSidebar.classList.remove('sidebar-in-edit-mode'));
            document.getElementById('tick-manager-form-container').addEventListener('click', e => {
                if(e.target.id === 'tick-manager-save-btn' && !tickManagerEditId.value){
                    const defaultConfig = createDefaultAppConfiguration().tickMarkDefinitions[0].settings;
                    tickInsertionPointGroup.querySelector(`input[value="${defaultConfig.insertionPoint}"]`).checked = true;
                    tickFormatStyleGroup.querySelector(`input[value="${defaultConfig.formatStyle}"]`).checked = true;
                    tickSeparatorSelect.value = defaultConfig.separator;
                    tickManagerSidebar.classList.add('sidebar-in-edit-mode');
                }
            });

            symbolPickerBtn.addEventListener('click', openSymbolPicker);
            symbolPickerPopup.addEventListener('click', (e) => {
                const item = e.target.closest('.symbol-picker-item');
                if (item) {
                    const symbol = item.dataset.symbol;
                    tickManagerSymbolInput.value = symbol;
                    updateRecentlyUsedSymbols(symbol);
                    symbolPickerPopup.classList.add('hidden');
                    tickManagerSymbolInput.focus();
                }
                const tab = e.target.closest('.symbol-picker-tab');
                if(tab) {
                    const targetCategory = tab.dataset.categoryTarget;
                    const contentEl = document.getElementById('symbol-picker-content');
                    const categoryEl = contentEl.querySelector(`.symbol-picker-category[data-category="${targetCategory}"]`);
                    if(categoryEl) {
                        contentEl.scrollTop = categoryEl.offsetTop - contentEl.offsetTop;
                        document.querySelectorAll('.symbol-picker-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                    }
                }
            });

            document.getElementById('symbol-picker-search').addEventListener('input', (e) => {
                const contentEl = document.getElementById('symbol-picker-content');
                const footerEl = document.getElementById('symbol-picker-footer');
                let html = '';
                const term = e.target.value.toLowerCase();
                
                symbolCategories['Recently Used'].symbols = appState.recentlyUsedSymbols;

                for (const categoryName in symbolCategories) {
                    const category = symbolCategories[categoryName];
                    const filteredSymbols = category.symbols.filter(s => 
                        s.toLowerCase().includes(term) || categoryName.toLowerCase().includes(term)
                    );

                    if (filteredSymbols.length > 0) {
                        html += `<div class="symbol-picker-category" data-category="${categoryName}">
                                    <h3 class="symbol-picker-category-title">${categoryName}</h3>
                                    <div class="symbol-picker-grid">
                                        ${filteredSymbols.map(s => `<div class="symbol-picker-item" data-symbol="${s}">${s}</div>`).join('')}
                                    </div>
                                 </div>`;
                    }
                }
                contentEl.innerHTML = html || '<p style="text-align:center; color: var(--text-light); padding: 1rem;">No symbols found.</p>';
            });

            tickManagerListContainer.addEventListener('dragstart', (e) => { appState.draggedTickItem = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); });
            tickManagerListContainer.addEventListener('dragend', (e) => { appState.draggedTickItem.classList.remove('dragging'); appState.draggedTickItem = null; });
            tickManagerListContainer.addEventListener('dragover', (e) => {
                e.preventDefault(); const target = e.target.closest('.tick-definition-item');
                if (target && target !== appState.draggedTickItem) {
                    tickManagerListContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); target.classList.add('drag-over');
                }
            });
            tickManagerListContainer.addEventListener('dragleave', (e) => { if (!tickManagerListContainer.contains(e.relatedTarget)) tickManagerListContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); });
            tickManagerListContainer.addEventListener('drop', async (e) => {
                e.preventDefault(); const targetItem = e.target.closest('.tick-definition-item');
                tickManagerListContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                
                if (targetItem && targetItem !== appState.draggedTickItem) {
                    const config = appState.appConfiguration; const definitions = config.tickMarkDefinitions;
                    const draggedId = parseInt(appState.draggedTickItem.dataset.id); const targetId = parseInt(targetItem.dataset.id);
                    const draggedIndex = definitions.findIndex(d => d.id === draggedId); const targetIndex = definitions.findIndex(d => d.id === targetId);
                    
                    if (draggedIndex > -1 && targetIndex > -1) {
                        const [draggedDefinition] = definitions.splice(draggedIndex, 1);
                        definitions.splice(definitions.findIndex(d => d.id === targetId), 0, draggedDefinition);
                        await saveAndNotify('app_configuration', config); renderTickManager(); 
                        if (appState.activeTab === 'review') filterAndRenderReviewTable();
                    }
                }
            });
            
            paginationContainer.addEventListener('click', (e) => {
                const prevBtn = e.target.closest('#prev-page-btn'); const nextBtn = e.target.closest('#next-page-btn');
                if (prevBtn && !prevBtn.disabled) { if (appState.currentPage > 1) { appState.currentPage--; filterAndRenderReviewTable(); } }
                if (nextBtn && !nextBtn.disabled) {
                    const totalPages = Math.ceil(appState.filteredResultsCache.length / appState.pageSize);
                    if (appState.currentPage < totalPages) { appState.currentPage++; filterAndRenderReviewTable(); }
                }
            });

            bulkActionsContainer.addEventListener('click', (e) => {
                const scopeBtn = e.target.closest('#scope-select-btn');
                if (scopeBtn) {
                    scopeBtn.parentElement.classList.toggle('open');
                }

                const scopeOption = e.target.closest('.scope-option');
                if (scopeOption) {
                    appState.bulkSelectionScope = scopeOption.dataset.scope;
                    scopeOption.closest('.scope-selector').classList.remove('open');
                    
                    if (appState.bulkSelectionScope === 'all') {
                        appState.selectedRows = new Set(appState.filteredResultsCache.map(item => item.code));
                    }
                    
                    renderBulkActionScopeUI();
                    filterAndRenderReviewTable();
                }

                const clearBtn = e.target.closest('#clear-selection-btn');
                if (clearBtn) {
                    appState.selectedRows.clear();
                    appState.bulkSelectionScope = 'page';
                    updateBulkActionsUI();
                    filterAndRenderReviewTable();
                }
                
                const updateRangeBtn = e.target.closest('#update-custom-range-btn');
                if (updateRangeBtn) {
                    const startInput = document.getElementById('custom-range-start');
                    const endInput = document.getElementById('custom-range-end');
                    const totalPages = Math.ceil(appState.filteredResultsCache.length / appState.pageSize);
                    
                    let start = parseInt(startInput.value);
                    let end = parseInt(endInput.value);

                    if (isNaN(start) || isNaN(end) || start < 1 || end > totalPages || start > end) {
                        alert(`Invalid page range. Please enter numbers between 1 and ${totalPages}, with the start page being less than or equal to the end page.`);
                        startInput.focus();
                        return;
                    }

                    appState.bulkSelectionCustomRange = { start, end };
                    const startIndex = (start - 1) * appState.pageSize;
                    const endIndex = end * appState.pageSize;
                    appState.selectedRows = new Set(appState.filteredResultsCache.slice(startIndex, endIndex).map(item => item.code));
                    updateBulkActionsUI();
                    filterAndRenderReviewTable();
                    alert(`${appState.selectedRows.size} items from page ${start} to ${end} have been selected.`);
                }
            });

            manageProfilesBtn.addEventListener('click', () => {
                renderProfileManager();
                profileManagerModal.classList.remove('hidden');
                document.body.classList.add('modal-open');
            });
            profileManagerCloseBtn.addEventListener('click', () => {
                profileManagerModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            });
            profileManagerListContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.profile-delete-btn');
                if (deleteBtn) {
                    const profileId = parseInt(deleteBtn.closest('.profile-item').dataset.id);
                    deleteProfile(profileId);
                }
            });
            saveProfileBtn.addEventListener('click', saveCurrentProfile);
            importProfileSelect.addEventListener('change', () => {
                if(appState.parserState.sanitizedData) {
                    renderColumnMappingUI();
                }
            });

            // V58: New Event Listeners for Modals and Session Management
            privacyShieldBtn.addEventListener('click', () => {
                privacyModal.classList.remove('hidden');
                document.body.classList.add('modal-open');
            });
            privacyModal.addEventListener('click', (e) => {
                if (e.target.id === 'privacy-modal' || e.target.closest('#privacy-modal-close-btn') || e.target.closest('#privacy-modal-ok-btn')) {
                    privacyModal.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                }
            });

            errorModal.addEventListener('click', (e) => {
                if (e.target.id === 'error-modal' || e.target.closest('#error-modal-close-btn') || e.target.closest('#error-modal-ok-btn')) {
                    errorModal.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                }
            });
            document.getElementById('error-details-toggle').addEventListener('click', (e) => {
                e.preventDefault();
                const content = document.getElementById('error-details-content');
                content.classList.toggle('hidden');
                e.target.textContent = content.classList.contains('hidden') ? 'Show Technical Details ▼' : 'Hide Technical Details ▲';
            });
            document.getElementById('error-modal-copy-btn').addEventListener('click', () => {
                const details = document.getElementById('error-details-textarea').value;
                navigator.clipboard.writeText(details).then(() => {
                    alert('Error details copied to clipboard.');
                }, () => {
                    alert('Failed to copy details.');
                });
            });
            
            document.getElementById('session-recovery-restore-btn').addEventListener('click', async () => {
                const lastEngagement = await getFromStorage('currentEngagement');
                await showAppWorkspace(lastEngagement);
                sessionRecoveryModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            });
            document.getElementById('session-recovery-discard-btn').addEventListener('click', async () => {
                await saveAndNotify('session_in_progress', false);
                await showCreationView();
                sessionRecoveryModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            });

            window.addEventListener('beforeunload', () => {
                if (appState.currentEngagement) {
                    DB.save('session_in_progress', true);
                }
            });
        };

        // --- Initialization ---
        const initializeApp = async () => {
            try {
                await DB.init();
                await migrateLocalStorageToIndexedDB();

                if (document.documentElement.classList.contains('dark-mode-preload')) {
                    setDarkMode(true); document.documentElement.classList.remove('dark-mode-preload');
                } else { setDarkMode(false); }
                
                let config = await getFromStorage('app_configuration');
                if (!config) {
                    config = createDefaultAppConfiguration();
                    await saveAndNotify('app_configuration', config);
                }
                appState.appConfiguration = config;
                await loadProfiles(); 
                
                setupEventListeners();
                
                engagementYearInput.value = new Date().getFullYear();
                
                await checkForSessionRecovery();

                const wasInProgress = await getFromStorage('session_in_progress');
                if (!wasInProgress) {
                    const lastEngagement = await getFromStorage('currentEngagement');
                    const allEngagements = await getFromStorage('engagements') || [];

                    if (lastEngagement && allEngagements.some(e => e.id === lastEngagement.id)) {
                        await showAppWorkspace(lastEngagement);
                    } else { await showCreationView(); }
                }
            } catch(error) {
                handleCriticalError(error, "A critical error occurred during application initialization.");
            }
        };

        initializeApp();
    });

</script>
</body>
</html>